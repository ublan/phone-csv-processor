<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Micro Tools</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <aside class="sidebar">
    <div class="sidebar-brand">Micro Tools</div>
    <p class="sidebar-desc">Herramientas de CSV, teléfonos y Retell AI</p>
    <nav class="sidebar-nav">
      <button type="button" class="tab-btn active" id="tabProcess">Procesar CSV</button>
      <button type="button" class="tab-btn" id="tabImport">Importar a Retell AI</button>
      <button type="button" class="tab-btn" id="tabBatchCall">Batch Calling</button>
      <button type="button" class="tab-btn" id="tabManage">Gestionar Números</button>
      <button type="button" class="tab-btn" id="tabCompare">Comparar Listas / JSON</button>
      <a href="https://url-redirect-post-ge-rwgf.bolt.host" target="_blank" rel="noopener noreferrer" class="sidebar-link">ProxyLink</a>
    </nav>
  </aside>

  <main class="main-content">
  <!-- Sección de Procesar CSV -->
  <div class="card card-large" id="processSection">
    <h2 class="section-title">Procesar CSV</h2>
    <p class="section-desc">Sube un archivo CSV para validar números, normalizar por país y obtener resumen, números generados y archivos listos para batch calling.</p>
    <div class="zone" id="zone">
      <input type="file" id="file" accept=".csv" />
      <p>Arrastra aquí un CSV o haz clic para elegir</p>
      <p class="file-name" id="fileName"></p>
    </div>
    <div class="opt">
      <input type="checkbox" id="clean" />
      <label for="clean">Incluir CSV limpio (datos_limpios.csv)</label>
    </div>
    <button class="btn" id="btn" disabled>Procesar</button>
    <div id="msg"></div>
    <div class="resumen" id="resumen" style="display:none">
      <h3>Resumen por país</h3>
      <ul id="resumenList"></ul>
      <div class="links" id="links"></div>
      <button class="btn btn-secondary" id="importBtn" style="margin-top: 1rem; display: none;">
        Importar a Retell AI
      </button>
    </div>
  </div>

  <!-- Sección de Importar a Retell AI -->
  <div class="card card-large" id="importSection" style="display: none;">
    <h2 class="section-title">Importar Números a Retell AI</h2>
    <p class="section-desc">Elige la fuente de números (CSV, manual o procesados) y configura credenciales y parámetros de Retell AI para importar.</p>

    <form id="directImportForm">
      <div class="form-block">
        <div class="form-block-title">Fuente de números</div>
        <div class="form-group">
          <label>Fuente de números *</label>
          <select id="directNumberSource" required>
            <option value="csv">Subir CSV con números</option>
            <option value="manual">Ingresar números manualmente</option>
            <option value="processed">Usar números procesados</option>
          </select>
        </div>
        <div class="form-group" id="directCsvUploadGroup">
          <label for="directCsvFile">Archivo CSV con números *</label>
          <input type="file" id="directCsvFile" accept=".csv" />
          <small style="color: var(--muted); font-size: 0.85rem; display: block; margin-top: 0.25rem;">
            Formato: una columna con números en formato internacional (+57...)
          </small>
        </div>
        <div class="form-group" id="directManualNumbersGroup" style="display: none;">
          <label for="directManualNumbers">Números telefónicos (uno por línea o separados por comas) *</label>
          <textarea id="directManualNumbers" rows="8" placeholder="5493415960906, 5492232105153, 5492616836030&#10;o uno por línea:&#10;+573146816250&#10;+34600089523" style="width: 100%; padding: 0.75rem; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-family: monospace; font-size: 0.9rem; resize: vertical;"></textarea>
          <small style="color: var(--muted); font-size: 0.85rem; display: block; margin-top: 0.25rem;">
            Puedes ingresar números separados por comas o uno por línea. El sistema agregará el "+" automáticamente si falta.
          </small>
        </div>
        <div class="form-group" id="directProcessedGroup" style="display: none;">
          <p style="color: var(--muted); font-size: 0.9rem; margin: 0;">
            Primero procesa un CSV en la pestaña "Procesar CSV" para usar esta opción.
          </p>
        </div>
      </div>

      <div class="form-block">
        <div class="form-block-title">Retell AI — Credenciales y conexión</div>
        <div class="form-group">
          <label for="directApiKey">API Key de Retell AI *</label>
          <input type="password" id="directApiKey" placeholder="Ingresa tu API Key" required />
        </div>
        <div class="form-group">
          <label for="directTerminationUri">Termination URI *</label>
          <input type="text" id="directTerminationUri" placeholder="ia.conecta-bit.com" value="ia.conecta-bit.com" required />
        </div>
        <div class="form-group">
          <label for="directOutboundTransport">Outbound Transport *</label>
          <select id="directOutboundTransport" required>
            <option value="UDP" selected>UDP</option>
            <option value="TCP">TCP</option>
            <option value="TLS">TLS</option>
          </select>
        </div>
        <div class="form-group">
          <label for="directOutboundAgentId">Outbound Agent ID *</label>
          <input type="text" id="directOutboundAgentId" placeholder="agent_5c8cb6c7ba9eeff5857d7bdf1b" value="agent_5c8cb6c7ba9eeff5857d7bdf1b" required />
        </div>
      </div>

      <div class="form-block">
        <div class="form-block-title">Opcionales — SIP y nickname</div>
        <div class="form-group">
          <label for="directSipTrunkUsername">SIP Trunk Username (opcional)</label>
          <input type="text" id="directSipTrunkUsername" placeholder="Enter SIP Trunk User Name" />
        </div>
        <div class="form-group">
          <label for="directSipTrunkPassword">SIP Trunk Password (opcional)</label>
          <input type="password" id="directSipTrunkPassword" placeholder="Enter SIP Trunk Password" />
        </div>
        <div class="form-group">
          <label for="directNickname">Nickname (opcional)</label>
          <input type="text" id="directNickname" placeholder="Ej: Brasil 1 (se numerará automáticamente: Brasil 2, Brasil 3...)" />
          <small style="color: var(--muted); font-size: 0.85rem; display: block; margin-top: 0.25rem;">
            Si ingresas un número (ej: "Brasil 5"), la numeración comenzará desde ese número. Si no ingresas número, comenzará desde 1.
          </small>
        </div>
      </div>

      <div class="progress" id="directProgress">
        <div class="progress-bar">
          <div class="progress-fill" id="directProgressFill"></div>
        </div>
        <div class="progress-text" id="directProgressText">0 / 0</div>
      </div>
      <button type="submit" class="btn" id="directImportSubmitBtn">Importar Números</button>
      <div id="directImportMsg"></div>
    </form>
  </div>

  <!-- Sección de Batch Calling -->
  <div class="card card-large" id="batchCallSection" style="display: none;">
    <h2 class="section-title">Batch Calling</h2>
    <p class="section-desc">Carga un CSV de contactos con columna phone_number, configura agente y opciones, y crea los batches en Retell AI agrupados por prefijo.</p>

    <form id="batchCallForm">
      <!-- Paso 1: Cargar CSV -->
      <div class="form-group">
        <label for="batchCallCsvFile">Archivo CSV con contactos *</label>
        <input type="file" id="batchCallCsvFile" accept=".csv" required />
        <small style="color: var(--muted); font-size: 0.85rem; display: block; margin-top: 0.25rem;">
          El CSV debe tener una columna "phone_number" o "PhoneNumber". Todas las demás columnas se convertirán en variables personalizadas.
        </small>
      </div>

      <!-- Preview del CSV -->
      <div id="batchCallPreview" style="display: none; margin-top: 1rem; padding: 1rem; background: var(--bg); border-radius: 6px; border: 1px solid var(--border);">
        <h3 style="font-size: 1rem; margin-top: 0; margin-bottom: 0.75rem;">Preview del CSV (primeras 5 filas)</h3>
        <div id="batchCallPreviewContent" style="font-size: 0.85rem; font-family: monospace; max-height: 200px; overflow-y: auto;"></div>
      </div>

      <!-- Paso 2: Configuración -->
      <div class="form-group" style="margin-top: 1.5rem;">
        <label for="batchCallAgentId">Agent ID (opcional)</label>
        <input type="text" id="batchCallAgentId" placeholder="agent_5c8cb6c7ba9eeff5857d7bdf1b" value="agent_5c8cb6c7ba9eeff5857d7bdf1b" />
        <small style="color: var(--muted); font-size: 0.85rem; display: block; margin-top: 0.25rem;">
          El agente normalmente ya está asociado al número telefónico (from_number) en Retell AI. Si se especifica aquí, se usará como override para cada llamada.
        </small>
      </div>

      <div class="form-group">
        <label for="batchCallApiKey">API Key de Retell AI *</label>
        <input type="password" id="batchCallApiKey" placeholder="Ingresa tu API Key" required />
      </div>

      <div class="form-group">
        <label for="batchCallFromNumber">Número origen (from_number)</label>
        <select id="batchCallFromNumber">
          <option value="">Selecciona un número disponible</option>
        </select>
        <small style="color: var(--muted); font-size: 0.85rem; display: block; margin-top: 0.25rem;">
          Se llena automáticamente usando tu API Key con los números disponibles en tu cuenta Retell.
        </small>
      </div>

      <div class="form-group">
        <label for="batchCallBatchName">Batch Name (opcional)</label>
        <input type="text" id="batchCallBatchName" placeholder="Auto-generate based on country" />
        <small style="color: var(--muted); font-size: 0.85rem; display: block; margin-top: 0.25rem;">
          Si no se especifica, se generará automáticamente basado en el país/prefijo (ej: "Batch - Colombia 1")
        </small>
      </div>

      <div class="form-group">
        <label for="batchCallStartTime">Start Time (opcional)</label>
        <input type="datetime-local" id="batchCallStartTime" />
        <small style="color: var(--muted); font-size: 0.85rem; display: block; margin-top: 0.25rem;">
          Si no se especifica, el batch se enviará inmediatamente. Si se especifica, se programará para esa fecha/hora.
        </small>
      </div>

      <div class="form-group">
        <label for="batchCallReservedConcurrency">Reserved Concurrency (opcional)</label>
        <input type="number" id="batchCallReservedConcurrency" min="0" max="100" value="0" />
        <small style="color: var(--muted); font-size: 0.85rem; display: block; margin-top: 0.25rem;">
          Número de concurrencia reservada para otras llamadas que no son batch calls (como llamadas entrantes). Si se omite, se usa 0.
        </small>
      </div>

      <!-- Resumen antes de crear -->
      <div id="batchCallSummary" style="display: none; margin-top: 1.5rem; padding: 1rem; background: var(--bg); border-radius: 6px; border: 1px solid var(--border);">
        <h3 style="font-size: 1rem; margin-top: 0; margin-bottom: 0.75rem;">Resumen</h3>
        <div id="batchCallSummaryContent"></div>
      </div>

      <!-- Progress -->
      <div class="progress" id="batchCallProgress" style="margin-top: 1rem;">
        <div class="progress-bar">
          <div class="progress-fill" id="batchCallProgressFill"></div>
        </div>
        <div class="progress-text" id="batchCallProgressText">0 / 0</div>
      </div>

      <div style="display: flex; gap: 0.75rem; margin-top: 1.5rem;">
        <button type="button" class="btn btn-secondary" id="batchCallCancelBtn" style="flex: 1;">Cancelar</button>
        <button type="submit" class="btn" id="batchCallSubmitBtn" style="flex: 2;">Create Batches</button>
      </div>

      <div id="batchCallMsg" style="margin-top: 1rem;"></div>
    </form>
  </div>

  <!-- Sección de Gestionar Números -->
  <div class="card card-large" id="manageSection" style="display: none;">
    <h2 class="section-title">Gestionar Números en Retell AI</h2>
    <p class="section-desc">Lista los números importados en tu cuenta Retell AI, busca por número o nickname y elimina los que ya no necesites.</p>

    <div class="form-group" style="max-width: 800px;">
      <label for="manageApiKey">API Key de Retell AI *</label>
      <div style="display: flex; gap: 0.75rem; align-items: center;">
        <input 
          type="password" 
          id="manageApiKey" 
          placeholder="Ingresa tu API Key" 
          style="flex: 1;"
        />
        <div style="display: flex; align-items: center; gap: 0.5rem; flex-shrink: 0;">
          <input type="checkbox" id="showApiKey" style="accent-color: var(--accent); cursor: pointer;" />
          <label for="showApiKey" style="font-size: 0.9rem; color: var(--muted); cursor: pointer; white-space: nowrap;">Mostrar API Key</label>
        </div>
      </div>
      <button class="btn" id="loadNumbersBtn" style="margin-top: 1rem;">Cargar Números</button>
    </div>

    <div id="numbersList" style="margin-top: 2rem; display: none;">
      <h3 style="font-size: 1.1rem; margin-bottom: 1.5rem; font-weight: 600;">Números Importados</h3>
      <div class="form-group" style="margin-bottom: 1rem;">
        <label for="searchNumbers" style="font-size: 0.9rem; color: var(--muted); margin-bottom: 0.5rem; display: block;">Buscar número o nickname</label>
        <input 
          type="text" 
          id="searchNumbers" 
          placeholder="Buscar por número (con o sin +) o nickname" 
          style="width: 100%; padding: 0.75rem; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 1rem;"
        />
      </div>
      <div id="numbersTable" style="overflow-x: auto; background: var(--bg); border-radius: var(--radius); padding: 1rem;"></div>
      <div id="manageMsg" style="margin-top: 1rem;"></div>
    </div>
  </div>

  <!-- Sección de Comparar Listas / JSON -->
  <div class="card card-large" id="compareSection" style="display: none;">
    <h2 class="section-title">Comparar Listas / JSON</h2>
    <p class="section-desc">Compara dos CSV por número, busca duplicados en uno o convierte JSON a CSV. Todo en el navegador, sin enviar datos al servidor.</p>

    <!-- Selector de modo -->
    <div style="display: flex; flex-wrap: wrap; gap: var(--space-xs); margin-bottom: var(--space-md);">
      <button class="tab-btn" id="compareModeCompare" style="flex: 1; min-width: 140px; padding: 0.5rem; background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); color: var(--text); cursor: pointer; font-size: 0.9rem;">
        Comparar dos CSV
      </button>
      <button class="tab-btn" id="compareModeDuplicates" style="flex: 1; min-width: 140px; padding: 0.5rem; background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); color: var(--text); cursor: pointer; font-size: 0.9rem;">
        Buscar duplicados
      </button>
      <button class="tab-btn" id="compareModeSplit" style="flex: 1; min-width: 140px; padding: 0.5rem; background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); color: var(--text); cursor: pointer; font-size: 0.9rem;">
        Dividir lista
      </button>
      <button class="tab-btn" id="compareModeJson" style="flex: 1; min-width: 140px; padding: 0.5rem; background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); color: var(--text); cursor: pointer; font-size: 0.9rem;">
        JSON → CSV
      </button>
    </div>

    <!-- Contenido CSV (comparar / duplicados) -->
    <div id="compareCsvContainer">
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; flex-wrap: wrap;">
        <div id="compareFirstListContainer">
          <h3 style="margin: 0 0 0.5rem; font-size: 1rem;">Primer CSV</h3>
          <div class="zone" id="compareZone1" style="padding: 1.5rem;">
            <input type="file" id="compareFile1" accept=".csv" />
            <p>Arrastra aquí un CSV o haz clic para elegir</p>
            <p class="file-name" id="compareFile1Name"></p>
          </div>
          <p id="compareFile1Info" style="margin: 0.5rem 0 0; font-size: 0.85rem; color: var(--muted);"></p>
        </div>
        <div id="compareSecondListContainer">
          <h3 style="margin: 0 0 0.5rem; font-size: 1rem;">Segundo CSV</h3>
          <div class="zone" id="compareZone2" style="padding: 1.5rem;">
            <input type="file" id="compareFile2" accept=".csv" />
            <p>Arrastra aquí un CSV o haz clic para elegir</p>
            <p class="file-name" id="compareFile2Name"></p>
          </div>
          <p id="compareFile2Info" style="margin: 0.5rem 0 0; font-size: 0.85rem; color: var(--muted);"></p>
        </div>
      </div>

      <!-- Opciones extra para modo \"Dividir lista\" -->
      <div id="splitOptions" style="display: none; margin-top: 1rem;">
        <div class="form-group" style="max-width: 260px;">
          <label for="splitParts">Número de partes</label>
          <input type="number" id="splitParts" min="2" value="2" />
        </div>
      </div>

      <div style="margin-top: 1rem;">
        <button class="btn" id="compareActionBtn">Comparar Listas</button>
      </div>
    </div>

    <!-- Contenido JSON -->
    <div id="compareJsonContainer" style="display: none; margin-top: 0.5rem;">
      <div class="form-group">
        <label for="jsonFileInput">Archivo JSON</label>
        <div class="zone" id="jsonZone" style="padding: 1.5rem;">
          <input type="file" id="jsonFileInput" accept=".json" />
          <p>Arrastra aquí un JSON o haz clic para elegir</p>
          <p class="file-name" id="jsonFileName"></p>
        </div>
        <small style="color: var(--muted); font-size: 0.85rem; display: block; margin-top: 0.25rem;">
          El JSON puede ser un objeto o un array de objetos.
        </small>
        <p id="jsonFileInfo" style="margin: 0.5rem 0 0; font-size: 0.85rem; color: var(--muted);"></p>
      </div>
      <button class="btn" id="jsonConvertBtn" disabled>Convertir a CSV y descargar</button>
      <div id="jsonErrorMsg" style="margin-top: 0.75rem;"></div>
    </div>

    <!-- Resultados -->
    <div id="compareResultsContainer" style="margin-top: 1.5rem; display: none;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
        <h3 id="compareResultsTitle" style="margin: 0; font-size: 1rem;">Resultados</h3>
        <button class="btn btn-secondary" id="compareDownloadBtn" style="width: auto; padding-inline: 1rem;" disabled>
          Descargar CSV de resultados
        </button>
      </div>
      <p id="compareSummaryText" style="margin: 0 0 0.75rem; font-size: 0.9rem; color: var(--muted);"></p>
      <div id="compareTableWrapper" style="overflow-x: auto; background: var(--bg); border-radius: var(--radius); padding: 1rem;">
        <div id="compareTablePlaceholder" style="color: var(--muted); text-align: center; padding: 1rem; font-size: 0.9rem;">
          No hay resultados todavía.
        </div>
      </div>
    </div>
  </div>

  </main>

  <!-- Modal de Confirmación para Eliminar -->
  <div class="modal" id="deleteConfirmModal">
    <div class="modal-content confirm-modal-content">
      <div class="modal-header">
        <h2>Confirmar Eliminación</h2>
        <button class="close-btn" id="closeDeleteModal">&times;</button>
      </div>
      <div class="confirm-modal-body">
        <p>¿Estás seguro de que quieres eliminar el número <span class="phone-number" id="deletePhoneNumberText"></span>?</p>
      </div>
      <div class="confirm-checkbox">
        <input type="checkbox" id="dontShowAgain" />
        <label for="dontShowAgain">No mostrar más esta advertencia</label>
      </div>
      <div class="confirm-modal-actions">
        <button class="btn-cancel" id="cancelDeleteBtn">Cancelar</button>
        <button class="btn-confirm" id="confirmDeleteBtn">Eliminar</button>
      </div>
    </div>
  </div>

  <!-- Modal de Importación (mantener para compatibilidad) -->
  <div class="modal" id="importModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Importar a Retell AI</h2>
        <button class="close-btn" id="closeModal">&times;</button>
      </div>
      <form id="importForm">
        <div class="form-group">
          <label>Fuente de números *</label>
          <select id="numberSource" required>
            <option value="processed">Usar números procesados</option>
            <option value="csv">Subir CSV con números</option>
            <option value="manual">Ingresar números manualmente</option>
          </select>
        </div>
        <div class="form-group" id="csvUploadGroup" style="display: none;">
          <label for="csvFile">Archivo CSV con números *</label>
          <input type="file" id="csvFile" accept=".csv" />
          <small style="color: var(--muted); font-size: 0.85rem; display: block; margin-top: 0.25rem;">
            Formato: una columna con números en formato internacional (+57...)
          </small>
        </div>
        <div class="form-group" id="manualNumbersGroup" style="display: none;">
          <label for="manualNumbers">Números telefónicos (uno por línea o separados por comas) *</label>
          <textarea id="manualNumbers" rows="5" placeholder="5493415960906, 5492232105153, 5492616836030&#10;o uno por línea:&#10;+573146816250&#10;+34600089523" style="width: 100%; padding: 0.75rem; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-family: monospace; font-size: 0.9rem; resize: vertical;"></textarea>
          <small style="color: var(--muted); font-size: 0.85rem; display: block; margin-top: 0.25rem;">
            Puedes ingresar números separados por comas o uno por línea. El sistema agregará el "+" automáticamente si falta.
          </small>
          <small style="color: var(--muted); font-size: 0.85rem; display: block; margin-top: 0.25rem;">
            Un número por línea, formato internacional con +
          </small>
        </div>
        <div class="form-group">
          <label for="apiKey">API Key de Retell AI *</label>
          <input type="password" id="apiKey" placeholder="Ingresa tu API Key" required />
        </div>
        <div class="form-group">
          <label for="terminationUri">Termination URI *</label>
          <input type="text" id="terminationUri" placeholder="ia.conecta-bit.com" value="ia.conecta-bit.com" required />
        </div>
        <div class="form-group">
          <label for="outboundTransport">Outbound Transport *</label>
          <select id="outboundTransport" required>
            <option value="UDP" selected>UDP</option>
            <option value="TCP">TCP</option>
            <option value="TLS">TLS</option>
          </select>
        </div>
        <div class="form-group">
          <label for="sipTrunkUsername">SIP Trunk Username (opcional)</label>
          <input type="text" id="sipTrunkUsername" placeholder="Enter SIP Trunk User Name" />
        </div>
        <div class="form-group">
          <label for="sipTrunkPassword">SIP Trunk Password (opcional)</label>
          <input type="password" id="sipTrunkPassword" placeholder="Enter SIP Trunk Password" />
        </div>
        <div class="form-group">
          <label for="outboundAgentId">Outbound Agent ID *</label>
          <input type="text" id="outboundAgentId" placeholder="agent_5c8cb6c7ba9eeff5857d7bdf1b" value="agent_5c8cb6c7ba9eeff5857d7bdf1b" required />
        </div>
        <div class="form-group">
          <label for="nickname">Nickname (opcional)</label>
          <input type="text" id="nickname" placeholder="Ej: Brasil 1 (se numerará automáticamente: Brasil 2, Brasil 3...)" />
          <small style="color: var(--muted); font-size: 0.85rem; display: block; margin-top: 0.25rem;">
            Si ingresas un número (ej: "Brasil 5"), la numeración comenzará desde ese número. Si no ingresas número, comenzará desde 1.
          </small>
        </div>
        <div class="progress" id="progress">
          <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
          </div>
          <div class="progress-text" id="progressText">0 / 0</div>
        </div>
        <button type="submit" class="btn" id="importSubmitBtn">Importar Números</button>
        <div id="importMsg"></div>
      </form>
    </div>
  </div>

  <script>
    const API = window.location.origin;
    const zone = document.getElementById('zone');
    const fileInput = document.getElementById('file');
    const fileName = document.getElementById('fileName');
    const clean = document.getElementById('clean');
    const btn = document.getElementById('btn');
    const msg = document.getElementById('msg');
    const resumen = document.getElementById('resumen');
    const resumenList = document.getElementById('resumenList');
    const links = document.getElementById('links');
    const importBtn = document.getElementById('importBtn');
    const importModal = document.getElementById('importModal');
    const closeModal = document.getElementById('closeModal');
    const importForm = document.getElementById('importForm');
    const importMsg = document.getElementById('importMsg');
    const progress = document.getElementById('progress');
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    const importSubmitBtn = document.getElementById('importSubmitBtn');

    let selected = null;
    let currentOutputId = null;
    /** Números extraídos del último CSV procesado (para importar sin import-stream en Netlify) */
    let lastProcessedPhoneNumbers = [];

    zone.addEventListener('click', () => fileInput.click());
    zone.addEventListener('dragover', (e) => { e.preventDefault(); zone.classList.add('dragover'); });
    zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
    zone.addEventListener('drop', (e) => {
      e.preventDefault();
      zone.classList.remove('dragover');
      const f = e.dataTransfer?.files?.[0];
      if (f && /\.csv$/i.test(f.name)) setFile(f);
    });
    fileInput.addEventListener('change', () => { const f = fileInput.files?.[0]; if (f) setFile(f); });

    function setFile(f) {
      selected = f;
      fileName.textContent = f.name;
      btn.disabled = false;
      msg.textContent = '';
      resumen.style.display = 'none';
    }

    btn.addEventListener('click', async () => {
      if (!selected) return;
      btn.disabled = true;
      msg.textContent = 'Procesando…';
      msg.className = 'msg';
      resumen.style.display = 'none';

      try {
        const csvText = await selected.text();

        const r = await fetch(API + '/api/process', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            csvContent: csvText,
            clean: !!clean.checked,
          }),
        });

        const data = await r.json();
        if (!r.ok) throw new Error(data.error || 'Error en el servidor');

        msg.textContent = `Listo. ${data.valid} válidos.`;
        if (data.errors?.length) msg.textContent += ` ${data.errors.length} rechazados.`;
        msg.className = 'msg ok';

        resumenList.innerHTML = '';
        for (const [pais, n] of Object.entries(data.resumen || {})) {
          const li = document.createElement('li');
          li.textContent = `${pais}: ${n}`;
          resumenList.appendChild(li);
        }

        links.innerHTML = '';
        const fileLabels = {
          resumen: 'Resumen por País',
          numeros: 'Números Generados',
          batch_calling: 'Números Batch Calling',
          datos_limpios: 'Datos Limpios',
        };

        for (const [label, fileInfo] of Object.entries(data.files || {})) {
          if (!fileInfo || !fileInfo.content) continue;
          const blob = new Blob([fileInfo.content], { type: 'text/csv' });
          const url = URL.createObjectURL(blob);

          const a = document.createElement('a');
          a.href = url;
          a.download = fileInfo.filename || (label + '.csv');
          const displayLabel = fileLabels[label] || a.download;
          a.textContent = `Descargar ${displayLabel}`;
          links.appendChild(a);
        }

        resumen.style.display = 'block';
        
        currentOutputId = data.outputId;
        lastProcessedPhoneNumbers = [];
        if (data.files && data.files.numeros && data.files.numeros.content) {
          const content = data.files.numeros.content;
          const lines = content.split(/\r?\n/).filter(l => l.trim());
          for (let i = 1; i < lines.length; i++) {
            const m = lines[i].match(/^[^,]+,"([^"]+)"/);
            if (m) {
              const nums = m[1].split(/,\s*/).map(n => n.trim()).filter(n => n);
              lastProcessedPhoneNumbers.push(...nums.map(n => n.startsWith('+') ? n : '+' + n));
            }
          }
          lastProcessedPhoneNumbers = [...new Set(lastProcessedPhoneNumbers)];
        }
        if (lastProcessedPhoneNumbers.length > 0) {
          importBtn.style.display = 'block';
          const processedOption = directNumberSource.querySelector('option[value="processed"]');
          if (processedOption) {
            processedOption.textContent = 'Usar números procesados (disponible)';
          }
        }
      } catch (e) {
        msg.textContent = e.message || 'Error al procesar';
        msg.className = 'msg error';
      } finally {
        btn.disabled = false;
      }
    });

    // Modal de importación
    importBtn.addEventListener('click', () => {
      importModal.classList.add('active');
    });

    closeModal.addEventListener('click', () => {
      importModal.classList.remove('active');
      importForm.reset();
      importMsg.textContent = '';
      progress.classList.remove('active');
      csvUploadGroup.style.display = 'none';
      manualNumbersGroup.style.display = 'none';
    });

    importModal.addEventListener('click', (e) => {
      if (e.target === importModal) {
        importModal.classList.remove('active');
        importForm.reset();
        importMsg.textContent = '';
        progress.classList.remove('active');
        csvUploadGroup.style.display = 'none';
        manualNumbersGroup.style.display = 'none';
      }
    });

    importForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const source = numberSource.value;
      let phoneNumbers = [];

      // Obtener números según la fuente seleccionada
      if (source === 'processed') {
        if (!lastProcessedPhoneNumbers || lastProcessedPhoneNumbers.length === 0) {
          importMsg.textContent = 'Error: No hay números procesados. Procesa un CSV primero o selecciona otra fuente.';
          importMsg.className = 'msg error';
          return;
        }
        phoneNumbers = lastProcessedPhoneNumbers;
      } else if (source === 'csv') {
        const file = csvFile.files[0];
        if (!file) {
          importMsg.textContent = 'Error: Debes seleccionar un archivo CSV';
          importMsg.className = 'msg error';
          return;
        }
        // Leer el CSV y extraer números
        try {
          const text = await file.text();
          phoneNumbers = extractNumbersFromCSV(text);
          if (phoneNumbers.length === 0) {
            importMsg.textContent = 'Error: No se encontraron números válidos en el CSV';
            importMsg.className = 'msg error';
            return;
          }
        } catch (error) {
          importMsg.textContent = 'Error al leer el archivo CSV: ' + error.message;
          importMsg.className = 'msg error';
          return;
        }
      } else if (source === 'manual') {
        const numbersText = manualNumbers.value.trim();
        if (!numbersText) {
          importMsg.textContent = 'Error: Debes ingresar al menos un número';
          importMsg.className = 'msg error';
          return;
        }
        
        // Procesar números: pueden estar separados por líneas (\n) o por comas (,)
        phoneNumbers = numbersText
          .split(/[\n,]+/) // Dividir por líneas o comas
          .map(line => line.trim())
          .filter(line => line.length > 0)
          .map(num => {
            // Remover espacios y caracteres no numéricos excepto el +
            let cleaned = num.replace(/\s/g, '');
            // Si no empieza con +, agregarlo
            if (!cleaned.startsWith('+')) {
              cleaned = '+' + cleaned;
            }
            return cleaned;
          })
          .filter(num => /^\+\d{8,15}$/.test(num));
        
        if (phoneNumbers.length === 0) {
          importMsg.textContent = 'Error: No se encontraron números válidos. Puedes ingresarlos separados por líneas o comas (ej: 5493415960906, 5492232105153)';
          importMsg.className = 'msg error';
          return;
        }
      }

      const formData = {
        source: source,
        outputId: source === 'processed' ? currentOutputId : null,
        phoneNumbers: phoneNumbers,
        apiKey: document.getElementById('apiKey').value,
        terminationUri: document.getElementById('terminationUri').value,
        outboundTransport: document.getElementById('outboundTransport').value,
        outboundAgentId: document.getElementById('outboundAgentId').value,
        sipTrunkUsername: document.getElementById('sipTrunkUsername').value,
        sipTrunkPassword: document.getElementById('sipTrunkPassword').value,
        nickname: document.getElementById('nickname').value,
      };

      importSubmitBtn.disabled = true;
      importMsg.textContent = '';
      progress.classList.add('active');
      progressFill.style.width = '0%';
      progressText.textContent = 'Iniciando importación...';

      let totalNumbers = 0;
      let importedCount = 0;
      let failedCount = 0;
      const failedNumbers = [];

      // Función para extraer números de CSV
      function extractNumbersFromCSV(csvText) {
        const lines = csvText.split('\n').filter(line => line.trim());
        const numbers = [];
        
        for (const line of lines) {
          // Buscar números que empiecen con + o números de 8-15 dígitos
          const matches = line.match(/(\+?\d{8,15})/g);
          if (matches) {
            numbers.push(...matches.map(num => num.startsWith('+') ? num : `+${num}`));
          }
        }
        
        // Eliminar duplicados
        return [...new Set(numbers)];
      }

      // Función para manejar eventos de progreso
      function handleProgressEvent(data) {
        if (data.type === 'start' || data.event === 'start') {
          totalNumbers = data.total;
          progressText.textContent = `0 / ${totalNumbers}`;
        } else if (data.type === 'progress' || data.event === 'progress') {
          importedCount = data.imported;
          failedCount = data.failed;
          const current = data.current;
          const total = data.total;
          
          // Actualizar barra de progreso
          const percentage = (current / total) * 100;
          progressFill.style.width = `${percentage}%`;
          progressText.textContent = `${current} / ${total} (${importedCount} exitosos, ${failedCount} fallidos)`;
          
          // Guardar números fallidos
          if (!data.success && data.error) {
            failedNumbers.push({ phoneNumber: data.phoneNumber, error: data.error });
          }
        } else if (data.type === 'complete' || data.event === 'complete') {
          progressFill.style.width = '100%';
          progressText.textContent = `${data.total} / ${data.total}`;
          
          importMsg.textContent = `Importación completada: ${data.imported} exitosos, ${data.failed} fallidos`;
          importMsg.className = 'msg ok';

          if (data.failed > 0 && failedNumbers.length > 0) {
            const errorDetails = failedNumbers.slice(0, 10).map(r => 
              `${r.phoneNumber}: ${r.error}`
            ).join('\n');
            importMsg.textContent += `\n\nErrores (primeros 10):\n${errorDetails}`;
          }

          importSubmitBtn.disabled = false;

          if (data.failed === 0) {
            setTimeout(() => {
              importModal.classList.remove('active');
              importForm.reset();
              progress.classList.remove('active');
              csvUploadGroup.style.display = 'none';
              manualNumbersGroup.style.display = 'none';
            }, 5000);
          }
        }
      }

      try {
        importMsg.textContent = 'Importando números...';
        importMsg.className = 'msg';
        progress.classList.add('active');
        progressText.textContent = `0 / ${formData.phoneNumbers.length}`;

        const response = await fetch(API + '/api/retell/import-direct', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            phoneNumbers: formData.phoneNumbers,
            apiKey: formData.apiKey,
            terminationUri: formData.terminationUri,
            outboundTransport: formData.outboundTransport,
            outboundAgentId: formData.outboundAgentId,
            sipTrunkUsername: formData.sipTrunkUsername || '',
            sipTrunkPassword: formData.sipTrunkPassword || '',
            nickname: formData.nickname || '',
          }),
        });

        const data = await response.json();
        if (!response.ok) throw new Error(data.error || 'Error al importar');

        handleProgressEvent({ type: 'complete', event: 'complete', ...data });
      } catch (error) {
        importMsg.textContent = error.message || 'Error al importar números';
        importMsg.className = 'msg error';
        progress.classList.remove('active');
        importSubmitBtn.disabled = false;
      }
    });

    // ===== SECCIÓN DE IMPORTACIÓN DIRECTA / NAVEGACIÓN DE TABS =====
    const processSection = document.getElementById('processSection');
    const importSection = document.getElementById('importSection');
    const batchCallSection = document.getElementById('batchCallSection');
    const manageSection = document.getElementById('manageSection');
    const compareSection = document.getElementById('compareSection');

    const tabProcess = document.getElementById('tabProcess');
    const tabImport = document.getElementById('tabImport');
    const tabBatchCall = document.getElementById('tabBatchCall');
    const tabManage = document.getElementById('tabManage');
    const tabCompare = document.getElementById('tabCompare');

    const directImportForm = document.getElementById('directImportForm');
    const directNumberSource = document.getElementById('directNumberSource');
    const directCsvUploadGroup = document.getElementById('directCsvUploadGroup');
    const directManualNumbersGroup = document.getElementById('directManualNumbersGroup');
    const directProcessedGroup = document.getElementById('directProcessedGroup');
    const directCsvFile = document.getElementById('directCsvFile');
    const directManualNumbers = document.getElementById('directManualNumbers');
    const directProgress = document.getElementById('directProgress');
    const directProgressFill = document.getElementById('directProgressFill');
    const directProgressText = document.getElementById('directProgressText');
    const directImportSubmitBtn = document.getElementById('directImportSubmitBtn');
    const directImportMsg = document.getElementById('directImportMsg');

    // Helper para activar pestañas y sincronizar con la URL
    function setActiveTab(tab) {
      // Reset secciones
      processSection.style.display = 'none';
      importSection.style.display = 'none';
      batchCallSection.style.display = 'none';
      manageSection.style.display = 'none';
      compareSection.style.display = 'none';

      // Reset clases de tabs
      tabProcess.classList.remove('active');
      tabImport.classList.remove('active');
      tabBatchCall.classList.remove('active');
      tabManage.classList.remove('active');
      tabCompare.classList.remove('active');

      let path = '/procesar-csv';

      if (tab === 'process') {
        processSection.style.display = 'block';
        tabProcess.classList.add('active');
        path = '/procesar-csv';
      } else if (tab === 'import') {
        importSection.style.display = 'block';
        tabImport.classList.add('active');
        path = '/importar-retell';
      } else if (tab === 'batch') {
        batchCallSection.style.display = 'block';
        tabBatchCall.classList.add('active');
        path = '/batch-calling';
      } else if (tab === 'manage') {
        manageSection.style.display = 'block';
        tabManage.classList.add('active');
        path = '/gestionar-numeros';
      } else if (tab === 'compare') {
        compareSection.style.display = 'block';
        tabCompare.classList.add('active');
        path = '/comparar-listas';
      }

      // Actualizar URL sin recargar la página
      if (window.location.pathname !== path) {
        window.history.pushState({ tab }, '', path);
      }
    }

    // Navegación entre tabs
    tabProcess.addEventListener('click', () => {
      setActiveTab('process');
    });

    tabImport.addEventListener('click', () => {
      setActiveTab('import');
    });

    tabManage.addEventListener('click', () => {
      setActiveTab('manage');
    });

    if (tabCompare && compareSection) {
      tabCompare.addEventListener('click', () => {
        setActiveTab('compare');
      });
    }

    // Seleccionar pestaña inicial según la URL
    function initTabFromPath() {
      const path = window.location.pathname || '/';
      if (path === '/' || path === '/procesar-csv') {
        setActiveTab('process');
      } else if (path === '/importar-retell') {
        setActiveTab('import');
      } else if (path === '/batch-calling') {
        setActiveTab('batch');
      } else if (path === '/gestionar-numeros') {
        setActiveTab('manage');
      } else if (path === '/comparar-listas') {
        setActiveTab('compare');
      } else {
        // Cualquier otra ruta desconocida cae en Procesar CSV
        setActiveTab('process');
      }
    }

    // Manejar navegación con atrás/adelante del navegador
    window.addEventListener('popstate', () => {
      initTabFromPath();
    });

    // Inicializar al cargar
    initTabFromPath();

    // Manejar cambio de fuente de números en importación directa
    directNumberSource.addEventListener('change', (e) => {
      const source = e.target.value;
      directCsvUploadGroup.style.display = source === 'csv' ? 'block' : 'none';
      directManualNumbersGroup.style.display = source === 'manual' ? 'block' : 'none';
      directProcessedGroup.style.display = source === 'processed' ? 'block' : 'none';
      
      directCsvFile.required = source === 'csv';
      directManualNumbers.required = source === 'manual';
    });

    // Función para extraer números de CSV (compartida)
    function extractNumbersFromCSV(csvText) {
      const lines = csvText.split('\n').filter(line => line.trim());
      const numbers = [];
      
      for (const line of lines) {
        const matches = line.match(/(\+?\d{8,15})/g);
        if (matches) {
          numbers.push(...matches.map(num => num.startsWith('+') ? num : `+${num}`));
        }
      }
      
      return [...new Set(numbers)];
    }

    // Formulario de importación directa
    directImportForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const source = directNumberSource.value;
      let phoneNumbers = [];

      if (source === 'processed') {
        if (!lastProcessedPhoneNumbers || lastProcessedPhoneNumbers.length === 0) {
          directImportMsg.textContent = 'Error: No hay números procesados. Procesa un CSV primero en la pestaña "Procesar CSV".';
          directImportMsg.className = 'msg error';
          return;
        }
        phoneNumbers = lastProcessedPhoneNumbers;
      } else if (source === 'csv') {
        const file = directCsvFile.files[0];
        if (!file) {
          directImportMsg.textContent = 'Error: Debes seleccionar un archivo CSV';
          directImportMsg.className = 'msg error';
          return;
        }
        try {
          const text = await file.text();
          phoneNumbers = extractNumbersFromCSV(text);
          if (phoneNumbers.length === 0) {
            directImportMsg.textContent = 'Error: No se encontraron números válidos en el CSV';
            directImportMsg.className = 'msg error';
            return;
          }
        } catch (error) {
          directImportMsg.textContent = 'Error al leer el archivo CSV: ' + error.message;
          directImportMsg.className = 'msg error';
          return;
        }
      } else if (source === 'manual') {
        const numbersText = directManualNumbers.value.trim();
        if (!numbersText) {
          directImportMsg.textContent = 'Error: Debes ingresar al menos un número';
          directImportMsg.className = 'msg error';
          return;
        }
        
        // Procesar números: pueden estar separados por líneas (\n) o por comas (,)
        phoneNumbers = numbersText
          .split(/[\n,]+/) // Dividir por líneas o comas
          .map(line => line.trim())
          .filter(line => line.length > 0)
          .map(num => {
            // Remover espacios y caracteres no numéricos excepto el +
            let cleaned = num.replace(/\s/g, '');
            // Si no empieza con +, agregarlo
            if (!cleaned.startsWith('+')) {
              cleaned = '+' + cleaned;
            }
            return cleaned;
          })
          .filter(num => /^\+\d{8,15}$/.test(num));
        
        if (phoneNumbers.length === 0) {
          directImportMsg.textContent = 'Error: No se encontraron números válidos. Puedes ingresarlos separados por líneas o comas (ej: 5493415960906, 5492232105153)';
          directImportMsg.className = 'msg error';
          return;
        }
      }

      const formData = {
        source: source,
        outputId: source === 'processed' ? currentOutputId : null,
        phoneNumbers: phoneNumbers,
        apiKey: document.getElementById('directApiKey').value,
        terminationUri: document.getElementById('directTerminationUri').value,
        outboundTransport: document.getElementById('directOutboundTransport').value,
        outboundAgentId: document.getElementById('directOutboundAgentId').value,
        sipTrunkUsername: document.getElementById('directSipTrunkUsername').value,
        sipTrunkPassword: document.getElementById('directSipTrunkPassword').value,
        nickname: document.getElementById('directNickname').value,
      };

      directImportSubmitBtn.disabled = true;
      directImportMsg.textContent = '';
      directProgress.classList.add('active');
      directProgressFill.style.width = '0%';
      directProgressText.textContent = 'Iniciando importación...';

      let totalNumbers = 0;
      let importedCount = 0;
      let failedCount = 0;
      const failedNumbers = [];

      function handleDirectProgressEvent(data) {
        if (data.type === 'start' || data.event === 'start') {
          totalNumbers = data.total;
          directProgressText.textContent = `0 / ${totalNumbers}`;
        } else if (data.type === 'progress' || data.event === 'progress') {
          importedCount = data.imported;
          failedCount = data.failed;
          const current = data.current;
          const total = data.total;
          
          const percentage = (current / total) * 100;
          directProgressFill.style.width = `${percentage}%`;
          directProgressText.textContent = `${current} / ${total} (${importedCount} exitosos, ${failedCount} fallidos)`;
          
          if (!data.success && data.error) {
            failedNumbers.push({ phoneNumber: data.phoneNumber, error: data.error });
          }
        } else if (data.type === 'complete' || data.event === 'complete') {
          directProgressFill.style.width = '100%';
          directProgressText.textContent = `${data.total} / ${data.total}`;
          
          directImportMsg.textContent = `Importación completada: ${data.imported} exitosos, ${data.failed} fallidos`;
          directImportMsg.className = 'msg ok';

          if (data.failed > 0 && failedNumbers.length > 0) {
            const errorDetails = failedNumbers.slice(0, 10).map(r => 
              `${r.phoneNumber}: ${r.error}`
            ).join('\n');
            directImportMsg.textContent += `\n\nErrores (primeros 10):\n${errorDetails}`;
          }

          directImportSubmitBtn.disabled = false;
        }
      }

      try {
        directProgressText.textContent = `0 / ${formData.phoneNumbers.length}`;

        const response = await fetch(API + '/api/retell/import-direct', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            phoneNumbers: formData.phoneNumbers,
            apiKey: formData.apiKey,
            terminationUri: formData.terminationUri,
            outboundTransport: formData.outboundTransport,
            outboundAgentId: formData.outboundAgentId,
            sipTrunkUsername: formData.sipTrunkUsername || '',
            sipTrunkPassword: formData.sipTrunkPassword || '',
            nickname: formData.nickname || '',
          }),
        });

        const data = await response.json();
        if (!response.ok) throw new Error(data.error || 'Error al importar');

        handleDirectProgressEvent({ type: 'complete', event: 'complete', ...data });
      } catch (error) {
        directImportMsg.textContent = error.message || 'Error al importar números';
        directImportMsg.className = 'msg error';
        directProgress.classList.remove('active');
        directImportSubmitBtn.disabled = false;
      }
    });

    // ===== SECCIÓN DE BATCH CALLING =====
    const batchCallForm = document.getElementById('batchCallForm');
    const batchCallCsvFile = document.getElementById('batchCallCsvFile');
    const batchCallPreview = document.getElementById('batchCallPreview');
    const batchCallPreviewContent = document.getElementById('batchCallPreviewContent');
    const batchCallSummary = document.getElementById('batchCallSummary');
    const batchCallSummaryContent = document.getElementById('batchCallSummaryContent');
    const batchCallProgress = document.getElementById('batchCallProgress');
    const batchCallProgressFill = document.getElementById('batchCallProgressFill');
    const batchCallProgressText = document.getElementById('batchCallProgressText');
    const batchCallSubmitBtn = document.getElementById('batchCallSubmitBtn');
    const batchCallCancelBtn = document.getElementById('batchCallCancelBtn');
    const batchCallMsg = document.getElementById('batchCallMsg');
    const batchCallApiKeyInput = document.getElementById('batchCallApiKey');
    const batchCallFromNumberSelect = document.getElementById('batchCallFromNumber');

    let batchCallCsvData = null;
    let batchCallGeneratedNumbers = null;

    // Navegación a Batch Calling
    tabBatchCall.addEventListener('click', () => {
      setActiveTab('batch');
    });

    // Preview del CSV cuando se selecciona
    batchCallCsvFile.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      batchCallMsg.textContent = 'Validando CSV...';
      batchCallMsg.className = 'msg';

      try {
        const text = await file.text();
        batchCallCsvData = text;

        // Validar y mostrar preview
        const response = await fetch(API + '/api/retell/validate-batch-csv', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ csvContent: text }),
        });

        const result = await response.json();

        if (result.success && result.preview && result.preview.length > 0) {
          // Mostrar preview
          let previewHTML = '<table style="width: 100%; font-size: 0.8rem; border-collapse: collapse;"><thead><tr>';
          
          // Obtener todas las claves únicas de todas las filas
          const allKeys = new Set();
          result.preview.forEach(row => {
            Object.keys(row).forEach(k => allKeys.add(k));
          });
          const headers = Array.from(allKeys);
          
          headers.forEach(h => {
            previewHTML += `<th style="padding: 0.5rem; text-align: left; border-bottom: 1px solid var(--border); background: var(--bg);">${h}</th>`;
          });
          previewHTML += '</tr></thead><tbody>';

          result.preview.forEach(row => {
            previewHTML += '<tr>';
            headers.forEach(h => {
              const value = row[h] || '';
              previewHTML += `<td style="padding: 0.5rem; border-bottom: 1px solid var(--border);">${String(value).substring(0, 30)}${String(value).length > 30 ? '...' : ''}</td>`;
            });
            previewHTML += '</tr>';
          });
          previewHTML += '</tbody></table>';
          previewHTML += `<p style="margin-top: 0.5rem; color: var(--muted); font-size: 0.8rem;">Total: ${result.total} contactos válidos</p>`;

          batchCallPreviewContent.innerHTML = previewHTML;
          batchCallPreview.style.display = 'block';
          batchCallMsg.textContent = `CSV válido: ${result.total} contactos encontrados`;
          batchCallMsg.className = 'msg ok';
        } else {
          batchCallMsg.textContent = result.error || 'Error al validar el CSV';
          batchCallMsg.className = 'msg error';
          batchCallPreview.style.display = 'none';
        }
      } catch (error) {
        batchCallMsg.textContent = 'Error al leer el archivo: ' + error.message;
        batchCallMsg.className = 'msg error';
        batchCallPreview.style.display = 'none';
      }
    });

    // Cargar números generados cuando se ingresa API Key
    if (batchCallApiKeyInput) {
      batchCallApiKeyInput.addEventListener('blur', async () => {
        const apiKey = batchCallApiKeyInput.value.trim();
        if (apiKey) {
          try {
            const response = await fetch(API + '/api/retell/list?apiKey=' + encodeURIComponent(apiKey));
            const result = await response.json();
            if (result.success) {
              batchCallGeneratedNumbers = result.phoneNumbers || [];
              if (batchCallGeneratedNumbers.length > 0) {
                batchCallMsg.textContent = `${batchCallGeneratedNumbers.length} números telefónicos disponibles`;
                batchCallMsg.className = 'msg ok';
                if (batchCallFromNumberSelect) {
                  batchCallFromNumberSelect.innerHTML = '<option value=\"\">Selecciona un número disponible</option>';
                  batchCallGeneratedNumbers.forEach((phone) => {
                    const numRaw = phone.phone_number || phone.from_number || phone.number || phone;
                    if (!numRaw) return;
                    const num = String(numRaw).startsWith('+') ? String(numRaw) : `+${numRaw}`;
                    const label = phone.nickname ? `${num} — ${phone.nickname}` : num;
                    const opt = document.createElement('option');
                    opt.value = num;
                    opt.textContent = label;
                    batchCallFromNumberSelect.appendChild(opt);
                  });
                }
              }
            }
          } catch (error) {
            console.error('Error al cargar números:', error);
          }
        }
      });
    }

    // Formulario de Batch Call
    batchCallForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      if (!batchCallCsvData) {
        batchCallMsg.textContent = 'Error: Debes seleccionar un archivo CSV';
        batchCallMsg.className = 'msg error';
        return;
      }

      const agentId = document.getElementById('batchCallAgentId').value.trim();
      const batchName = document.getElementById('batchCallBatchName').value.trim();
      const startTime = document.getElementById('batchCallStartTime').value;
      const reservedConcurrency = document.getElementById('batchCallReservedConcurrency').value;

      const body = {
        apiKey: batchCallApiKeyInput.value,
        csvContent: batchCallCsvData,
      };
      if (agentId) body.agent_id = agentId;
      if (batchName) body.batch_name = batchName;
      if (startTime) body.start_time = new Date(startTime).toISOString();
      if (reservedConcurrency) body.reserved_concurrency = reservedConcurrency;
      if (batchCallGeneratedNumbers && batchCallGeneratedNumbers.length > 0) {
        body.generatedNumbers = batchCallGeneratedNumbers;
      }
      if (batchCallFromNumberSelect && batchCallFromNumberSelect.value) {
        body.from_number = batchCallFromNumberSelect.value;
      }

      batchCallSubmitBtn.disabled = true;
      batchCallMsg.textContent = '';
      batchCallProgress.classList.add('active');
      batchCallProgressFill.style.width = '0%';
      batchCallProgressText.textContent = 'Creando batches...';

      try {
        const response = await fetch(API + '/api/retell/create-batch-call', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
        });

        const result = await response.json();

        if (result.success) {
          batchCallProgressFill.style.width = '100%';
          batchCallProgressText.textContent = 'Completado';

          let msgHTML = `<div class="msg ok">`;
          msgHTML += `<strong>Batches creados exitosamente:</strong><br>`;
          msgHTML += `Total contactos: ${result.total_contacts}<br>`;
          msgHTML += `Batches creados: ${result.batches_created}<br>`;
          if (result.batches_failed > 0) {
            msgHTML += `Batches fallidos: ${result.batches_failed}<br>`;
          }
          msgHTML += `<br><strong>Detalles:</strong><br>`;
          result.results.forEach((r, idx) => {
            msgHTML += `${idx + 1}. ${r.batch_name || r.from_number}: ${r.total_calls} contactos (ID: ${r.batch_call_id})<br>`;
          });
          msgHTML += `</div>`;

          batchCallMsg.innerHTML = msgHTML;

          // Mostrar resumen
          let summaryHTML = `<p><strong>Total contactos:</strong> ${result.total_contacts}</p>`;
          summaryHTML += `<p><strong>Batches a crear:</strong> ${result.batches_created}</p>`;
          summaryHTML += `<ul style="margin: 0.5rem 0; padding-left: 1.5rem;">`;
          result.results.forEach(r => {
            summaryHTML += `<li>${r.nickname || r.from_number} (${r.from_number}): ${r.total_calls} contactos</li>`;
          });
          summaryHTML += `</ul>`;
          summaryHTML += `<p style="color: var(--accent);"><strong>Status:</strong> Creating as DRAFT ✓</p>`;
          batchCallSummaryContent.innerHTML = summaryHTML;
          batchCallSummary.style.display = 'block';
        } else {
          batchCallMsg.textContent = result.error || 'Error al crear batches';
          batchCallMsg.className = 'msg error';
        }
      } catch (error) {
        batchCallMsg.textContent = 'Error: ' + error.message;
        batchCallMsg.className = 'msg error';
      } finally {
        batchCallSubmitBtn.disabled = false;
      }
    });

    batchCallCancelBtn.addEventListener('click', () => {
      batchCallForm.reset();
      batchCallCsvData = null;
      batchCallPreview.style.display = 'none';
      batchCallSummary.style.display = 'none';
      batchCallProgress.classList.remove('active');
      batchCallMsg.textContent = '';
    });

    // ===== SECCIÓN DE GESTIÓN DE NÚMEROS =====
    const manageApiKey = document.getElementById('manageApiKey');
    const showApiKey = document.getElementById('showApiKey');
    const loadNumbersBtn = document.getElementById('loadNumbersBtn');
    const numbersList = document.getElementById('numbersList');
    const numbersTable = document.getElementById('numbersTable');
    const manageMsg = document.getElementById('manageMsg');
    const searchNumbersInput = document.getElementById('searchNumbers');
    
    // Variable para almacenar todos los números (sin filtrar)
    let allPhoneNumbers = [];
    let currentApiKey = '';

    // Toggle para mostrar/ocultar API Key
    if (showApiKey) {
      showApiKey.addEventListener('change', (e) => {
        manageApiKey.type = e.target.checked ? 'text' : 'password';
      });
    }

    // Permitir buscar con Enter en el campo de API Key
    if (manageApiKey) {
      manageApiKey.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          // Solo ejecutar si el botón no está deshabilitado
          if (!loadNumbersBtn.disabled) {
            loadNumbersBtn.click();
          }
        }
      });
    }

    loadNumbersBtn.addEventListener('click', async () => {
      const apiKey = manageApiKey.value.trim();
      if (!apiKey) {
        manageMsg.textContent = 'Error: Debes ingresar tu API Key';
        manageMsg.className = 'msg error';
        return;
      }

      loadNumbersBtn.disabled = true;
      loadNumbersBtn.textContent = 'Cargando...';
      manageMsg.textContent = '';
      numbersList.style.display = 'none';

      try {
        const response = await fetch(API + '/api/retell/list?apiKey=' + encodeURIComponent(apiKey));
        const result = await response.json();

        if (!result.success) {
          throw new Error(result.error || 'Error al cargar números');
        }

        const phoneNumbers = result.phoneNumbers || [];
        
        // Guardar los números originales y la API key para el filtrado
        allPhoneNumbers = phoneNumbers;
        currentApiKey = apiKey;
        
        // Limpiar el campo de búsqueda
        searchNumbersInput.value = '';
        
        // Debug: ver qué campos tiene el primer número
        if (phoneNumbers.length > 0) {
          console.log('Ejemplo de número recibido:', phoneNumbers[0]);
          console.log('Campos disponibles:', Object.keys(phoneNumbers[0]));
        }
        
        // Renderizar la tabla con todos los números
        renderPhoneNumbersTable(phoneNumbers);
        
        if (phoneNumbers.length === 0) {
          manageMsg.textContent = 'No hay números importados en Retell AI';
          manageMsg.className = 'msg';
          numbersList.style.display = 'block';
        } else {
          numbersList.style.display = 'block';
          manageMsg.textContent = `Se encontraron ${phoneNumbers.length} número(s)`;
          manageMsg.className = 'msg ok';
        }
      } catch (error) {
        manageMsg.textContent = error.message || 'Error al cargar números';
        manageMsg.className = 'msg error';
      } finally {
        loadNumbersBtn.disabled = false;
        loadNumbersBtn.textContent = 'Cargar Números';
      }
    });

    // Función para renderizar la tabla de números
    function renderPhoneNumbersTable(phoneNumbers) {
      if (phoneNumbers.length === 0) {
        numbersTable.innerHTML = '<p style="color: var(--muted); text-align: center; padding: 2rem;">No hay números para mostrar</p>';
        return;
      }

      let tableHTML = '<table><thead><tr><th style="width: 30%;">Número</th><th style="width: 25%;">Nickname</th><th style="width: 35%;">Agent ID</th><th style="width: 10%; text-align: center;">Acción</th></tr></thead><tbody>';
      
      phoneNumbers.forEach((phone, index) => {
        const nickname = phone.nickname || '-';
        const agentId = phone.outbound_agent_id || '-';
        // El ID puede venir como phone_number_id, _id o id. Si no existe, usamos el phone_number directamente
        const phoneNumberId = phone.phone_number_id || phone._id || phone.id || phone.phone_number;
        
        // Debug para el primer número
        if (index === 0) {
          console.log('=== DEBUG: Estructura del primer número ===');
          console.log('Objeto completo:', phone);
          console.log('phone_number_id:', phone.phone_number_id);
          console.log('_id:', phone._id);
          console.log('id:', phone.id);
          console.log('phone_number:', phone.phone_number);
          console.log('Todos los campos:', Object.keys(phone));
          console.log('ID que se usará:', phoneNumberId);
        }
        
        // Escapar comillas simples y dobles para evitar problemas en el HTML
        const safePhoneNumberId = phoneNumberId ? String(phoneNumberId).replace(/'/g, "\\'").replace(/"/g, '&quot;') : '';
        const safeApiKey = String(currentApiKey).replace(/'/g, "\\'").replace(/"/g, '&quot;');
        const safePhoneNumber = String(phone.phone_number || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
        
        tableHTML += `
          <tr>
            <td><strong>${phone.phone_number}</strong></td>
            <td>${nickname}</td>
            <td style="font-size: 0.85rem; color: var(--muted); word-break: break-all;">${agentId}</td>
            <td style="text-align: center;">
              <button class="btn-small delete-btn" data-phone="${safePhoneNumber}" onclick="deletePhoneNumber('${safePhoneNumberId}', '${safeApiKey}', '${safePhoneNumber}', this)" title="Eliminar ${safePhoneNumber}">
                Eliminar
              </button>
            </td>
          </tr>
        `;
      });
      
      tableHTML += '</tbody></table>';
      numbersTable.innerHTML = tableHTML;
    }

    // Función para filtrar números telefónicos
    function filterPhoneNumbers(searchTerm) {
      if (!searchTerm || searchTerm.trim() === '') {
        // Si no hay término de búsqueda, mostrar todos
        renderPhoneNumbersTable(allPhoneNumbers);
        manageMsg.textContent = `Se encontraron ${allPhoneNumbers.length} número(s)`;
        manageMsg.className = 'msg ok';
        return;
      }

      const searchLower = searchTerm.trim().toLowerCase();
      
      // Filtrar números que coincidan en número telefónico o nickname
      const filtered = allPhoneNumbers.filter(phone => {
        // Buscar en el número telefónico (normalizado, sin + y espacios)
        const normalizedPhone = (phone.phone_number || '').replace(/\+/g, '').replace(/\s/g, '').toLowerCase();
        const phoneMatches = normalizedPhone.includes(searchLower.replace(/\+/g, '').replace(/\s/g, ''));
        
        // Buscar en el nickname (case-insensitive)
        const nickname = (phone.nickname || '').toLowerCase();
        const nicknameMatches = nickname.includes(searchLower);
        
        // Retornar true si coincide en número o nickname
        return phoneMatches || nicknameMatches;
      });

      // Renderizar la tabla con los números filtrados
      renderPhoneNumbersTable(filtered);
      
      if (filtered.length === 0) {
        manageMsg.textContent = `No se encontraron números que coincidan con "${searchTerm}"`;
        manageMsg.className = 'msg';
      } else {
        manageMsg.textContent = `Se encontraron ${filtered.length} número(s) de ${allPhoneNumbers.length} total`;
        manageMsg.className = 'msg ok';
      }
    }

    // Event listener para el campo de búsqueda
    if (searchNumbersInput) {
      searchNumbersInput.addEventListener('input', (e) => {
        const searchTerm = e.target.value;
        filterPhoneNumbers(searchTerm);
      });
    }

    // Función para mostrar modal de confirmación personalizado
    function showDeleteConfirmModal(phoneNumber) {
      return new Promise((resolve) => {
        const modal = document.getElementById('deleteConfirmModal');
        const phoneNumberText = document.getElementById('deletePhoneNumberText');
        const dontShowAgainCheckbox = document.getElementById('dontShowAgain');
        const confirmBtn = document.getElementById('confirmDeleteBtn');
        const cancelBtn = document.getElementById('cancelDeleteBtn');
        const closeBtn = document.getElementById('closeDeleteModal');

        // Verificar si el usuario ya marcó "No mostrar más"
        const skipConfirmation = localStorage.getItem('skipDeleteConfirmation') === 'true';
        if (skipConfirmation) {
          resolve(true);
          return;
        }

        // Configurar el texto del número
        phoneNumberText.textContent = phoneNumber;

        // Mostrar el modal
        modal.classList.add('active');

        // Función para cerrar el modal
        const closeModal = () => {
          modal.classList.remove('active');
        };

        // Función para confirmar
        const handleConfirm = () => {
          const dontShowAgain = dontShowAgainCheckbox.checked;
          if (dontShowAgain) {
            localStorage.setItem('skipDeleteConfirmation', 'true');
          }
          closeModal();
          resolve(true);
        };

        // Función para cancelar
        const handleCancel = () => {
          closeModal();
          resolve(false);
        };

        // Limpiar listeners anteriores y agregar nuevos
        confirmBtn.onclick = handleConfirm;
        cancelBtn.onclick = handleCancel;
        closeBtn.onclick = handleCancel;
        
        // Cerrar al hacer clic fuera del modal
        modal.onclick = (e) => {
          if (e.target === modal) {
            handleCancel();
          }
        };

        // Cerrar con Escape
        const handleEscape = (e) => {
          if (e.key === 'Escape' && modal.classList.contains('active')) {
            handleCancel();
            document.removeEventListener('keydown', handleEscape);
          }
        };
        document.addEventListener('keydown', handleEscape);
      });
    }

    // Función global para eliminar números
    window.deletePhoneNumber = async function(phoneNumberId, apiKey, phoneNumber, buttonElement) {
      console.log('deletePhoneNumber llamado con:', { phoneNumberId, phoneNumber, apiKey: apiKey ? 'presente' : 'faltante' });
      
      // Si phoneNumberId está vacío o es inválido, usar phoneNumber directamente
      let identifier = phoneNumberId;
      if (!identifier || identifier === 'undefined' || identifier === 'null' || (typeof identifier === 'string' && identifier.trim() === '')) {
        console.warn('PhoneNumberId inválido, usando phoneNumber directamente:', phoneNumber);
        identifier = phoneNumber;
      }
      
      // Validar que tengamos al menos un identificador
      if (!identifier || identifier.trim() === '') {
        manageMsg.textContent = 'Error: No se puede identificar el número a eliminar.';
        manageMsg.className = 'msg error';
        console.error('No hay identificador válido:', { phoneNumberId, phoneNumber });
        return;
      }

      // Obtener el botón si no se pasó como parámetro
      let btn = buttonElement;
      if (!btn) {
        // Intentar encontrar el botón por el atributo data-phone
        btn = document.querySelector(`button.delete-btn[data-phone="${phoneNumber}"]`);
      }
      
      // Si aún no tenemos el botón, intentar usar event.target como fallback
      if (!btn && typeof event !== 'undefined' && event.target) {
        btn = event.target;
      }

      // Mostrar modal de confirmación personalizado
      const confirmed = await showDeleteConfirmModal(phoneNumber);
      if (!confirmed) {
        // Si se canceló, asegurarse de que el botón esté en estado normal
        if (btn) {
          btn.disabled = false;
          btn.textContent = 'Eliminar';
        }
        return;
      }

      // Actualizar el estado del botón solo si existe
      if (btn) {
        btn.disabled = true;
        btn.textContent = 'Eliminando...';
      }

      try {
        // Usar encodeURIComponent para asegurar que el identificador se pase correctamente
        const response = await fetch(API + '/api/retell/delete/' + encodeURIComponent(identifier), {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ apiKey, phoneNumber }),
        });

        const result = await response.json();

        if (result.success) {
          manageMsg.textContent = `Número ${phoneNumber} eliminado exitosamente`;
          manageMsg.className = 'msg ok';
          // Recargar la lista (esto recreará todos los botones)
          setTimeout(() => {
            loadNumbersBtn.click();
          }, 1000);
        } else {
          manageMsg.textContent = result.error || 'Error al eliminar número';
          manageMsg.className = 'msg error';
          if (btn) {
            btn.disabled = false;
            btn.textContent = 'Eliminar';
          }
        }
      } catch (error) {
        manageMsg.textContent = error.message || 'Error al eliminar número';
        manageMsg.className = 'msg error';
        if (btn) {
          btn.disabled = false;
          btn.textContent = 'Eliminar';
        }
      }
    };

    // ===== SECCIÓN DE COMPARAR LISTAS / JSON (CLIENTE) =====
    (function setupCompareSection() {
      if (!compareSection) return;

      const compareFile1 = document.getElementById('compareFile1');
      const compareFile2 = document.getElementById('compareFile2');
      const compareZone1 = document.getElementById('compareZone1');
      const compareZone2 = document.getElementById('compareZone2');
      const compareFile1Name = document.getElementById('compareFile1Name');
      const compareFile2Name = document.getElementById('compareFile2Name');
      const compareFile1Info = document.getElementById('compareFile1Info');
      const compareFile2Info = document.getElementById('compareFile2Info');
      const compareModeCompare = document.getElementById('compareModeCompare');
      const compareModeDuplicates = document.getElementById('compareModeDuplicates');
      const compareModeSplit = document.getElementById('compareModeSplit');
      const compareModeJson = document.getElementById('compareModeJson');
      const compareCsvContainer = document.getElementById('compareCsvContainer');
      const compareSecondListContainer = document.getElementById('compareSecondListContainer');
      const splitOptions = document.getElementById('splitOptions');
      const splitPartsInput = document.getElementById('splitParts');
      const compareJsonContainer = document.getElementById('compareJsonContainer');
      const compareActionBtn = document.getElementById('compareActionBtn');
      const compareResultsContainer = document.getElementById('compareResultsContainer');
      const compareResultsTitle = document.getElementById('compareResultsTitle');
      const compareSummaryText = document.getElementById('compareSummaryText');
      const compareTableWrapper = document.getElementById('compareTableWrapper');
      const compareDownloadBtn = document.getElementById('compareDownloadBtn');
      const jsonFileInput = document.getElementById('jsonFileInput');
      const jsonZone = document.getElementById('jsonZone');
      const jsonFileName = document.getElementById('jsonFileName');
      const jsonFileInfo = document.getElementById('jsonFileInfo');
      const jsonConvertBtn = document.getElementById('jsonConvertBtn');
      const jsonErrorMsg = document.getElementById('jsonErrorMsg');

      let compareMode = 'compare'; // 'compare' | 'duplicates' | 'split' | 'json'
      let list1 = [];
      let list2 = [];
      let resultData = [];
      let jsonData = null;
      let splitPartsData = [];

      function setCompareMode(mode) {
        compareMode = mode;

        compareModeCompare.classList.remove('active');
        compareModeDuplicates.classList.remove('active');
        if (compareModeSplit) compareModeSplit.classList.remove('active');
        compareModeJson.classList.remove('active');

        if (mode === 'compare') {
          compareModeCompare.classList.add('active');
          compareCsvContainer.style.display = 'block';
          compareSecondListContainer.style.display = 'block';
          compareJsonContainer.style.display = 'none';
          if (splitOptions) splitOptions.style.display = 'none';
          compareActionBtn.textContent = 'Comparar Listas';
        } else if (mode === 'duplicates') {
          compareModeDuplicates.classList.add('active');
          compareCsvContainer.style.display = 'block';
          compareSecondListContainer.style.display = 'none';
          compareJsonContainer.style.display = 'none';
          if (splitOptions) splitOptions.style.display = 'none';
          compareActionBtn.textContent = 'Buscar duplicados en CSV';
        } else if (mode === 'split') {
          if (compareModeSplit) compareModeSplit.classList.add('active');
          compareCsvContainer.style.display = 'block';
          compareSecondListContainer.style.display = 'none';
          compareJsonContainer.style.display = 'none';
          if (splitOptions) splitOptions.style.display = 'block';
          compareActionBtn.textContent = 'Dividir lista';
        } else if (mode === 'json') {
          compareModeJson.classList.add('active');
          compareCsvContainer.style.display = 'none';
          compareJsonContainer.style.display = 'block';
          compareResultsContainer.style.display = 'none';
          if (splitOptions) splitOptions.style.display = 'none';
        }
      }

      if (compareModeCompare) {
        compareModeCompare.addEventListener('click', () => setCompareMode('compare'));
      }
      if (compareModeDuplicates) {
        compareModeDuplicates.addEventListener('click', () => setCompareMode('duplicates'));
      }
      if (compareModeSplit) {
        compareModeSplit.addEventListener('click', () => setCompareMode('split'));
      }
      if (compareModeJson) {
        compareModeJson.addEventListener('click', () => setCompareMode('json'));
      }

      setCompareMode('compare');

      function parseCsvFileToObjects(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = (event) => {
            try {
              const text = String(event.target.result || '');
              const lines = text.split(/\r?\n/).filter((l) => l.trim());
              if (!lines.length) {
                resolve([]);
                return;
              }
              const header = lines[0].split(',').map((h) => h.trim());
              const rows = [];
              for (let i = 1; i < lines.length; i++) {
                const cols = lines[i].split(',');
                if (!cols.some((c) => c.trim())) continue;
                const obj = {};
                header.forEach((h, idx) => {
                  obj[h] = (cols[idx] || '').trim();
                });
                rows.push(obj);
              }
              resolve(rows);
            } catch (err) {
              reject(err);
            }
          };
          reader.onerror = () => reject(new Error('Error leyendo archivo'));
          reader.readAsText(file);
        });
      }

      function getPhoneKey(obj) {
        const keys = Object.keys(obj || {});
        const match = keys.find((k) =>
          /^phone[\s_]?number$/i.test(k) ||
          /^telefono$/i.test(k) ||
          /^tel$/i.test(k) ||
          /^phone$/i.test(k)
        );
        return match || keys[0] || null;
      }

      function toCsv(objects) {
        if (!objects || !objects.length) return '';
        const allKeys = new Set();
        objects.forEach((o) => Object.keys(o).forEach((k) => allKeys.add(k)));
        const headers = Array.from(allKeys);
        const rows = [headers.join(',')];
        for (const o of objects) {
          const cols = headers.map((h) => {
            let v = o[h] != null ? String(o[h]) : '';
            if (v.includes('"') || v.includes(',') || v.includes('\n')) {
              v = '"' + v.replace(/"/g, '""') + '"';
            }
            return v;
          });
          rows.push(cols.join(','));
        }
        return rows.join('\n');
      }

      function downloadCsv(content, filename) {
        const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      function renderTable(data) {
        if (!data || !data.length) {
          compareTableWrapper.innerHTML = '<p style="color: var(--muted); text-align: center; padding: 1rem;">No hay filas para mostrar.</p>';
          return;
        }
        const allKeys = new Set();
        data.forEach((o) => Object.keys(o).forEach((k) => allKeys.add(k)));
        const headers = Array.from(allKeys);
        let html = '<table><thead><tr>';
        headers.forEach((h) => {
          html += `<th>${h}</th>`;
        });
        html += '</tr></thead><tbody>';
        data.forEach((row) => {
          html += '<tr>';
          headers.forEach((h) => {
            const v = row[h] != null ? String(row[h]) : '';
            html += `<td>${v}</td>`;
          });
          html += '</tr>';
        });
        html += '</tbody></table>';
        compareTableWrapper.innerHTML = html;
      }

      async function handleCompareFile1(file) {
        compareFile1Info.textContent = 'Leyendo...';
        if (compareFile1Name) compareFile1Name.textContent = file.name || '';
        try {
          list1 = await parseCsvFileToObjects(file);
          compareFile1Info.textContent = `${file.name} — ${list1.length} filas`;
        } catch (err) {
          compareFile1Info.textContent = 'Error al leer CSV';
        }
      }

      async function handleCompareFile2(file) {
        compareFile2Info.textContent = 'Leyendo...';
        if (compareFile2Name) compareFile2Name.textContent = file.name || '';
        try {
          list2 = await parseCsvFileToObjects(file);
          compareFile2Info.textContent = `${file.name} — ${list2.length} filas`;
        } catch (err) {
          compareFile2Info.textContent = 'Error al leer CSV';
        }
      }

      if (compareFile1) {
        compareFile1.addEventListener('change', async (e) => {
          const file = e.target.files && e.target.files[0];
          if (!file) return;
          await handleCompareFile1(file);
        });
      }

      if (compareFile2) {
        compareFile2.addEventListener('change', async (e) => {
          const file = e.target.files && e.target.files[0];
          if (!file) return;
          await handleCompareFile2(file);
        });
      }

      function setupDropZone(zoneEl, inputEl, onFile) {
        if (!zoneEl || !inputEl) return;
        zoneEl.addEventListener('click', () => inputEl.click());
        zoneEl.addEventListener('dragover', (e) => {
          e.preventDefault();
          zoneEl.classList.add('dragover');
        });
        zoneEl.addEventListener('dragleave', () => {
          zoneEl.classList.remove('dragover');
        });
        zoneEl.addEventListener('drop', (e) => {
          e.preventDefault();
          zoneEl.classList.remove('dragover');
          const f = e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0];
          if (!f) return;
          onFile(f);
        });
      }

      setupDropZone(compareZone1, compareFile1, (file) => {
        if (!/\.csv$/i.test(file.name)) return;
        handleCompareFile1(file);
      });

      setupDropZone(compareZone2, compareFile2, (file) => {
        if (!/\.csv$/i.test(file.name)) return;
        handleCompareFile2(file);
      });

      if (compareActionBtn) {
        compareActionBtn.addEventListener('click', () => {
          if (compareMode === 'compare') {
            if (!list1.length || !list2.length) {
              alert('Debes cargar dos CSV primero.');
              return;
            }
            const phoneKey1 = getPhoneKey(list1[0]);
            const phoneKey2 = getPhoneKey(list2[0]);
            const set2 = new Set(list2.map((r) => String(r[phoneKey2] || '').trim()).filter(Boolean));
            const unique = list1.filter((r) => {
              const v = String(r[phoneKey1] || '').trim();
              return v && !set2.has(v);
            });
            resultData = unique;
            compareResultsTitle.textContent = 'Registros únicos del primer CSV (no presentes en el segundo)';
            compareSummaryText.textContent = `Primer CSV: ${list1.length} filas. Segundo CSV: ${list2.length} filas. Únicos en el primero: ${unique.length}.`;
            renderTable(unique);
            compareResultsContainer.style.display = 'block';
            compareDownloadBtn.disabled = !unique.length;
          } else if (compareMode === 'duplicates') {
            if (!list1.length) {
              alert('Debes cargar un CSV primero.');
              return;
            }
            const phoneKey = getPhoneKey(list1[0]);
            const seen = new Set();
            const unique = [];
            const duplicates = [];
            list1.forEach((r) => {
              const v = String(r[phoneKey] || '').trim();
              if (!v) return;
              if (seen.has(v)) {
                duplicates.push(r);
              } else {
                seen.add(v);
                unique.push(r);
              }
            });
            resultData = unique;
            compareResultsTitle.textContent = 'Registros deduplicados por número';
            compareSummaryText.textContent = `Filas originales: ${list1.length}. Únicos: ${unique.length}. Duplicados: ${duplicates.length}.`;
            renderTable(unique);
            compareResultsContainer.style.display = 'block';
            compareDownloadBtn.disabled = !unique.length;
          } else if (compareMode === 'split') {
            if (!list1.length) {
              alert('Debes cargar un CSV primero.');
              return;
            }
            const partsCount = parseInt(splitPartsInput && splitPartsInput.value ? splitPartsInput.value : '2', 10);
            if (!partsCount || partsCount < 2) {
              alert('El número de partes debe ser al menos 2.');
              return;
            }
            if (partsCount > list1.length) {
              alert('No puedes crear más partes que registros. Reduce el número de partes.');
              return;
            }

            const total = list1.length;
            const baseSize = Math.floor(total / partsCount);
            const remainder = total % partsCount;
            const parts = [];
            let start = 0;
            for (let i = 0; i < partsCount; i++) {
              const size = baseSize + (i < remainder ? 1 : 0);
              const end = start + size;
              parts.push(list1.slice(start, end));
              start = end;
            }

            compareResultsTitle.textContent = 'División de lista';
            compareSummaryText.textContent = `Total registros: ${total}. Partes generadas: ${partsCount}. Usa \"Descargar CSV de resultados\" para bajar todas las partes.`;
            // Mostrar la primera parte como vista previa en la tabla
            renderTable(parts[0] || []);
            compareResultsContainer.style.display = 'block';
            splitPartsData = parts;
            compareDownloadBtn.disabled = parts.length === 0;
          }
        });
      }

      if (compareDownloadBtn) {
        compareDownloadBtn.addEventListener('click', () => {
          if (compareMode === 'split') {
            if (!splitPartsData || !splitPartsData.length) return;
            splitPartsData.forEach((part, idx) => {
              if (!part.length) return;
              const csv = toCsv(part);
              const filename = `split_part_${idx + 1}_of_${splitPartsData.length}.csv`;
              downloadCsv(csv, filename);
            });
          } else {
            if (!resultData || !resultData.length) return;
            const csv = toCsv(resultData);
            const filename = compareMode === 'compare' ? 'registros_unicos.csv' : 'registros_deduplicados.csv';
            downloadCsv(csv, filename);
          }
        });
      }

      function handleJsonFile(file) {
        if (!file) return;
        jsonFileInfo.textContent = 'Leyendo JSON...';
        if (jsonFileName) jsonFileName.textContent = file.name || '';
        jsonErrorMsg.textContent = '';
        jsonErrorMsg.className = '';
        const reader = new FileReader();
        reader.onload = (ev) => {
          try {
            const text = String(ev.target.result || '');
            jsonData = JSON.parse(text);
            const rows = Array.isArray(jsonData) ? jsonData.length : 1;
            jsonFileInfo.textContent = `${file.name} — ${rows} registro(s)`;
            jsonConvertBtn.disabled = false;
          } catch (err) {
            jsonData = null;
            jsonFileInfo.textContent = '';
            jsonConvertBtn.disabled = true;
            jsonErrorMsg.textContent = 'Formato JSON inválido.';
            jsonErrorMsg.className = 'msg error';
          }
        };
        reader.onerror = () => {
          jsonData = null;
          jsonFileInfo.textContent = '';
          jsonConvertBtn.disabled = true;
          jsonErrorMsg.textContent = 'Error al leer el archivo JSON.';
          jsonErrorMsg.className = 'msg error';
        };
        reader.readAsText(file);
      }

      if (jsonFileInput) {
        jsonFileInput.addEventListener('change', (e) => {
          const file = e.target.files && e.target.files[0];
          if (!file) return;
          handleJsonFile(file);
        });
      }

      if (jsonZone && jsonFileInput) {
        setupDropZone(jsonZone, jsonFileInput, (file) => {
          if (!/\.json$/i.test(file.name)) return;
          handleJsonFile(file);
        });
      }

      if (jsonConvertBtn) {
        jsonConvertBtn.addEventListener('click', () => {
          if (!jsonData) return;
          try {
            const arr = Array.isArray(jsonData) ? jsonData : [jsonData];
            const csv = toCsv(arr);
            downloadCsv(csv, 'convertido_desde_json.csv');
            jsonErrorMsg.textContent = 'Conversión completada. Se descargó el CSV.';
            jsonErrorMsg.className = 'msg ok';
          } catch (err) {
            jsonErrorMsg.textContent = 'Error al convertir JSON a CSV.';
            jsonErrorMsg.className = 'msg error';
          }
        });
      }
    })();
  </script>
</body>
</html>
