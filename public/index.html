<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Micro Tools</title>
  <link rel="stylesheet" href="styles.css" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet" />
</head>
<body>
  <aside class="sidebar">
    <div class="sidebar-brand">Micro Tools</div>
    <p class="sidebar-desc">Herramientas de CSV, teléfonos y Retell AI</p>
    <nav class="sidebar-nav">
      <button type="button" class="tab-btn active" id="tabProcess">Procesar CSV</button>
      <button type="button" class="tab-btn" id="tabImport">Importar a Retell AI</button>
      <button type="button" class="tab-btn" id="tabBatchCall">Batch Calling</button>
      <button type="button" class="tab-btn" id="tabManage">Gestionar Números</button>
      <button type="button" class="tab-btn" id="tabCompare">Comparar Listas / JSON</button>
      <button type="button" class="tab-btn" id="tabWhatsAppTemplates">Plantillas WhatsApp</button>
      <button type="button" class="tab-btn" id="tabProxyLink">ProxyLink</button>
    </nav>
  </aside>

  <main class="main-content">
  <!-- Sección de Procesar CSV -->
  <div class="card card-large" id="processSection">
    <h2 class="section-title">Procesar CSV</h2>
    <p class="section-desc">Sube un archivo CSV para validar números, normalizar por país y obtener resumen, números generados y archivos listos para batch calling.</p>
    <div class="zone" id="zone">
      <input type="file" id="file" accept=".csv" />
      <p>Arrastra aquí un CSV o haz clic para elegir</p>
      <p class="file-name" id="fileName"></p>
    </div>
    <div class="opt">
      <input type="checkbox" id="clean" />
      <label for="clean">Incluir CSV limpio (datos_limpios.csv)</label>
    </div>
    <button class="btn" id="btn" disabled>Procesar</button>
    <div id="msg"></div>
    <div class="resumen" id="resumen" style="display:none">
      <h3>Resumen por país</h3>
      <ul id="resumenList"></ul>
      <div class="links" id="links"></div>
      <button class="btn btn-secondary" id="importBtn" style="margin-top: 1rem; display: none;">
        Importar a Retell AI
      </button>
    </div>
  </div>

  <!-- Sección de Importar a Retell AI -->
  <div class="card card-large" id="importSection" style="display: none;">
    <h2 class="section-title">Importar Números a Retell AI</h2>
    <p class="section-desc">Elige la fuente de números (CSV, manual o procesados) y configura credenciales y parámetros de Retell AI para importar.</p>

    <form id="directImportForm">
      <div class="form-block">
        <div class="form-block-title">Fuente de números</div>
        <div class="form-group">
          <label>Fuente de números *</label>
          <select id="directNumberSource" required>
            <option value="csv">Subir CSV con números</option>
            <option value="manual">Ingresar números manualmente</option>
            <option value="processed">Usar números procesados</option>
          </select>
        </div>
        <div class="form-group" id="directCsvUploadGroup">
          <label for="directCsvFile">Archivo CSV con números *</label>
          <input type="file" id="directCsvFile" accept=".csv" />
          <small style="color: var(--muted); font-size: 0.85rem; display: block; margin-top: 0.25rem;">
            Formato: una columna con números en formato internacional (+57...)
          </small>
        </div>
        <div class="form-group" id="directManualNumbersGroup" style="display: none;">
          <label for="directManualNumbers">Números telefónicos (uno por línea o separados por comas) *</label>
          <textarea id="directManualNumbers" rows="8" placeholder="5493415960906, 5492232105153, 5492616836030&#10;o uno por línea:&#10;+573146816250&#10;+34600089523" style="width: 100%; padding: 0.75rem; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-family: monospace; font-size: 0.9rem; resize: vertical;"></textarea>
          <small style="color: var(--muted); font-size: 0.85rem; display: block; margin-top: 0.25rem;">
            Puedes ingresar números separados por comas o uno por línea. El sistema agregará el "+" automáticamente si falta.
          </small>
        </div>
        <div class="form-group" id="directProcessedGroup" style="display: none;">
          <p style="color: var(--muted); font-size: 0.9rem; margin: 0;">
            Primero procesa un CSV en la pestaña "Procesar CSV" para usar esta opción.
          </p>
        </div>
      </div>

      <div class="form-block">
        <div class="form-block-title">Retell AI — Credenciales y conexión</div>
        <div class="form-group">
          <label for="directApiKey">API Key de Retell AI *</label>
          <input type="password" id="directApiKey" placeholder="Ingresa tu API Key" required />
        </div>
        <div class="form-group">
          <label for="directTerminationUri">Termination URI *</label>
          <input type="text" id="directTerminationUri" placeholder="ia.conecta-bit.com" value="ia.conecta-bit.com" required />
        </div>
        <div class="form-group">
          <label for="directOutboundTransport">Outbound Transport *</label>
          <select id="directOutboundTransport" required>
            <option value="UDP" selected>UDP</option>
            <option value="TCP">TCP</option>
            <option value="TLS">TLS</option>
          </select>
        </div>
        <div class="form-group">
          <label for="directOutboundAgentId">Outbound Agent ID *</label>
          <input type="text" id="directOutboundAgentId" placeholder="agent_5c8cb6c7ba9eeff5857d7bdf1b" value="agent_5c8cb6c7ba9eeff5857d7bdf1b" required />
        </div>
      </div>

      <div class="form-block">
        <div class="form-block-title">Opcionales — SIP y nickname</div>
        <div class="form-group">
          <label for="directSipTrunkUsername">SIP Trunk Username (opcional)</label>
          <input type="text" id="directSipTrunkUsername" placeholder="Enter SIP Trunk User Name" />
        </div>
        <div class="form-group">
          <label for="directSipTrunkPassword">SIP Trunk Password (opcional)</label>
          <input type="password" id="directSipTrunkPassword" placeholder="Enter SIP Trunk Password" />
        </div>
        <div class="form-group">
          <label for="directNickname">Nickname (opcional)</label>
          <input type="text" id="directNickname" placeholder="Ej: Brasil 1 (se numerará automáticamente: Brasil 2, Brasil 3...)" />
          <small style="color: var(--muted); font-size: 0.85rem; display: block; margin-top: 0.25rem;">
            Si ingresas un número (ej: "Brasil 5"), la numeración comenzará desde ese número. Si no ingresas número, comenzará desde 1.
          </small>
        </div>
      </div>

      <div class="progress" id="directProgress">
        <div class="progress-bar">
          <div class="progress-fill" id="directProgressFill"></div>
        </div>
        <div class="progress-text" id="directProgressText">0 / 0</div>
      </div>
      <button type="submit" class="btn" id="directImportSubmitBtn">Importar Números</button>
      <div id="directImportMsg"></div>
    </form>
  </div>

  <!-- Sección de Batch Calling -->
  <div class="card card-large" id="batchCallSection" style="display: none;">
    <h2 class="section-title">Batch Calling</h2>
    <p class="section-desc">Carga un CSV de contactos con columna phone_number, configura agente y opciones, y crea los batches en Retell AI agrupados por prefijo.</p>

    <div class="form-block" style="margin-bottom: 1.5rem;">
      <div class="form-group" style="display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap;">
        <label for="batchCallCount" style="margin: 0; font-weight: 500;">Cantidad de formularios</label>
        <input type="number" id="batchCallCount" min="1" max="20" value="1" style="max-width: 5rem;" />
        <button type="button" class="btn" id="batchCallDeployBtn">Desplegar formularios</button>
      </div>
      <small style="color: var(--muted); font-size: 0.85rem; display: block; margin-top: 0.25rem;">
        Completa cada formulario con su CSV y datos, y ejecuta "Create Batches" en el que quieras.
      </small>
    </div>

    <!-- Contenedor donde se despliegan N formularios completos -->
    <div id="batchCallSlotsContainer"></div>
  </div>

  <!-- Sección de Gestionar Números -->
  <div class="card card-large" id="manageSection" style="display: none;">
    <h2 class="section-title">Gestionar Números en Retell AI</h2>
    <p class="section-desc">Lista los números importados en tu cuenta Retell AI, busca por número o nickname y elimina los que ya no necesites.</p>

    <div class="form-group" style="max-width: 800px;">
      <label for="manageApiKey">API Key de Retell AI *</label>
      <div style="display: flex; gap: 0.75rem; align-items: center;">
        <input 
          type="password" 
          id="manageApiKey" 
          placeholder="Ingresa tu API Key" 
          style="flex: 1;"
        />
        <div style="display: flex; align-items: center; gap: 0.5rem; flex-shrink: 0;">
          <input type="checkbox" id="showApiKey" style="accent-color: var(--accent); cursor: pointer;" />
          <label for="showApiKey" style="font-size: 0.9rem; color: var(--muted); cursor: pointer; white-space: nowrap;">Mostrar API Key</label>
        </div>
      </div>
      <button class="btn" id="loadNumbersBtn" style="margin-top: 1rem;">Cargar Números</button>
    </div>

    <div id="numbersList" style="margin-top: 2rem; display: none;">
      <h3 style="font-size: 1.1rem; margin-bottom: 1.5rem; font-weight: 600;">Números Importados</h3>
      <div class="form-group" style="margin-bottom: 1rem;">
        <label for="searchNumbers" style="font-size: 0.9rem; color: var(--muted); margin-bottom: 0.5rem; display: block;">Buscar número o nickname</label>
        <input 
          type="text" 
          id="searchNumbers" 
          placeholder="Buscar por número (con o sin +) o nickname" 
          style="width: 100%; padding: 0.75rem; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 1rem;"
        />
      </div>
      <div id="numbersTable" style="overflow-x: auto; background: var(--bg); border-radius: var(--radius); padding: 1rem;"></div>
      <div id="manageMsg" style="margin-top: 1rem;"></div>
    </div>
  </div>

  <!-- Sección de Comparar Listas / JSON -->
  <div class="card card-large" id="compareSection" style="display: none;">
    <h2 class="section-title">Comparar Listas / JSON</h2>
    <p class="section-desc">Compara dos CSV por número, busca duplicados en uno o convierte JSON a CSV. Todo en el navegador, sin enviar datos al servidor.</p>

    <!-- Selector de modo -->
    <div style="display: flex; flex-wrap: wrap; gap: var(--space-xs); margin-bottom: var(--space-md);">
      <button class="tab-btn" id="compareModeCompare" style="flex: 1; min-width: 140px; padding: 0.5rem; background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); color: var(--text); cursor: pointer; font-size: 0.9rem;">
        Comparar dos CSV
      </button>
      <button class="tab-btn" id="compareModeDuplicates" style="flex: 1; min-width: 140px; padding: 0.5rem; background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); color: var(--text); cursor: pointer; font-size: 0.9rem;">
        Buscar duplicados
      </button>
      <button class="tab-btn" id="compareModeSplit" style="flex: 1; min-width: 140px; padding: 0.5rem; background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); color: var(--text); cursor: pointer; font-size: 0.9rem;">
        Dividir lista
      </button>
      <button class="tab-btn" id="compareModeNoLlama" style="flex: 1; min-width: 140px; padding: 0.5rem; background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); color: var(--text); cursor: pointer; font-size: 0.9rem;">
        Borrar No Llama
      </button>
      <button class="tab-btn" id="compareModeJson" style="flex: 1; min-width: 140px; padding: 0.5rem; background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); color: var(--text); cursor: pointer; font-size: 0.9rem;">
        JSON → CSV
      </button>
    </div>

    <!-- Contenido CSV (comparar / duplicados) -->
    <div id="compareCsvContainer">
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; flex-wrap: wrap;">
        <div id="compareFirstListContainer">
          <h3 style="margin: 0 0 0.5rem; font-size: 1rem;">Primer CSV</h3>
          <div class="zone" id="compareZone1" style="padding: 1.5rem;">
            <input type="file" id="compareFile1" accept=".csv" />
            <p>Arrastra aquí un CSV o haz clic para elegir</p>
            <p class="file-name" id="compareFile1Name"></p>
          </div>
          <p id="compareFile1Info" style="margin: 0.5rem 0 0; font-size: 0.85rem; color: var(--muted);"></p>
        </div>
        <div id="compareSecondListContainer">
          <h3 style="margin: 0 0 0.5rem; font-size: 1rem;">Segundo CSV</h3>
          <div class="zone" id="compareZone2" style="padding: 1.5rem;">
            <input type="file" id="compareFile2" accept=".csv" />
            <p>Arrastra aquí un CSV o haz clic para elegir</p>
            <p class="file-name" id="compareFile2Name"></p>
          </div>
          <p id="compareFile2Info" style="margin: 0.5rem 0 0; font-size: 0.85rem; color: var(--muted);"></p>
        </div>
      </div>

      <!-- Opciones extra para modo \"Dividir lista\" -->
      <div id="splitOptions" style="display: none; margin-top: 1rem;">
        <div class="form-group" style="max-width: 260px;">
          <label for="splitParts">Número de partes</label>
          <input type="number" id="splitParts" min="2" value="2" />
        </div>
      </div>

      <div style="margin-top: 1rem;">
        <button class="btn" id="compareActionBtn">Comparar Listas</button>
      </div>
    </div>

    <!-- Contenido JSON -->
    <div id="compareJsonContainer" style="display: none; margin-top: 0.5rem;">
      <div class="form-group">
        <label for="jsonFileInput">Archivo JSON</label>
        <div class="zone" id="jsonZone" style="padding: 1.5rem;">
          <input type="file" id="jsonFileInput" accept=".json" />
          <p>Arrastra aquí un JSON o haz clic para elegir</p>
          <p class="file-name" id="jsonFileName"></p>
        </div>
        <small style="color: var(--muted); font-size: 0.85rem; display: block; margin-top: 0.25rem;">
          El JSON puede ser un objeto o un array de objetos.
        </small>
        <p id="jsonFileInfo" style="margin: 0.5rem 0 0; font-size: 0.85rem; color: var(--muted);"></p>
      </div>
      <button class="btn" id="jsonConvertBtn" disabled>Convertir a CSV y descargar</button>
      <div id="jsonErrorMsg" style="margin-top: 0.75rem;"></div>
    </div>

    <!-- Resultados -->
    <div id="compareResultsContainer" style="margin-top: 1.5rem; display: none;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
        <h3 id="compareResultsTitle" style="margin: 0; font-size: 1rem;">Resultados</h3>
        <button class="btn btn-secondary" id="compareDownloadBtn" style="width: auto; padding-inline: 1rem;" disabled>
          Descargar CSV de resultados
        </button>
      </div>
      <p id="compareSummaryText" style="margin: 0 0 0.75rem; font-size: 0.9rem; color: var(--muted);"></p>
      <div id="compareTableWrapper" style="overflow-x: auto; background: var(--bg); border-radius: var(--radius); padding: 1rem;">
        <div id="compareTablePlaceholder" style="color: var(--muted); text-align: center; padding: 1rem; font-size: 0.9rem;">
          No hay resultados todavía.
        </div>
      </div>
    </div>
  </div>

  <!-- Sección ProxyLink -->
  <div class="card card-large" id="proxyLinkSection" style="display: none;">
    <h2 class="section-title">ProxyLink</h2>
    <p class="section-desc">
      Genera URLs proxy que capturan parámetros de consulta, envían un POST JSON a tu webhook y luego redirigen al usuario a la URL de destino.
    </p>

    <div class="wa-card" id="proxyCredsCard" style="margin-top: 1rem;">
      <div class="wa-card-header">
        <span class="material-icons-outlined wa-card-icon">cloud</span>
        <span>Credenciales Supabase</span>
      </div>
      <div class="wa-fields">
        <div id="proxyCredsManual">
          <div class="wa-field">
            <label class="wa-label" for="proxySupabaseUrl">Supabase URL *</label>
            <input type="text" id="proxySupabaseUrl" class="wa-input" placeholder="https://XYZ.supabase.co" />
          </div>
          <div class="wa-field">
            <label class="wa-label" for="proxySupabaseKey">Supabase anon key *</label>
            <input type="password" id="proxySupabaseKey" class="wa-input" placeholder="public anon key" />
          </div>
        </div>
        <div class="wa-field" style="display:flex;align-items:center;gap:0.75rem;">
          <button type="button" class="wa-btn wa-btn-secondary wa-btn-small" id="proxyConnectBtn">
            <span class="material-icons-outlined" style="font-size:16px;">link</span>
            <span>Conectar &amp; listar URLs</span>
          </button>
          <span id="proxyStatus" class="wa-hint" style="text-transform:none;"></span>
        </div>
      </div>
    </div>

    <div class="wa-card">
      <div class="wa-card-header">
        <span class="material-icons-outlined wa-card-icon">add_link</span>
        <span>Crear Proxy URL</span>
      </div>
      <form id="proxyCreateForm" class="wa-fields">
        <div class="wa-field">
          <label class="wa-label" for="proxyLabel">Label (opcional)</label>
          <input type="text" id="proxyLabel" class="wa-input" placeholder="e.g. Email campaign - Jan 2026" />
        </div>
        <div class="wa-field">
          <label class="wa-label" for="proxyRedirectUrl">Redirect URL *</label>
          <input type="url" id="proxyRedirectUrl" class="wa-input" placeholder="https://your-site.com/destination" required />
          <p class="wa-hint" style="text-transform:none;">El usuario será redirigido aquí después del click.</p>
        </div>
        <div class="wa-field">
          <label class="wa-label" for="proxyPostUrl">POST Webhook URL *</label>
          <input type="url" id="proxyPostUrl" class="wa-input" placeholder="https://your-api.com/webhook" required />
          <p class="wa-hint" style="text-transform:none;">Todos los query params se enviarán como JSON a este endpoint.</p>
        </div>
        <div id="proxyError" class="wa-verify-result"></div>
        <button type="submit" class="wa-btn wa-btn-primary" id="proxyCreateBtn">Generar Proxy URL</button>
      </form>
    </div>

    <div class="wa-card">
      <div class="wa-card-header">
        <span class="material-icons-outlined wa-card-icon">list</span>
        <span>Tus Proxy URLs</span>
      </div>
      <div id="proxyListLoading" style="display:none;" class="wa-verify-result">Cargando configuraciones...</div>
      <div id="proxyListEmpty" class="wa-verify-result" style="display:none;">Aún no hay Proxy URLs. Crea la primera usando el formulario.</div>
      <div id="proxyListContainer" class="wa-buttons-rows" style="gap:1rem;"></div>
    </div>
  </div>

  </main>

  <!-- Modal de Confirmación para Eliminar -->
  <div class="modal" id="deleteConfirmModal">
    <div class="modal-content confirm-modal-content">
      <div class="modal-header">
        <h2>Confirmar Eliminación</h2>
        <button class="close-btn" id="closeDeleteModal">&times;</button>
      </div>
      <div class="confirm-modal-body">
        <p>¿Estás seguro de que quieres eliminar el número <span class="phone-number" id="deletePhoneNumberText"></span>?</p>
      </div>
      <div class="confirm-checkbox">
        <input type="checkbox" id="dontShowAgain" />
        <label for="dontShowAgain">No mostrar más esta advertencia</label>
      </div>
      <div class="confirm-modal-actions">
        <button class="btn-cancel" id="cancelDeleteBtn">Cancelar</button>
        <button class="btn-confirm" id="confirmDeleteBtn">Eliminar</button>
      </div>
    </div>
  </div>

  <!-- Modal de Importación (mantener para compatibilidad) -->
  <div class="modal" id="importModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Importar a Retell AI</h2>
        <button class="close-btn" id="closeModal">&times;</button>
      </div>
      <form id="importForm">
        <div class="form-group">
          <label>Fuente de números *</label>
          <select id="numberSource" required>
            <option value="processed">Usar números procesados</option>
            <option value="csv">Subir CSV con números</option>
            <option value="manual">Ingresar números manualmente</option>
          </select>
        </div>
        <div class="form-group" id="csvUploadGroup" style="display: none;">
          <label for="csvFile">Archivo CSV con números *</label>
          <input type="file" id="csvFile" accept=".csv" />
          <small style="color: var(--muted); font-size: 0.85rem; display: block; margin-top: 0.25rem;">
            Formato: una columna con números en formato internacional (+57...)
          </small>
        </div>
        <div class="form-group" id="manualNumbersGroup" style="display: none;">
          <label for="manualNumbers">Números telefónicos (uno por línea o separados por comas) *</label>
          <textarea id="manualNumbers" rows="5" placeholder="5493415960906, 5492232105153, 5492616836030&#10;o uno por línea:&#10;+573146816250&#10;+34600089523" style="width: 100%; padding: 0.75rem; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-family: monospace; font-size: 0.9rem; resize: vertical;"></textarea>
          <small style="color: var(--muted); font-size: 0.85rem; display: block; margin-top: 0.25rem;">
            Puedes ingresar números separados por comas o uno por línea. El sistema agregará el "+" automáticamente si falta.
          </small>
          <small style="color: var(--muted); font-size: 0.85rem; display: block; margin-top: 0.25rem;">
            Un número por línea, formato internacional con +
          </small>
        </div>
        <div class="form-group">
          <label for="apiKey">API Key de Retell AI *</label>
          <input type="password" id="apiKey" placeholder="Ingresa tu API Key" required />
        </div>
        <div class="form-group">
          <label for="terminationUri">Termination URI *</label>
          <input type="text" id="terminationUri" placeholder="ia.conecta-bit.com" value="ia.conecta-bit.com" required />
        </div>
        <div class="form-group">
          <label for="outboundTransport">Outbound Transport *</label>
          <select id="outboundTransport" required>
            <option value="UDP" selected>UDP</option>
            <option value="TCP">TCP</option>
            <option value="TLS">TLS</option>
          </select>
        </div>
        <div class="form-group">
          <label for="sipTrunkUsername">SIP Trunk Username (opcional)</label>
          <input type="text" id="sipTrunkUsername" placeholder="Enter SIP Trunk User Name" />
        </div>
        <div class="form-group">
          <label for="sipTrunkPassword">SIP Trunk Password (opcional)</label>
          <input type="password" id="sipTrunkPassword" placeholder="Enter SIP Trunk Password" />
        </div>
        <div class="form-group">
          <label for="outboundAgentId">Outbound Agent ID *</label>
          <input type="text" id="outboundAgentId" placeholder="agent_5c8cb6c7ba9eeff5857d7bdf1b" value="agent_5c8cb6c7ba9eeff5857d7bdf1b" required />
        </div>
        <div class="form-group">
          <label for="nickname">Nickname (opcional)</label>
          <input type="text" id="nickname" placeholder="Ej: Brasil 1 (se numerará automáticamente: Brasil 2, Brasil 3...)" />
          <small style="color: var(--muted); font-size: 0.85rem; display: block; margin-top: 0.25rem;">
            Si ingresas un número (ej: "Brasil 5"), la numeración comenzará desde ese número. Si no ingresas número, comenzará desde 1.
          </small>
        </div>
        <div class="progress" id="progress">
          <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
          </div>
          <div class="progress-text" id="progressText">0 / 0</div>
        </div>
        <button type="submit" class="btn" id="importSubmitBtn">Importar Números</button>
        <div id="importMsg"></div>
      </form>
    </div>
  </div>

  <!-- Sección Plantillas Meta / WhatsApp (rediseño V1) -->
  <div class="card card-large wa-section-full" id="whatsAppTemplatesSection" style="display: none;">
    <div class="wa-layout">
      <!-- Columna formulario -->
      <section class="wa-form-column">
        <div class="wa-page-header">
          <h2 class="wa-title">Plantillas de mensaje Meta / WhatsApp</h2>
          <p class="wa-subtitle">Crea plantillas para WhatsApp Business (Graph API). Valida el JSON, previsualiza cómo se verá en WhatsApp y obtén el ID para verificar si Meta la aprobó.</p>
        </div>

        <div class="wa-card">
          <div class="wa-card-header">
            <span class="material-icons-outlined wa-card-icon">vpn_key</span>
            <span>Credenciales Meta</span>
          </div>
          <div class="wa-grid-2">
            <div class="wa-field">
              <label class="wa-label" for="waWabaId">WABA ID (W.A Business Account ID) *</label>
              <input type="text" id="waWabaId" class="wa-input" placeholder="1911774739699629" />
            </div>
            <div class="wa-field">
              <label class="wa-label" for="waAccessToken">Access Token *</label>
              <input type="password" id="waAccessToken" class="wa-input" placeholder="Bearer token de Meta" />
            </div>
          </div>
          <div class="wa-field" style="margin-top: 0.75rem; display: flex; align-items: center; gap: 0.75rem;">
            <button type="button" class="wa-btn wa-btn-secondary wa-btn-small" id="waLoadAccountBtn">
              <span class="material-icons-outlined" style="font-size: 16px;">refresh</span>
              <span>Cargar datos de la cuenta</span>
            </button>
            <span id="waAccountStatus" class="wa-hint" style="text-transform:none;"></span>
          </div>
        </div>

        <div class="wa-card">
          <div class="wa-card-header">
            <span class="material-icons-outlined wa-card-icon">settings</span>
            <span>Configuración de Plantilla</span>
          </div>
          <div class="wa-fields">
            <div class="wa-field">
              <label class="wa-label" for="waTemplateName">Nombre de la plantilla *</label>
              <input type="text" id="waTemplateName" class="wa-input" placeholder="ej: 20h_p15_v4" maxlength="512" />
              <p class="wa-hint">Solo minúsculas, números y guión bajo (_). Sin espacios.</p>
            </div>
            <div class="wa-grid-2">
              <div class="wa-field">
                <label class="wa-label" for="waTemplateLanguage">Idioma *</label>
                <select id="waTemplateLanguage" class="wa-input">
                  <option value="es">Español (es)</option>
                  <option value="en">English (en)</option>
                  <option value="en_US">English US</option>
                  <option value="pt_BR">Português Brasil</option>
                  <option value="es_AR">Español Argentina</option>
                  <option value="es_MX">Español México</option>
                  <option value="fr">Français</option>
                  <option value="de">Deutsch</option>
                  <option value="it">Italiano</option>
                </select>
              </div>
              <div class="wa-field">
                <label class="wa-label" for="waTemplateCategory">Categoría *</label>
                <select id="waTemplateCategory" class="wa-input">
                  <option value="MARKETING">MARKETING</option>
                  <option value="UTILITY">UTILITY</option>
                  <option value="AUTHENTICATION">AUTHENTICATION</option>
                </select>
              </div>
            </div>
          </div>
        </div>

        <div class="wa-card">
          <div class="wa-card-header wa-card-header-between">
            <div class="wa-card-header">
              <span class="material-icons-outlined wa-card-icon">short_text</span>
              <span>Contenido del Mensaje</span>
            </div>
            <button type="button" class="wa-btn-insert-var" id="waInsertVar1" title="Insertar variable">Variable {{1}}</button>
          </div>
          <div class="wa-field">
            <label class="wa-label" for="waTemplateBody">Texto del mensaje *</label>
            <textarea id="waTemplateBody" class="wa-textarea" rows="6" placeholder="¡Hola {{1}}! Te escribimos para recordarte tu cita..."></textarea>
            <p class="wa-hint">Máx. 1024 caracteres. Variables: {{1}}, {{2}} o {{nombre}}. Saltos de línea permitidos.</p>
            <div id="waBodyValidation" class="wa-validation"></div>
          </div>
        </div>

        <div class="wa-card">
          <div class="wa-card-header">
            <span class="material-icons-outlined wa-card-icon">smart_button</span>
            <span>Botones Interactivos</span>
          </div>
          <div class="wa-buttons-rows">
            <div class="wa-button-row">
              <div class="wa-button-cell wa-button-type">
                <label class="wa-label-small">Tipo</label>
                <select class="wa-input wa-btn-type" data-btn="0">
                  <option value="">— Sin botón —</option>
                  <option value="URL">Visit Website</option>
                  <option value="QUICK_REPLY">Quick Reply</option>
                </select>
              </div>
              <div class="wa-button-cell">
                <label class="wa-label-small">Texto</label>
                <input type="text" class="wa-input wa-btn-text" data-btn="0" placeholder="Ver oferta" />
              </div>
              <div class="wa-button-cell wa-button-url">
                <label class="wa-label-small">URL</label>
                <input type="url" class="wa-input wa-btn-url" data-btn="0" placeholder="https://miweb.com" />
              </div>
            </div>
            <div class="wa-button-row">
              <div class="wa-button-cell wa-button-type">
                <label class="wa-label-small">Tipo</label>
                <select class="wa-input wa-btn-type" data-btn="1">
                  <option value="">— Sin botón —</option>
                  <option value="URL">Visit Website</option>
                  <option value="QUICK_REPLY">Quick Reply</option>
                </select>
              </div>
              <div class="wa-button-cell">
                <label class="wa-label-small">Texto</label>
                <input type="text" class="wa-input wa-btn-text" data-btn="1" placeholder="Texto del botón" />
              </div>
              <div class="wa-button-cell wa-button-url">
                <label class="wa-label-small">URL</label>
                <input type="url" class="wa-input wa-btn-url" data-btn="1" placeholder="https://..." />
              </div>
            </div>
            <div class="wa-button-row">
              <div class="wa-button-cell wa-button-type">
                <label class="wa-label-small">Tipo</label>
                <select class="wa-input wa-btn-type" data-btn="2">
                  <option value="">— Sin botón —</option>
                  <option value="URL">Visit Website</option>
                  <option value="QUICK_REPLY">Quick Reply</option>
                </select>
              </div>
              <div class="wa-button-cell">
                <label class="wa-label-small">Texto</label>
                <input type="text" class="wa-input wa-btn-text" data-btn="2" placeholder="Texto del botón" />
              </div>
              <div class="wa-button-cell wa-button-url">
                <label class="wa-label-small">URL</label>
                <input type="url" class="wa-input wa-btn-url" data-btn="2" placeholder="https://..." />
              </div>
            </div>
          </div>
        </div>

        <div class="wa-actions">
          <button type="button" class="wa-btn wa-btn-primary" id="waCreateTemplateBtn">Crear Plantilla</button>
          <button type="button" class="wa-btn wa-btn-secondary wa-btn-small" id="waDownloadTemplateJsonBtn">Descargar JSON</button>
          <div id="waTemplateMsg" class="wa-msg"></div>
          <div id="waTemplateIdResult" class="wa-id-result" style="display: none;">
            <strong>ID de plantilla:</strong> <code id="waTemplateIdValue"></code>
            <p class="wa-id-hint">Usa este ID para verificar si Meta la aprobó.</p>
          </div>
        </div>

        <div class="wa-card">
          <div class="wa-card-header">
            <span class="material-icons-outlined wa-card-icon">info</span>
            <span>Verificar estado de una plantilla</span>
          </div>
          <div class="wa-field">
            <label class="wa-label" for="waVerifyTemplateId">ID de plantilla</label>
            <input type="text" id="waVerifyTemplateId" class="wa-input" placeholder="1212760374170689" />
          </div>
          <button type="button" class="wa-btn wa-btn-primary" id="waVerifyBtn">Verificar estado</button>
          <div id="waVerifyResult" class="wa-verify-result"></div>
        </div>

        <div class="wa-card">
          <div class="wa-card-header">
            <span class="material-icons-outlined wa-card-icon">send</span>
            <span>Enviar mensaje con plantilla</span>
          </div>
          <div class="wa-field">
            <label class="wa-label" for="waPhoneNumberId">Phone Number ID *</label>
            <select id="waPhoneNumberId" class="wa-input">
              <option value="">Selecciona un número disponible...</option>
            </select>
            <p class="wa-hint">Números obtenidos desde el WABA. Se usa en el endpoint /PHONE_NUMBER_ID/messages.</p>
          </div>
          <div class="wa-field">
            <label class="wa-label" for="waSendTo">Destino (número del cliente) *</label>
            <input type="text" id="waSendTo" class="wa-input" placeholder="+5491122334455" />
            <p class="wa-hint">Debe estar en formato internacional. Si no comienza con +, se le añadirá automáticamente.</p>
          </div>
          <div class="wa-field">
            <label class="wa-label" for="waTemplatePicker">Plantilla a usar</label>
            <select id="waTemplatePicker" class="wa-input">
              <option value="">— Selecciona una plantilla cargada desde Meta —</option>
            </select>
            <p class="wa-hint" style="text-transform:none;">Al elegir una plantilla se rellenan automáticamente el nombre y el idioma configurados arriba. Asegúrate de que la plantilla exista y esté aprobada.</p>
          </div>
          <button type="button" class="wa-btn wa-btn-primary" id="waSendTemplateBtn">Enviar mensaje</button>
          <div id="waSendResult" class="wa-verify-result"></div>
          <div class="wa-field" id="waSelectedTemplatePreview" style="margin-top: 1rem; display: none;">
            <label class="wa-label">Plantilla seleccionada desde Meta</label>
            <div class="wa-phone-bubble" style="margin-bottom: 0.5rem;">
              <p id="waSelectedTemplateBodyText" style="margin: 0; white-space: pre-wrap;"></p>
            </div>
            <div id="waSelectedTemplateButtonsWrapper" style="display:none;">
              <p class="wa-hint" style="margin: 0 0 0.25rem;">Botones de la plantilla:</p>
              <div id="waSelectedTemplateButtons" class="wa-phone-buttons"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- Columna preview (mockup WhatsApp) -->
      <aside class="wa-preview-column">
        <div class="wa-preview-pattern"></div>
        <div class="wa-preview-inner">
          <div class="wa-preview-header">
            <span class="material-icons-outlined">visibility</span>
            <span>Previsualización en Tiempo Real</span>
          </div>
          <div class="wa-phone-mockup">
            <div class="wa-phone-header">
              <span class="material-icons-outlined">arrow_back</span>
              <div class="wa-phone-avatar"></div>
              <div class="wa-phone-contact">
                <span class="wa-phone-name">uMindsAI</span>
                <span class="wa-phone-status">En línea</span>
              </div>
              <span class="material-icons-outlined wa-phone-icon">videocam</span>
              <span class="material-icons-outlined wa-phone-icon">call</span>
              <span class="material-icons-outlined wa-phone-icon">more_vert</span>
            </div>
            <div class="wa-phone-chat">
              <div class="wa-phone-date">Hoy</div>
              <div class="wa-phone-bubble-wrap">
                <div id="waPreviewBubble" class="wa-phone-bubble"></div>
                <div id="waPreviewButtons" class="wa-phone-buttons"></div>
              </div>
            </div>
            <div class="wa-phone-footer">
              <span class="material-icons-outlined">sentiment_satisfied_alt</span>
              <span class="material-icons-outlined">attach_file</span>
              <div class="wa-phone-input"></div>
              <div class="wa-phone-send"><span class="material-icons-outlined">mic</span></div>
            </div>
          </div>
          <p class="wa-preview-note">Los campos dinámicos se mostrarán como texto real en el dispositivo del destinatario.</p>
        </div>
      </aside>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const API = window.location.origin;
    const zone = document.getElementById('zone');
    const fileInput = document.getElementById('file');
    const fileName = document.getElementById('fileName');
    const clean = document.getElementById('clean');
    const btn = document.getElementById('btn');
    const msg = document.getElementById('msg');
    const resumen = document.getElementById('resumen');
    const resumenList = document.getElementById('resumenList');
    const links = document.getElementById('links');
    const importBtn = document.getElementById('importBtn');
    const importModal = document.getElementById('importModal');
    const closeModal = document.getElementById('closeModal');
    const importForm = document.getElementById('importForm');
    const importMsg = document.getElementById('importMsg');
    const progress = document.getElementById('progress');
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    const importSubmitBtn = document.getElementById('importSubmitBtn');

    let selected = null;
    let currentOutputId = null;
    /** Números extraídos del último CSV procesado (para importar sin import-stream en Netlify) */
    let lastProcessedPhoneNumbers = [];

    zone.addEventListener('click', () => fileInput.click());
    zone.addEventListener('dragover', (e) => { e.preventDefault(); zone.classList.add('dragover'); });
    zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
    zone.addEventListener('drop', (e) => {
      e.preventDefault();
      zone.classList.remove('dragover');
      const f = e.dataTransfer?.files?.[0];
      if (f && /\.csv$/i.test(f.name)) setFile(f);
    });
    fileInput.addEventListener('change', () => { const f = fileInput.files?.[0]; if (f) setFile(f); });

    function setFile(f) {
      selected = f;
      fileName.textContent = f.name;
      btn.disabled = false;
      msg.textContent = '';
      resumen.style.display = 'none';
    }

    btn.addEventListener('click', async () => {
      if (!selected) return;
      btn.disabled = true;
      msg.textContent = 'Procesando…';
      msg.className = 'msg';
      resumen.style.display = 'none';

      try {
        const csvText = await selected.text();

        const r = await fetch(API + '/api/process', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            csvContent: csvText,
            clean: !!clean.checked,
          }),
        });

        const data = await r.json();
        if (!r.ok) throw new Error(data.error || 'Error en el servidor');

        msg.textContent = `Listo. ${data.valid} válidos.`;
        if (data.errors?.length) msg.textContent += ` ${data.errors.length} rechazados.`;
        msg.className = 'msg ok';

        resumenList.innerHTML = '';
        for (const [pais, n] of Object.entries(data.resumen || {})) {
          const li = document.createElement('li');
          li.textContent = `${pais}: ${n}`;
          resumenList.appendChild(li);
        }

        links.innerHTML = '';
        const fileLabels = {
          resumen: 'Resumen por País',
          numeros: 'Números Generados',
          batch_calling: 'Números Batch Calling',
          datos_limpios: 'Datos Limpios',
        };

        for (const [label, fileInfo] of Object.entries(data.files || {})) {
          if (!fileInfo || !fileInfo.content) continue;
          const blob = new Blob([fileInfo.content], { type: 'text/csv' });
          const url = URL.createObjectURL(blob);

          const a = document.createElement('a');
          a.href = url;
          a.download = fileInfo.filename || (label + '.csv');
          const displayLabel = fileLabels[label] || a.download;
          a.textContent = `Descargar ${displayLabel}`;
          links.appendChild(a);
        }

        resumen.style.display = 'block';
        
        currentOutputId = data.outputId;
        lastProcessedPhoneNumbers = [];
        if (data.files && data.files.numeros && data.files.numeros.content) {
          const content = data.files.numeros.content;
          const lines = content.split(/\r?\n/).filter(l => l.trim());
          for (let i = 1; i < lines.length; i++) {
            const m = lines[i].match(/^[^,]+,"([^"]+)"/);
            if (m) {
              const nums = m[1].split(/,\s*/).map(n => n.trim()).filter(n => n);
              lastProcessedPhoneNumbers.push(...nums.map(n => n.startsWith('+') ? n : '+' + n));
            }
          }
          lastProcessedPhoneNumbers = [...new Set(lastProcessedPhoneNumbers)];
        }
        if (lastProcessedPhoneNumbers.length > 0) {
          importBtn.style.display = 'block';
          const processedOption = directNumberSource.querySelector('option[value="processed"]');
          if (processedOption) {
            processedOption.textContent = 'Usar números procesados (disponible)';
          }
        }
      } catch (e) {
        msg.textContent = e.message || 'Error al procesar';
        msg.className = 'msg error';
      } finally {
        btn.disabled = false;
      }
    });

    // Modal de importación
    importBtn.addEventListener('click', () => {
      importModal.classList.add('active');
    });

    closeModal.addEventListener('click', () => {
      importModal.classList.remove('active');
      importForm.reset();
      importMsg.textContent = '';
      progress.classList.remove('active');
      csvUploadGroup.style.display = 'none';
      manualNumbersGroup.style.display = 'none';
    });

    importModal.addEventListener('click', (e) => {
      if (e.target === importModal) {
        importModal.classList.remove('active');
        importForm.reset();
        importMsg.textContent = '';
        progress.classList.remove('active');
        csvUploadGroup.style.display = 'none';
        manualNumbersGroup.style.display = 'none';
      }
    });

    importForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const source = numberSource.value;
      let phoneNumbers = [];

      // Obtener números según la fuente seleccionada
      if (source === 'processed') {
        if (!lastProcessedPhoneNumbers || lastProcessedPhoneNumbers.length === 0) {
          importMsg.textContent = 'Error: No hay números procesados. Procesa un CSV primero o selecciona otra fuente.';
          importMsg.className = 'msg error';
          return;
        }
        phoneNumbers = lastProcessedPhoneNumbers;
      } else if (source === 'csv') {
        const file = csvFile.files[0];
        if (!file) {
          importMsg.textContent = 'Error: Debes seleccionar un archivo CSV';
          importMsg.className = 'msg error';
          return;
        }
        // Leer el CSV y extraer números
        try {
          const text = await file.text();
          phoneNumbers = extractNumbersFromCSV(text);
          if (phoneNumbers.length === 0) {
            importMsg.textContent = 'Error: No se encontraron números válidos en el CSV';
            importMsg.className = 'msg error';
            return;
          }
        } catch (error) {
          importMsg.textContent = 'Error al leer el archivo CSV: ' + error.message;
          importMsg.className = 'msg error';
          return;
        }
      } else if (source === 'manual') {
        const numbersText = manualNumbers.value.trim();
        if (!numbersText) {
          importMsg.textContent = 'Error: Debes ingresar al menos un número';
          importMsg.className = 'msg error';
          return;
        }
        
        // Procesar números: pueden estar separados por líneas (\n) o por comas (,)
        phoneNumbers = numbersText
          .split(/[\n,]+/) // Dividir por líneas o comas
          .map(line => line.trim())
          .filter(line => line.length > 0)
          .map(num => {
            // Remover espacios y caracteres no numéricos excepto el +
            let cleaned = num.replace(/\s/g, '');
            // Si no empieza con +, agregarlo
            if (!cleaned.startsWith('+')) {
              cleaned = '+' + cleaned;
            }
            return cleaned;
          })
          .filter(num => /^\+\d{8,15}$/.test(num));
        
        if (phoneNumbers.length === 0) {
          importMsg.textContent = 'Error: No se encontraron números válidos. Puedes ingresarlos separados por líneas o comas (ej: 5493415960906, 5492232105153)';
          importMsg.className = 'msg error';
          return;
        }
      }

      const formData = {
        source: source,
        outputId: source === 'processed' ? currentOutputId : null,
        phoneNumbers: phoneNumbers,
        apiKey: document.getElementById('apiKey').value,
        terminationUri: document.getElementById('terminationUri').value,
        outboundTransport: document.getElementById('outboundTransport').value,
        outboundAgentId: document.getElementById('outboundAgentId').value,
        sipTrunkUsername: document.getElementById('sipTrunkUsername').value,
        sipTrunkPassword: document.getElementById('sipTrunkPassword').value,
        nickname: document.getElementById('nickname').value,
      };

      importSubmitBtn.disabled = true;
      importMsg.textContent = '';
      progress.classList.add('active');
      progressFill.style.width = '0%';
      progressText.textContent = 'Iniciando importación...';

      let totalNumbers = 0;
      let importedCount = 0;
      let failedCount = 0;
      const failedNumbers = [];

      // Función para extraer números de CSV
      function extractNumbersFromCSV(csvText) {
        const lines = csvText.split('\n').filter(line => line.trim());
        const numbers = [];
        
        for (const line of lines) {
          // Buscar números que empiecen con + o números de 8-15 dígitos
          const matches = line.match(/(\+?\d{8,15})/g);
          if (matches) {
            numbers.push(...matches.map(num => num.startsWith('+') ? num : `+${num}`));
          }
        }
        
        // Eliminar duplicados
        return [...new Set(numbers)];
      }

      // Función para manejar eventos de progreso
      function handleProgressEvent(data) {
        if (data.type === 'start' || data.event === 'start') {
          totalNumbers = data.total;
          progressText.textContent = `0 / ${totalNumbers}`;
        } else if (data.type === 'progress' || data.event === 'progress') {
          importedCount = data.imported;
          failedCount = data.failed;
          const current = data.current;
          const total = data.total;
          
          // Actualizar barra de progreso
          const percentage = (current / total) * 100;
          progressFill.style.width = `${percentage}%`;
          progressText.textContent = `${current} / ${total} (${importedCount} exitosos, ${failedCount} fallidos)`;
          
          // Guardar números fallidos
          if (!data.success && data.error) {
            failedNumbers.push({ phoneNumber: data.phoneNumber, error: data.error });
          }
        } else if (data.type === 'complete' || data.event === 'complete') {
          progressFill.style.width = '100%';
          progressText.textContent = `${data.total} / ${data.total}`;
          
          importMsg.textContent = `Importación completada: ${data.imported} exitosos, ${data.failed} fallidos`;
          importMsg.className = 'msg ok';

          if (data.failed > 0 && failedNumbers.length > 0) {
            const errorDetails = failedNumbers.slice(0, 10).map(r => 
              `${r.phoneNumber}: ${r.error}`
            ).join('\n');
            importMsg.textContent += `\n\nErrores (primeros 10):\n${errorDetails}`;
          }

          importSubmitBtn.disabled = false;

          if (data.failed === 0) {
            setTimeout(() => {
              importModal.classList.remove('active');
              importForm.reset();
              progress.classList.remove('active');
              csvUploadGroup.style.display = 'none';
              manualNumbersGroup.style.display = 'none';
            }, 5000);
          }
        }
      }

      try {
        importMsg.textContent = 'Importando números...';
        importMsg.className = 'msg';
        progress.classList.add('active');
        progressText.textContent = `0 / ${formData.phoneNumbers.length}`;

        const response = await fetch(API + '/api/retell/import-direct', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            phoneNumbers: formData.phoneNumbers,
            apiKey: formData.apiKey,
            terminationUri: formData.terminationUri,
            outboundTransport: formData.outboundTransport,
            outboundAgentId: formData.outboundAgentId,
            sipTrunkUsername: formData.sipTrunkUsername || '',
            sipTrunkPassword: formData.sipTrunkPassword || '',
            nickname: formData.nickname || '',
          }),
        });

        const data = await response.json();
        if (!response.ok) throw new Error(data.error || 'Error al importar');

        handleProgressEvent({ type: 'complete', event: 'complete', ...data });
      } catch (error) {
        importMsg.textContent = error.message || 'Error al importar números';
        importMsg.className = 'msg error';
        progress.classList.remove('active');
        importSubmitBtn.disabled = false;
      }
    });

    // ===== SECCIÓN DE IMPORTACIÓN DIRECTA / NAVEGACIÓN DE TABS =====
    const processSection = document.getElementById('processSection');
    const importSection = document.getElementById('importSection');
    const batchCallSection = document.getElementById('batchCallSection');
    const manageSection = document.getElementById('manageSection');
    const compareSection = document.getElementById('compareSection');
    const whatsAppTemplatesSection = document.getElementById('whatsAppTemplatesSection');

    const tabProcess = document.getElementById('tabProcess');
    const tabImport = document.getElementById('tabImport');
    const tabBatchCall = document.getElementById('tabBatchCall');
    const tabManage = document.getElementById('tabManage');
    const tabCompare = document.getElementById('tabCompare');
    const tabWhatsAppTemplates = document.getElementById('tabWhatsAppTemplates');
    const proxyLinkSection = document.getElementById('proxyLinkSection');
    const tabProxyLink = document.getElementById('tabProxyLink');

    const directImportForm = document.getElementById('directImportForm');
    const directNumberSource = document.getElementById('directNumberSource');
    const directCsvUploadGroup = document.getElementById('directCsvUploadGroup');
    const directManualNumbersGroup = document.getElementById('directManualNumbersGroup');
    const directProcessedGroup = document.getElementById('directProcessedGroup');
    const directCsvFile = document.getElementById('directCsvFile');
    const directManualNumbers = document.getElementById('directManualNumbers');
    const directProgress = document.getElementById('directProgress');
    const directProgressFill = document.getElementById('directProgressFill');
    const directProgressText = document.getElementById('directProgressText');
    const directImportSubmitBtn = document.getElementById('directImportSubmitBtn');
    const directImportMsg = document.getElementById('directImportMsg');

    // Helper para activar pestañas y sincronizar con la URL
    function setActiveTab(tab) {
      // Reset secciones
      processSection.style.display = 'none';
      importSection.style.display = 'none';
      batchCallSection.style.display = 'none';
      manageSection.style.display = 'none';
      compareSection.style.display = 'none';
      if (whatsAppTemplatesSection) whatsAppTemplatesSection.style.display = 'none';
      if (proxyLinkSection) proxyLinkSection.style.display = 'none';

      // Reset clases de tabs
      tabProcess.classList.remove('active');
      tabImport.classList.remove('active');
      tabBatchCall.classList.remove('active');
      tabManage.classList.remove('active');
      tabCompare.classList.remove('active');
      if (tabWhatsAppTemplates) tabWhatsAppTemplates.classList.remove('active');
      if (tabProxyLink) tabProxyLink.classList.remove('active');

      let path = '/procesar-csv';

      if (tab === 'process') {
        processSection.style.display = 'block';
        tabProcess.classList.add('active');
        path = '/procesar-csv';
      } else if (tab === 'import') {
        importSection.style.display = 'block';
        tabImport.classList.add('active');
        path = '/importar-retell';
      } else if (tab === 'batch') {
        batchCallSection.style.display = 'block';
        tabBatchCall.classList.add('active');
        path = '/batch-calling';
      } else if (tab === 'manage') {
        manageSection.style.display = 'block';
        tabManage.classList.add('active');
        path = '/gestionar-numeros';
      } else if (tab === 'compare') {
        compareSection.style.display = 'block';
        tabCompare.classList.add('active');
        path = '/comparar-listas';
      } else if (tab === 'whatsapp') {
        if (whatsAppTemplatesSection) whatsAppTemplatesSection.style.display = 'block';
        if (tabWhatsAppTemplates) tabWhatsAppTemplates.classList.add('active');
        path = '/plantillas-whatsapp';
      } else if (tab === 'proxy') {
        if (proxyLinkSection) proxyLinkSection.style.display = 'block';
        if (tabProxyLink) tabProxyLink.classList.add('active');
        path = '/proxy-link';
      }

      // Actualizar URL sin recargar la página
      if (window.location.pathname !== path) {
        window.history.pushState({ tab }, '', path);
      }
    }

    // Navegación entre tabs
    tabProcess.addEventListener('click', () => {
      setActiveTab('process');
    });

    tabImport.addEventListener('click', () => {
      setActiveTab('import');
    });

    tabManage.addEventListener('click', () => {
      setActiveTab('manage');
    });

    if (tabCompare && compareSection) {
      tabCompare.addEventListener('click', () => {
        setActiveTab('compare');
      });
    }
    if (tabWhatsAppTemplates) {
      tabWhatsAppTemplates.addEventListener('click', () => setActiveTab('whatsapp'));
    }
    if (tabProxyLink) {
      tabProxyLink.addEventListener('click', () => setActiveTab('proxy'));
    }

    // Seleccionar pestaña inicial según la URL
    function initTabFromPath() {
      const path = window.location.pathname || '/';
      if (path === '/' || path === '/procesar-csv') {
        setActiveTab('process');
      } else if (path === '/importar-retell') {
        setActiveTab('import');
      } else if (path === '/batch-calling') {
        setActiveTab('batch');
      } else if (path === '/gestionar-numeros') {
        setActiveTab('manage');
      } else if (path === '/comparar-listas') {
        setActiveTab('compare');
      } else if (path === '/plantillas-whatsapp') {
        setActiveTab('whatsapp');
      } else if (path === '/proxy-link') {
        setActiveTab('proxy');
      } else {
        // Cualquier otra ruta desconocida cae en Procesar CSV
        setActiveTab('process');
      }
    }

    // Manejar navegación con atrás/adelante del navegador
    window.addEventListener('popstate', () => {
      initTabFromPath();
    });

    // Inicializar al cargar
    initTabFromPath();

    // Manejar cambio de fuente de números en importación directa
    directNumberSource.addEventListener('change', (e) => {
      const source = e.target.value;
      directCsvUploadGroup.style.display = source === 'csv' ? 'block' : 'none';
      directManualNumbersGroup.style.display = source === 'manual' ? 'block' : 'none';
      directProcessedGroup.style.display = source === 'processed' ? 'block' : 'none';
      
      directCsvFile.required = source === 'csv';
      directManualNumbers.required = source === 'manual';
    });

    // Función para extraer números de CSV (compartida)
    function extractNumbersFromCSV(csvText) {
      const lines = csvText.split('\n').filter(line => line.trim());
      const numbers = [];
      
      for (const line of lines) {
        const matches = line.match(/(\+?\d{8,15})/g);
        if (matches) {
          numbers.push(...matches.map(num => num.startsWith('+') ? num : `+${num}`));
        }
      }
      
      return [...new Set(numbers)];
    }

    // Formulario de importación directa
    directImportForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const source = directNumberSource.value;
      let phoneNumbers = [];

      if (source === 'processed') {
        if (!lastProcessedPhoneNumbers || lastProcessedPhoneNumbers.length === 0) {
          directImportMsg.textContent = 'Error: No hay números procesados. Procesa un CSV primero en la pestaña "Procesar CSV".';
          directImportMsg.className = 'msg error';
          return;
        }
        phoneNumbers = lastProcessedPhoneNumbers;
      } else if (source === 'csv') {
        const file = directCsvFile.files[0];
        if (!file) {
          directImportMsg.textContent = 'Error: Debes seleccionar un archivo CSV';
          directImportMsg.className = 'msg error';
          return;
        }
        try {
          const text = await file.text();
          phoneNumbers = extractNumbersFromCSV(text);
          if (phoneNumbers.length === 0) {
            directImportMsg.textContent = 'Error: No se encontraron números válidos en el CSV';
            directImportMsg.className = 'msg error';
            return;
          }
        } catch (error) {
          directImportMsg.textContent = 'Error al leer el archivo CSV: ' + error.message;
          directImportMsg.className = 'msg error';
          return;
        }
      } else if (source === 'manual') {
        const numbersText = directManualNumbers.value.trim();
        if (!numbersText) {
          directImportMsg.textContent = 'Error: Debes ingresar al menos un número';
          directImportMsg.className = 'msg error';
          return;
        }
        
        // Procesar números: pueden estar separados por líneas (\n) o por comas (,)
        phoneNumbers = numbersText
          .split(/[\n,]+/) // Dividir por líneas o comas
          .map(line => line.trim())
          .filter(line => line.length > 0)
          .map(num => {
            // Remover espacios y caracteres no numéricos excepto el +
            let cleaned = num.replace(/\s/g, '');
            // Si no empieza con +, agregarlo
            if (!cleaned.startsWith('+')) {
              cleaned = '+' + cleaned;
            }
            return cleaned;
          })
          .filter(num => /^\+\d{8,15}$/.test(num));
        
        if (phoneNumbers.length === 0) {
          directImportMsg.textContent = 'Error: No se encontraron números válidos. Puedes ingresarlos separados por líneas o comas (ej: 5493415960906, 5492232105153)';
          directImportMsg.className = 'msg error';
          return;
        }
      }

      const formData = {
        source: source,
        outputId: source === 'processed' ? currentOutputId : null,
        phoneNumbers: phoneNumbers,
        apiKey: document.getElementById('directApiKey').value,
        terminationUri: document.getElementById('directTerminationUri').value,
        outboundTransport: document.getElementById('directOutboundTransport').value,
        outboundAgentId: document.getElementById('directOutboundAgentId').value,
        sipTrunkUsername: document.getElementById('directSipTrunkUsername').value,
        sipTrunkPassword: document.getElementById('directSipTrunkPassword').value,
        nickname: document.getElementById('directNickname').value,
      };

      directImportSubmitBtn.disabled = true;
      directImportMsg.textContent = '';
      directProgress.classList.add('active');
      directProgressFill.style.width = '0%';
      directProgressText.textContent = 'Iniciando importación...';

      let totalNumbers = 0;
      let importedCount = 0;
      let failedCount = 0;
      const failedNumbers = [];

      function handleDirectProgressEvent(data) {
        if (data.type === 'start' || data.event === 'start') {
          totalNumbers = data.total;
          directProgressText.textContent = `0 / ${totalNumbers}`;
        } else if (data.type === 'progress' || data.event === 'progress') {
          importedCount = data.imported;
          failedCount = data.failed;
          const current = data.current;
          const total = data.total;
          
          const percentage = (current / total) * 100;
          directProgressFill.style.width = `${percentage}%`;
          directProgressText.textContent = `${current} / ${total} (${importedCount} exitosos, ${failedCount} fallidos)`;
          
          if (!data.success && data.error) {
            failedNumbers.push({ phoneNumber: data.phoneNumber, error: data.error });
          }
        } else if (data.type === 'complete' || data.event === 'complete') {
          directProgressFill.style.width = '100%';
          directProgressText.textContent = `${data.total} / ${data.total}`;
          
          directImportMsg.textContent = `Importación completada: ${data.imported} exitosos, ${data.failed} fallidos`;
          directImportMsg.className = 'msg ok';

          if (data.failed > 0 && failedNumbers.length > 0) {
            const errorDetails = failedNumbers.slice(0, 10).map(r => 
              `${r.phoneNumber}: ${r.error}`
            ).join('\n');
            directImportMsg.textContent += `\n\nErrores (primeros 10):\n${errorDetails}`;
          }

          directImportSubmitBtn.disabled = false;
        }
      }

      try {
        directProgressText.textContent = `0 / ${formData.phoneNumbers.length}`;

        const response = await fetch(API + '/api/retell/import-direct', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            phoneNumbers: formData.phoneNumbers,
            apiKey: formData.apiKey,
            terminationUri: formData.terminationUri,
            outboundTransport: formData.outboundTransport,
            outboundAgentId: formData.outboundAgentId,
            sipTrunkUsername: formData.sipTrunkUsername || '',
            sipTrunkPassword: formData.sipTrunkPassword || '',
            nickname: formData.nickname || '',
          }),
        });

        const data = await response.json();
        if (!response.ok) throw new Error(data.error || 'Error al importar');

        handleDirectProgressEvent({ type: 'complete', event: 'complete', ...data });
      } catch (error) {
        directImportMsg.textContent = error.message || 'Error al importar números';
        directImportMsg.className = 'msg error';
        directProgress.classList.remove('active');
        directImportSubmitBtn.disabled = false;
      }
    });

    // ===== SECCIÓN DE BATCH CALLING =====
    const batchCallCountInput = document.getElementById('batchCallCount');
    const batchCallDeployBtn = document.getElementById('batchCallDeployBtn');
    const batchCallSlotsContainer = document.getElementById('batchCallSlotsContainer');

    // Navegación a Batch Calling
    tabBatchCall.addEventListener('click', () => {
      setActiveTab('batch');
    });

    // Devuelve el HTML de un formulario completo para un slot (Batch Call #n)
    function getBatchSlotFormHTML(slotNum) {
      return `
        <div class="batch-call-slot" style="margin-bottom: 2rem; padding: 1.25rem; background: var(--bg); border: 1px solid var(--border); border-radius: 8px;">
          <h3 style="font-size: 1.1rem; margin: 0 0 1rem 0; padding-bottom: 0.5rem; border-bottom: 1px solid var(--border);">Batch Call #${slotNum}</h3>
          <div class="form-group">
            <label>Archivo CSV con contactos *</label>
            <div class="zone batch-slot-zone" style="padding: 1rem;">
              <input type="file" class="batch-slot-csv" accept=".csv" />
              <p>Arrastra aquí un CSV o haz clic para elegir</p>
              <p class="file-name batch-slot-file-name"></p>
            </div>
            <small style="color: var(--muted); font-size: 0.85rem; display: block; margin-top: 0.25rem;">Columna "phone_number" o "PhoneNumber". Otras columnas = variables.</small>
          </div>
          <div class="batch-slot-preview" style="display: none; margin-top: 1rem; padding: 1rem; background: var(--bg); border-radius: 6px; border: 1px solid var(--border);">
            <h4 style="font-size: 0.95rem; margin: 0 0 0.5rem 0;">Preview del CSV</h4>
            <div class="batch-slot-preview-content" style="font-size: 0.85rem; font-family: monospace; max-height: 180px; overflow-y: auto;"></div>
          </div>
          <div class="form-group" style="margin-top: 1rem;">
            <label>Agent ID (opcional)</label>
            <input type="text" class="batch-slot-agent-id" placeholder="agent_5c8cb6c7ba9eeff5857d7bdf1b" value="agent_5c8cb6c7ba9eeff5857d7bdf1b" />
          </div>
          <div class="form-group">
            <label>API Key de Retell AI *</label>
            <input type="password" class="batch-slot-api-key" placeholder="Ingresa tu API Key" />
          </div>
          <div class="form-group">
            <label>Número origen (from_number)</label>
            <select class="batch-slot-from-number">
              <option value="">Selecciona un número disponible</option>
            </select>
            <small style="color: var(--muted); font-size: 0.85rem; display: block; margin-top: 0.25rem;">Se llena al ingresar API Key (blur).</small>
          </div>
          <div class="form-group">
            <label>Batch Name (opcional)</label>
            <input type="text" class="batch-slot-batch-name" placeholder="Auto-generate based on country" />
          </div>
          <div class="form-group">
            <label>Start Time (opcional)</label>
            <input type="datetime-local" class="batch-slot-start-time" />
          </div>
          <div class="form-group">
            <label>Reserved Concurrency (opcional)</label>
            <input type="number" class="batch-slot-reserved-concurrency" min="0" max="100" value="0" />
          </div>
          <div class="progress batch-slot-progress" style="margin-top: 1rem; display: none;">
            <div class="progress-bar"><div class="progress-fill" style="width: 0%;"></div></div>
            <div class="progress-text">0 / 0</div>
          </div>
          <div style="display: flex; gap: 0.75rem; margin-top: 1rem;">
            <button type="button" class="btn batch-slot-submit-btn">Create Batches</button>
          </div>
          <div class="batch-slot-msg" style="margin-top: 0.75rem; font-size: 0.9rem;"></div>
        </div>
      `;
    }

    // Desplegar N formularios completos
    batchCallDeployBtn.addEventListener('click', () => {
      const n = Math.max(1, Math.min(20, parseInt(batchCallCountInput.value, 10) || 1));
      batchCallCountInput.value = n;
      batchCallSlotsContainer.innerHTML = '';

      for (let i = 0; i < n; i++) {
        const slotNum = i + 1;
        const wrap = document.createElement('div');
        wrap.innerHTML = getBatchSlotFormHTML(slotNum);
        const card = wrap.firstElementChild;
        batchCallSlotsContainer.appendChild(card);

        // Estado por slot
        card._csvData = null;
        card._generatedNumbers = null;

        const zoneEl = card.querySelector('.batch-slot-zone');
        const csvInput = card.querySelector('.batch-slot-csv');
        const fileNameEl = card.querySelector('.batch-slot-file-name');
        const previewEl = card.querySelector('.batch-slot-preview');
        const previewContent = card.querySelector('.batch-slot-preview-content');
        const apiKeyInput = card.querySelector('.batch-slot-api-key');
        const fromNumberSelect = card.querySelector('.batch-slot-from-number');
        const msgEl = card.querySelector('.batch-slot-msg');
        const progressEl = card.querySelector('.batch-slot-progress');
        const progressFill = card.querySelector('.progress-fill');
        const progressText = card.querySelector('.progress-text');
        const submitBtn = card.querySelector('.batch-slot-submit-btn');
        // Procesar archivo CSV (validar + preview + nombre). Usado por change y por drop.
        async function processBatchSlotFile(file) {
          if (!file || !/\.csv$/i.test(file.name)) return;
          fileNameEl.textContent = file.name;
          msgEl.textContent = 'Validando CSV...';
          msgEl.className = 'msg';
          try {
            const text = await file.text();
            card._csvData = text;
            const response = await fetch(API + '/api/retell/validate-batch-csv', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ csvContent: text }),
            });
            const result = await response.json();
            if (result.success && result.preview && result.preview.length > 0) {
              const allKeys = new Set();
              result.preview.forEach(row => { Object.keys(row).forEach(k => allKeys.add(k)); });
              const headers = Array.from(allKeys);
              let html = '<table style="width:100%;font-size:0.8rem;border-collapse:collapse;"><thead><tr>';
              headers.forEach(h => { html += `<th style="padding:0.4rem;text-align:left;border-bottom:1px solid var(--border);background:var(--bg);">${h}</th>`; });
              html += '</tr></thead><tbody>';
              result.preview.forEach(row => {
                html += '<tr>';
                headers.forEach(h => {
                  const v = row[h] || '';
                  html += `<td style="padding:0.4rem;border-bottom:1px solid var(--border);">${String(v).substring(0, 25)}${String(v).length > 25 ? '...' : ''}</td>`;
                });
                html += '</tr>';
              });
              html += `</tbody></table><p style="margin-top:0.5rem;color:var(--muted);font-size:0.8rem;">Total: ${result.total} contactos</p>`;
              previewContent.innerHTML = html;
              previewEl.style.display = 'block';
              msgEl.textContent = 'CSV válido: ' + result.total + ' contactos';
              msgEl.className = 'msg ok';
            } else {
              msgEl.textContent = result.error || 'Error al validar CSV';
              msgEl.className = 'msg error';
              previewEl.style.display = 'none';
            }
          } catch (err) {
            msgEl.textContent = 'Error: ' + err.message;
            msgEl.className = 'msg error';
            previewEl.style.display = 'none';
          }
        }

        // Zona: clic abre el selector de archivos
        zoneEl.addEventListener('click', () => csvInput.click());
        zoneEl.addEventListener('dragover', (e) => { e.preventDefault(); zoneEl.classList.add('dragover'); });
        zoneEl.addEventListener('dragleave', () => zoneEl.classList.remove('dragover'));
        zoneEl.addEventListener('drop', (e) => {
          e.preventDefault();
          zoneEl.classList.remove('dragover');
          const f = e.dataTransfer?.files?.[0];
          if (f) processBatchSlotFile(f);
        });
        csvInput.addEventListener('change', (e) => {
          const file = e.target.files[0];
          if (file) processBatchSlotFile(file);
        });

        // API Key blur: cargar números
        apiKeyInput.addEventListener('blur', async () => {
          const apiKey = apiKeyInput.value.trim();
          if (!apiKey) return;
          try {
            const response = await fetch(API + '/api/retell/list?apiKey=' + encodeURIComponent(apiKey));
            const result = await response.json();
            if (result.success && result.phoneNumbers && result.phoneNumbers.length > 0) {
              card._generatedNumbers = result.phoneNumbers;
              fromNumberSelect.innerHTML = '<option value="">Selecciona un número disponible</option>';
              result.phoneNumbers.forEach((phone) => {
                const numRaw = phone.phone_number || phone.from_number || phone.number || phone;
                if (!numRaw) return;
                const num = String(numRaw).startsWith('+') ? String(numRaw) : '+' + numRaw;
                const label = phone.nickname ? num + ' — ' + phone.nickname : num;
                const opt = document.createElement('option');
                opt.value = num;
                opt.textContent = label;
                fromNumberSelect.appendChild(opt);
              });
            }
          } catch (err) { console.error(err); }
        });

        // Create Batches: enviar con los datos de este slot
        submitBtn.addEventListener('click', async () => {
          if (!card._csvData) {
            msgEl.textContent = 'Carga un CSV en este formulario antes de crear batches.';
            msgEl.className = 'msg error';
            return;
          }
          const agentId = card.querySelector('.batch-slot-agent-id').value.trim();
          const batchName = card.querySelector('.batch-slot-batch-name').value.trim();
          const startTime = card.querySelector('.batch-slot-start-time').value;
          const reservedConcurrency = card.querySelector('.batch-slot-reserved-concurrency').value;
          const body = {
            apiKey: apiKeyInput.value,
            csvContent: card._csvData,
          };
          if (agentId) body.agent_id = agentId;
          if (batchName) body.batch_name = batchName;
          if (startTime) body.start_time = new Date(startTime).toISOString();
          if (reservedConcurrency) body.reserved_concurrency = reservedConcurrency;
          if (card._generatedNumbers && card._generatedNumbers.length > 0) body.generatedNumbers = card._generatedNumbers;
          if (fromNumberSelect.value) body.from_number = fromNumberSelect.value;

          submitBtn.disabled = true;
          msgEl.textContent = '';
          msgEl.className = '';
          progressEl.style.display = 'block';
          progressFill.style.width = '0%';
          progressText.textContent = 'Creando batches...';

          try {
            const response = await fetch(API + '/api/retell/create-batch-call', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(body),
            });
            const result = await response.json();
            if (result.success) {
              progressFill.style.width = '100%';
              progressText.textContent = 'Completado';
              let html = '<div class="msg ok"><strong>Batches creados:</strong> ' + result.batches_created + '<br>Contactos: ' + result.total_contacts + '<br>';
              (result.results || []).forEach((r, idx) => {
                html += (idx + 1) + '. ' + (r.batch_name || r.from_number) + ': ' + r.total_calls + ' contactos (ID: ' + r.batch_call_id + ')<br>';
              });
              html += '</div>';
              msgEl.innerHTML = html;
            } else {
              msgEl.textContent = result.error || 'Error al crear batches';
              msgEl.className = 'msg error';
            }
          } catch (err) {
            msgEl.textContent = 'Error: ' + err.message;
            msgEl.className = 'msg error';
          } finally {
            submitBtn.disabled = false;
          }
        });
      }

      // Botón para limpiar y volver a elegir cantidad
      const cancelRow = document.createElement('div');
      cancelRow.style.marginTop = '1rem';
      cancelRow.innerHTML = '<button type="button" class="btn btn-secondary" id="batchCallSlotsCancelBtn">Limpiar y desplegar de nuevo</button>';
      batchCallSlotsContainer.appendChild(cancelRow);
      cancelRow.querySelector('#batchCallSlotsCancelBtn').addEventListener('click', () => {
        batchCallSlotsContainer.innerHTML = '';
      });
    });

    // ===== SECCIÓN PLANTILLAS WHATSAPP (META) =====
    const META_GRAPH = 'https://graph.facebook.com/v21.0';
    const waWabaId = document.getElementById('waWabaId');
    const waAccessToken = document.getElementById('waAccessToken');
    const waTemplateName = document.getElementById('waTemplateName');
    const waTemplateLanguage = document.getElementById('waTemplateLanguage');
    const waTemplateCategory = document.getElementById('waTemplateCategory');
    const waTemplateBody = document.getElementById('waTemplateBody');
    const waBodyValidation = document.getElementById('waBodyValidation');
    const waPreviewBubble = document.getElementById('waPreviewBubble');
    const waPreviewButtons = document.getElementById('waPreviewButtons');
    const waCreateTemplateBtn = document.getElementById('waCreateTemplateBtn');
    const waDownloadTemplateJsonBtn = document.getElementById('waDownloadTemplateJsonBtn');
    const waTemplateMsg = document.getElementById('waTemplateMsg');
    const waTemplateIdResult = document.getElementById('waTemplateIdResult');
    const waTemplateIdValue = document.getElementById('waTemplateIdValue');
    const waVerifyTemplateId = document.getElementById('waVerifyTemplateId');
    const waVerifyBtn = document.getElementById('waVerifyBtn');
    const waVerifyResult = document.getElementById('waVerifyResult');
    const waLoadAccountBtn = document.getElementById('waLoadAccountBtn');
    const waAccountStatus = document.getElementById('waAccountStatus');
    const waPhoneNumberId = document.getElementById('waPhoneNumberId');
    const waSendTo = document.getElementById('waSendTo');
    const waSendTemplateBtn = document.getElementById('waSendTemplateBtn');
    const waSendResult = document.getElementById('waSendResult');
    const waTemplatePicker = document.getElementById('waTemplatePicker');
    const waSelectedTemplatePreview = document.getElementById('waSelectedTemplatePreview');
    const waSelectedTemplateBodyText = document.getElementById('waSelectedTemplateBodyText');
    const waSelectedTemplateButtonsWrapper = document.getElementById('waSelectedTemplateButtonsWrapper');
    const waSelectedTemplateButtons = document.getElementById('waSelectedTemplateButtons');

    // ===== SECCIÓN PROXYLINK =====
    const proxySupabaseUrlInput = document.getElementById('proxySupabaseUrl');
    const proxySupabaseKeyInput = document.getElementById('proxySupabaseKey');
    const proxyConnectBtn = document.getElementById('proxyConnectBtn');
    const proxyStatus = document.getElementById('proxyStatus');
    const proxyCreateForm = document.getElementById('proxyCreateForm');
    const proxyLabelInput = document.getElementById('proxyLabel');
    const proxyRedirectUrlInput = document.getElementById('proxyRedirectUrl');
    const proxyPostUrlInput = document.getElementById('proxyPostUrl');
    const proxyError = document.getElementById('proxyError');
    const proxyListLoading = document.getElementById('proxyListLoading');
    const proxyListEmpty = document.getElementById('proxyListEmpty');
    const proxyListContainer = document.getElementById('proxyListContainer');
    const proxyCredsManual = document.getElementById('proxyCredsManual');
    const proxyCredsCard = document.getElementById('proxyCredsCard');

    let proxySupabase = null;
    let proxyEnvConfig = null;
    function proxyGenerateSlug() {
      const chars = 'abcdefghijklmnopqrstuvwxyz0123456789';
      let out = '';
      for (let i = 0; i < 8; i++) {
        out += chars[Math.floor(Math.random() * chars.length)];
      }
      return out;
    }

    // Validación: nombre solo minúsculas, números y _
    function waValidateName(name) {
      if (!name || !name.trim()) return { ok: false, msg: 'El nombre es obligatorio.' };
      const n = name.trim();
      if (!/^[a-z0-9_]+$/.test(n)) return { ok: false, msg: 'Solo minúsculas, números y guión bajo (_). Sin espacios ni caracteres especiales.' };
      if (n.length > 512) return { ok: false, msg: 'Máximo 512 caracteres.' };
      return { ok: true, value: n };
    }
    // Validación: cuerpo máx 1024, variables {{1}}..{{n}} o {{nombre}}
    function waValidateBody(text) {
      if (!text || !text.trim()) return { ok: false, msg: 'El cuerpo (BODY) es obligatorio.' };
      const t = text.trim();
      if (t.length > 1024) return { ok: false, msg: 'Máximo 1024 caracteres en el cuerpo.' };
      const badVar = t.match(/\{\{[^}\s]+\}\}/g);
      if (badVar && badVar.some(v => !/^\{\{[a-zA-Z0-9_]+\}\}$/.test(v))) return { ok: false, msg: 'Variables deben ser {{1}}, {{2}} o {{nombre_valido}}.' };
      return { ok: true, value: t };
    }

    function waBuildComponents() {
      const bodyRes = waValidateBody(waTemplateBody && waTemplateBody.value);
      const components = [];
      if (bodyRes.ok) {
        components.push({ type: 'BODY', text: bodyRes.value });
      }
      const buttons = [];
      document.querySelectorAll('.wa-btn-type').forEach((sel, i) => {
        const type = sel.value;
        const textInp = document.querySelector('.wa-btn-text[data-btn="' + i + '"]');
        const urlInp = document.querySelector('.wa-btn-url[data-btn="' + i + '"]');
        if (type === 'QUICK_REPLY' && textInp && textInp.value.trim()) {
          buttons.push({ type: 'QUICK_REPLY', text: textInp.value.trim() });
        }
        if (type === 'URL' && textInp && textInp.value.trim() && urlInp && urlInp.value.trim()) {
          buttons.push({ type: 'URL', text: textInp.value.trim(), url: urlInp.value.trim() });
        }
      });
      if (buttons.length) components.push({ type: 'BUTTONS', buttons });
      return { bodyRes, components };
    }

    function waUpdatePreview() {
      if (!waTemplateBody || !waPreviewBubble) return;
      const text = waTemplateBody.value.trim() || 'El mensaje se verá aquí...';
      waPreviewBubble.textContent = text;
      if (!waPreviewButtons) return;
      waPreviewButtons.innerHTML = '';
      document.querySelectorAll('.wa-btn-type').forEach((sel, i) => {
        const type = sel.value;
        const textInp = document.querySelector('.wa-btn-text[data-btn="' + i + '"]');
        const urlInp = document.querySelector('.wa-btn-url[data-btn="' + i + '"]');
        if (type === 'QUICK_REPLY' && textInp && textInp.value.trim()) {
          const b = document.createElement('div');
          b.style.cssText = 'background: rgba(255,255,255,.12); color: #e9edef; padding: 0.4rem 0.6rem; border-radius: 6px; font-size: 0.85rem;';
          b.textContent = textInp.value.trim();
          waPreviewButtons.appendChild(b);
        }
        if (type === 'URL' && textInp && textInp.value.trim()) {
          const b = document.createElement('div');
          b.style.cssText = 'background: rgba(255,255,255,.12); color: #53bdeb; padding: 0.4rem 0.6rem; border-radius: 6px; font-size: 0.85rem;';
          b.textContent = (urlInp && urlInp.value.trim()) ? textInp.value.trim() + ' 🔗' : textInp.value.trim();
          waPreviewButtons.appendChild(b);
        }
      });
    }

    if (waTemplateBody) {
      waTemplateBody.addEventListener('input', () => {
        waUpdatePreview();
        const r = waValidateBody(waTemplateBody.value);
        if (waBodyValidation) waBodyValidation.textContent = r.ok ? '' : r.msg;
        if (waBodyValidation) waBodyValidation.style.color = r.ok ? '' : 'var(--error)';
      });
    }

    document.querySelectorAll('.wa-btn-type').forEach((sel) => {
      const i = sel.getAttribute('data-btn');
      const row = sel.closest('.wa-button-row');
      const textInp = document.querySelector('.wa-btn-text[data-btn="' + i + '"]');
      const urlInp = document.querySelector('.wa-btn-url[data-btn="' + i + '"]');
      const urlCell = row ? row.querySelector('.wa-button-url') : null;
      function toggle() {
        const type = sel.value;
        if (textInp) textInp.style.display = (type === 'URL' || type === 'QUICK_REPLY') ? 'block' : 'none';
        if (urlInp) urlInp.style.display = type === 'URL' ? 'block' : 'none';
        if (row) {
          if (type === '') row.classList.add('wa-hide-optional');
          else row.classList.remove('wa-hide-optional');
          if (urlCell) {
            if (type === 'URL') row.classList.remove('wa-hide-url');
            else row.classList.add('wa-hide-url');
          }
        }
        waUpdatePreview();
      }
      sel.addEventListener('change', toggle);
      toggle();
    });
    document.querySelectorAll('.wa-btn-text, .wa-btn-url').forEach((inp) => {
      inp.addEventListener('input', waUpdatePreview);
    });

    if (waCreateTemplateBtn) {
      waCreateTemplateBtn.addEventListener('click', async () => {
        const waba = waWabaId && waWabaId.value.trim();
        const token = waAccessToken && waAccessToken.value.trim();
        const nameRes = waValidateName(waTemplateName && waTemplateName.value);
        const { bodyRes, components } = waBuildComponents();
        if (!waba || !token) {
          waTemplateMsg.textContent = 'WABA ID y Access Token son obligatorios.';
          waTemplateMsg.className = 'msg error';
          return;
        }
        if (!nameRes.ok) {
          waTemplateMsg.textContent = nameRes.msg;
          waTemplateMsg.className = 'msg error';
          return;
        }
        if (!bodyRes.ok) {
          waTemplateMsg.textContent = bodyRes.msg;
          waTemplateMsg.className = 'msg error';
          return;
        }
        const body = {
          name: nameRes.value,
          language: (waTemplateLanguage && waTemplateLanguage.value) || 'es',
          category: (waTemplateCategory && waTemplateCategory.value) || 'MARKETING',
          components: components
        };
        waCreateTemplateBtn.disabled = true;
        waTemplateMsg.textContent = 'Creando plantilla...';
        waTemplateMsg.className = 'msg';
        waTemplateIdResult.style.display = 'none';
        try {
          const res = await fetch(META_GRAPH + '/' + encodeURIComponent(waba) + '/message_templates', {
            method: 'POST',
            headers: {
              'Authorization': 'Bearer ' + token,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(body)
          });
          const data = await res.json();
          if (data.id) {
            waTemplateMsg.textContent = 'Plantilla creada. Revisa el ID para verificar el estado de aprobación.';
            waTemplateMsg.className = 'msg ok';
            waTemplateIdValue.textContent = data.id;
            waTemplateIdResult.style.display = 'block';
          } else {
            waTemplateMsg.textContent = (data.error && data.error.message) || JSON.stringify(data);
            waTemplateMsg.className = 'msg error';
          }
        } catch (e) {
          waTemplateMsg.textContent = 'Error: ' + e.message;
          waTemplateMsg.className = 'msg error';
        }
        waCreateTemplateBtn.disabled = false;
      });
    }

    if (waDownloadTemplateJsonBtn) {
      waDownloadTemplateJsonBtn.addEventListener('click', () => {
        const nameRes = waValidateName(waTemplateName && waTemplateName.value);
        const { bodyRes, components } = waBuildComponents();
        if (!nameRes.ok) {
          waTemplateMsg.textContent = nameRes.msg;
          waTemplateMsg.className = 'msg error';
          return;
        }
        if (!bodyRes.ok) {
          waTemplateMsg.textContent = bodyRes.msg;
          waTemplateMsg.className = 'msg error';
          return;
        }
        const json = {
          name: nameRes.value,
          language: (waTemplateLanguage && waTemplateLanguage.value) || 'es',
          category: (waTemplateCategory && waTemplateCategory.value) || 'MARKETING',
          components,
        };
        const blob = new Blob([JSON.stringify(json, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${nameRes.value}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      });
    }

    if (waVerifyBtn && waVerifyTemplateId) {
      waVerifyBtn.addEventListener('click', async () => {
        const id = waVerifyTemplateId.value.trim();
        const token = waAccessToken && waAccessToken.value.trim();
        if (!id || !token) {
          waVerifyResult.textContent = 'Ingresa el ID de plantilla y el Access Token.';
          waVerifyResult.style.color = 'var(--error)';
          return;
        }
        waVerifyResult.textContent = 'Consultando...';
        waVerifyResult.style.color = '';
        try {
          const res = await fetch(META_GRAPH + '/' + encodeURIComponent(id) + '?fields=status,name,language,category', {
            headers: { 'Authorization': 'Bearer ' + token }
          });
          const data = await res.json();
          if (data.status !== undefined) {
            waVerifyResult.innerHTML = 'Estado: <strong>' + data.status + '</strong>' + (data.name ? ' — ' + data.name : '');
          } else {
            waVerifyResult.textContent = (data.error && data.error.message) || JSON.stringify(data);
            waVerifyResult.style.color = 'var(--error)';
          }
        } catch (e) {
          waVerifyResult.textContent = 'Error: ' + e.message;
          waVerifyResult.style.color = 'var(--error)';
        }
      });
    }

    tabWhatsAppTemplates && tabWhatsAppTemplates.addEventListener('click', () => waUpdatePreview());

    const waInsertVar1 = document.getElementById('waInsertVar1');
    if (waInsertVar1 && waTemplateBody) {
      waInsertVar1.addEventListener('click', () => {
        const ta = waTemplateBody;
        const start = ta.selectionStart;
        const end = ta.selectionEnd;
        const text = ta.value;
        const insert = '{{1}}';
        ta.value = text.slice(0, start) + insert + text.slice(end);
        ta.selectionStart = ta.selectionEnd = start + insert.length;
        ta.focus();
        waUpdatePreview();
      });
    }

    // Cargar números (phone_number_id) y plantillas desde el WABA
    async function waFetchMeta(path, token) {
      const url = META_GRAPH + '/' + path;
      const res = await fetch(url, {
        headers: { Authorization: 'Bearer ' + token },
      });
      const data = await res.json();
      if (!res.ok) {
        throw new Error((data.error && data.error.message) || JSON.stringify(data));
      }
      return data;
    }

    if (waLoadAccountBtn) {
      waLoadAccountBtn.addEventListener('click', async () => {
        const waba = waWabaId && waWabaId.value.trim();
        const token = waAccessToken && waAccessToken.value.trim();
        if (!waba || !token) {
          if (waAccountStatus) {
            waAccountStatus.textContent = 'Ingresa WABA ID y Access Token primero.';
            waAccountStatus.style.color = 'var(--error)';
          }
          return;
        }

        if (waAccountStatus) {
          waAccountStatus.textContent = 'Cargando números y plantillas...';
          waAccountStatus.style.color = '';
        }
        waLoadAccountBtn.disabled = true;

        try {
          // Según la documentación de Meta:
          // GET /{WABA_ID}/phone_numbers
          // GET /{WABA_ID}/message_templates
          const [phones, templates] = await Promise.all([
            // Documentado en Cloud API: GET /{WABA_ID}/phone_numbers
            waFetchMeta(encodeURIComponent(waba) + '/phone_numbers', token),
            // GET /{WABA_ID}/message_templates?fields=name,language,category,status&limit=1000
            waFetchMeta(
              encodeURIComponent(waba) +
                '/message_templates?fields=name,language,category,status&limit=1000',
              token
            ),
          ]);

          // Rellenar Phone Number ID select
          if (waPhoneNumberId && waPhoneNumberId.tagName === 'SELECT') {
            waPhoneNumberId.innerHTML = '<option value=\"\">Selecciona un número disponible...</option>';
            const list = Array.isArray(phones.data) ? phones.data : [];
            list.forEach((p) => {
              const opt = document.createElement('option');
              opt.value = p.id;
              const num = p.display_phone_number || p.verified_name || p.id;
              const name = p.verified_name ? ` — ${p.verified_name}` : '';
              opt.textContent = `${num}${name}`;
              waPhoneNumberId.appendChild(opt);
            });
          }

          // Rellenar selector de plantillas
          if (waTemplatePicker && waTemplatePicker.tagName === 'SELECT') {
            waTemplatePicker.innerHTML = '<option value=\"\">— Selecciona una plantilla —</option>';
            const list = Array.isArray(templates.data) ? templates.data : [];
            list.forEach((t) => {
              const opt = document.createElement('option');
              opt.value = t.name + '|' + t.language;
              const status = t.status || '';
              opt.textContent = `${t.name} (${t.language}, ${t.category || ''}${status ? ', ' + status : ''})`;
              waTemplatePicker.appendChild(opt);
            });
          }

          if (waAccountStatus) {
            const phonesCount = Array.isArray(phones.data) ? phones.data.length : 0;
            const templatesCount = Array.isArray(templates.data) ? templates.data.length : 0;
            waAccountStatus.textContent = `Cargados ${phonesCount} números y ${templatesCount} plantillas.`;
            waAccountStatus.style.color = 'var(--accent)';
          }
        } catch (e) {
          if (waAccountStatus) {
            waAccountStatus.textContent = 'Error al cargar datos: ' + e.message;
            waAccountStatus.style.color = 'var(--error)';
          }
        } finally {
          waLoadAccountBtn.disabled = false;
        }
      });
    }

    async function waLoadSelectedTemplateBody(name, lang) {
      if (!waWabaId || !waAccessToken || !name) return;
      const waba = waWabaId.value.trim();
      const token = waAccessToken.value.trim();
      if (!waba || !token) return;
      try {
        const path =
          encodeURIComponent(waba) +
          '/message_templates?name=' +
          encodeURIComponent(name) +
          (lang ? '&language=' + encodeURIComponent(lang) : '') +
          '&fields=name,language,category,status,components&limit=1';
        const data = await waFetchMeta(path, token);
        const list = Array.isArray(data.data) ? data.data : [];
        const tpl = list[0];
        if (!tpl) {
          return;
        }
        const bodyComp =
          (tpl.components || []).find((c) => c.type === 'BODY') || null;
        const buttonsComp =
          (tpl.components || []).find((c) => c.type === 'BUTTONS') || null;
        const text =
          (bodyComp && bodyComp.text) ||
          'Esta plantilla no tiene componente BODY definido.';

        // Volcar el BODY en el textarea principal para reutilizar la previsualización
        if (waTemplateBody) {
          waTemplateBody.value = text;
        }

        // Sincronizar los botones del template de Meta con los 3 slots de botones del builder
        const allMetaButtons =
          (buttonsComp && Array.isArray(buttonsComp.buttons)) ? buttonsComp.buttons : [];
        const btnTypes = document.querySelectorAll('.wa-btn-type');
        btnTypes.forEach((sel) => {
          const idxStr = sel.getAttribute('data-btn') || '0';
          const idx = parseInt(idxStr, 10) || 0;
          const textInp = document.querySelector('.wa-btn-text[data-btn=\"' + idx + '\"]');
          const urlInp = document.querySelector('.wa-btn-url[data-btn=\"' + idx + '\"]');
          const metaBtn = allMetaButtons[idx] || null;
          if (metaBtn) {
            sel.value = metaBtn.type || '';
            if (textInp) textInp.value = metaBtn.text || '';
            if (urlInp) urlInp.value = metaBtn.url || '';
          } else {
            sel.value = '';
            if (textInp) textInp.value = '';
            if (urlInp) urlInp.value = '';
          }
          // Disparar change para que se apliquen las clases/visibilidad y se actualice la preview
          sel.dispatchEvent(new Event('change'));
        });

        // Actualizar la burbuja de preview con el cuerpo recién cargado
        waUpdatePreview();
      } catch (e) {
        // Si falla la carga desde Meta, dejamos el estado tal cual estaba en el builder
        console.error('Error al cargar plantilla desde Meta:', e);
      }
    }

    if (waTemplatePicker) {
      waTemplatePicker.addEventListener('change', () => {
        const value = waTemplatePicker.value;
        if (!value) {
          return;
        }
        const [name, lang] = value.split('|');
        if (waTemplateName) waTemplateName.value = name;
        if (waTemplateLanguage) waTemplateLanguage.value = lang || 'es';
        waUpdatePreview();
        waLoadSelectedTemplateBody(name, lang || 'es');
      });
    }

    async function proxyEnsureClient() {
      if (proxySupabase) return proxySupabase;
      if (!window.supabase || !window.supabase.createClient) {
        throw new Error('Supabase JS no está disponible');
      }
      let url = proxySupabaseUrlInput && proxySupabaseUrlInput.value.trim();
      let key = proxySupabaseKeyInput && proxySupabaseKeyInput.value.trim();
      if ((!url || !key) && proxyEnvConfig) {
        url = proxyEnvConfig.supabaseUrl;
        key = proxyEnvConfig.supabaseAnonKey;
      }
      if (!url || !key) {
        throw new Error('Supabase URL y anon key son requeridos');
      }
      proxySupabase = window.supabase.createClient(url, key);
      return proxySupabase;
    }

    async function proxyLoadConfigs() {
      if (!proxyListContainer || !proxyListLoading || !proxyListEmpty) return;
      proxyListLoading.style.display = 'block';
      proxyListEmpty.style.display = 'none';
      proxyListContainer.innerHTML = '';
      try {
        const client = await proxyEnsureClient();
        const { data, error } = await client
          .from('url_configs')
          .select('*')
          .order('created_at', { ascending: false });
        if (error) throw error;
        const rows = data || [];
        if (!rows.length) {
          proxyListEmpty.style.display = 'block';
          return;
        }
        rows.forEach((config) => {
          const card = document.createElement('div');
          card.className = 'wa-card';
          const created = config.created_at ? new Date(config.created_at) : null;
          const dateStr = created
            ? created.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })
            : '';
          // Usar siempre la URL real de Supabase: si hay config de .env la usamos,
          // si no, tomamos lo que haya en el input.
          let supUrl = '';
          if (proxyEnvConfig && proxyEnvConfig.supabaseUrl) {
            supUrl = proxyEnvConfig.supabaseUrl;
          } else if (proxySupabaseUrlInput && proxySupabaseUrlInput.value.trim()) {
            supUrl = proxySupabaseUrlInput.value.trim();
          }
          const generatedUrl = supUrl
            ? `${supUrl}/functions/v1/redirect/${config.slug}`
            : `/functions/v1/redirect/${config.slug}`;
          card.innerHTML = `
            <div class="wa-fields" style="margin-bottom:0;">
              <div class="wa-field" style="margin-bottom:0.5rem;">
                <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:0.75rem;">
                  <div>
                    <div style="font-size:0.9rem;font-weight:600;">${config.name || '<span style="color:var(--muted);font-style:italic;">Unnamed</span>'}</div>
                    ${dateStr ? `<div style="font-size:0.7rem;color:var(--muted);margin-top:0.1rem;">${dateStr}</div>` : ''}
                  </div>
                  <span style="font-size:0.7rem;background:var(--bg);border:1px solid var(--border);border-radius:9999px;padding:0.15rem 0.6rem;">${config.slug}</span>
                </div>
              </div>
              <div class="wa-field">
                <label class="wa-label-small">Generated URL</label>
                <div style="display:flex;align-items:center;gap:0.5rem;">
                  <span style="font-size:0.8rem;color:#53bdeb;word-break:break-all;flex:1;">${generatedUrl}</span>
                  <button type="button" class="wa-btn-small" data-copy-url style="border-radius:8px;background:var(--border);color:var(--text);border:none;cursor:pointer;">
                    Copy
                  </button>
                </div>
              </div>
              <div class="wa-field proxy-redirect-field" data-config-id="${config.id}">
                <label class="wa-label-small">Redirects to</label>
                <div class="proxy-redirect-view" style="display:flex;align-items:center;gap:0.5rem;flex-wrap:wrap;">
                  <a href="${(config.redirect_url || '').replace(/"/g, '&quot;')}" target="_blank" rel="noopener noreferrer" style="font-size:0.8rem;color:var(--accent);text-decoration:none;word-break:break-all;flex:1;min-width:0;">${(config.redirect_url || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}</a>
                  <button type="button" class="wa-btn-small" data-proxy-edit-redirect style="flex-shrink:0;">Editar</button>
                </div>
                <div class="proxy-redirect-edit" style="display:none;">
                  <input type="url" class="wa-input proxy-redirect-input" style="font-size:0.8rem;width:100%;" placeholder="https://..." />
                  <div style="display:flex;gap:0.5rem;margin-top:0.35rem;">
                    <button type="button" class="wa-btn-small" data-proxy-save-redirect>Guardar</button>
                    <button type="button" class="wa-btn-small" data-proxy-cancel-redirect>Cancelar</button>
                  </div>
                </div>
              </div>
              <div class="wa-field">
                <label class="wa-label-small">POST webhook</label>
                <a href="${config.post_url}" target="_blank" rel="noopener noreferrer" style="font-size:0.8rem;color:#22c55e;text-decoration:none;word-break:break-all;">
                  ${config.post_url}
                </a>
              </div>
            </div>
          `;
          const copyBtn = card.querySelector('[data-copy-url]');
          if (copyBtn) {
            copyBtn.addEventListener('click', async () => {
              try {
                await navigator.clipboard.writeText(generatedUrl);
                copyBtn.textContent = 'Copied';
                setTimeout(() => {
                  copyBtn.textContent = 'Copy';
                }, 1500);
              } catch (_) {}
            });
          }

          const redirectField = card.querySelector('.proxy-redirect-field');
          const redirectView = card.querySelector('.proxy-redirect-view');
          const redirectEdit = card.querySelector('.proxy-redirect-edit');
          const redirectInput = card.querySelector('.proxy-redirect-input');
          const redirectLink = redirectView && redirectView.querySelector('a');
          const editBtn = card.querySelector('[data-proxy-edit-redirect]');
          const saveBtn = card.querySelector('[data-proxy-save-redirect]');
          const cancelBtn = card.querySelector('[data-proxy-cancel-redirect]');
          if (redirectField && redirectView && redirectEdit && redirectInput && redirectLink && editBtn && saveBtn && cancelBtn) {
            redirectInput.value = config.redirect_url || '';
            editBtn.addEventListener('click', () => {
              redirectView.style.display = 'none';
              redirectEdit.style.display = 'block';
              redirectInput.value = config.redirect_url || '';
              redirectInput.focus();
            });
            cancelBtn.addEventListener('click', () => {
              redirectEdit.style.display = 'none';
              redirectView.style.display = 'flex';
              redirectInput.value = config.redirect_url || '';
            });
            saveBtn.addEventListener('click', async () => {
              const newUrl = redirectInput.value.trim();
              if (!newUrl) return;
              try {
                const client = await proxyEnsureClient();
                const { error } = await client
                  .from('url_configs')
                  .update({ redirect_url: newUrl })
                  .eq('id', config.id);
                if (error) throw error;
                config.redirect_url = newUrl;
                redirectLink.href = newUrl;
                redirectLink.textContent = newUrl;
                redirectEdit.style.display = 'none';
                redirectView.style.display = 'flex';
              } catch (e) {
                alert('Error al guardar: ' + (e.message || e));
              }
            });
          }

          proxyListContainer.appendChild(card);
        });
      } catch (e) {
        if (proxyStatus) {
          proxyStatus.textContent = 'Error al cargar URLs: ' + e.message;
          proxyStatus.style.color = 'var(--error)';
        }
      } finally {
        proxyListLoading.style.display = 'none';
      }
    }

    if (proxyConnectBtn) {
      proxyConnectBtn.addEventListener('click', async () => {
        if (proxyStatus) {
          proxyStatus.textContent = 'Conectando a Supabase y cargando URLs...';
          proxyStatus.style.color = '';
        }
        proxyConnectBtn.disabled = true;
        try {
          await proxyEnsureClient();
          await proxyLoadConfigs();
          if (proxyStatus) {
            proxyStatus.textContent = 'Conectado. URLs cargadas.';
            proxyStatus.style.color = 'var(--accent)';
          }
        } catch (e) {
          if (proxyStatus) {
            proxyStatus.textContent = e.message;
            proxyStatus.style.color = 'var(--error)';
          }
        } finally {
          proxyConnectBtn.disabled = false;
        }
      });
    }

    if (proxyCreateForm) {
      proxyCreateForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (proxyError) {
          proxyError.textContent = '';
          proxyError.style.color = '';
        }
        const redirectUrl = proxyRedirectUrlInput && proxyRedirectUrlInput.value.trim();
        const postUrl = proxyPostUrlInput && proxyPostUrlInput.value.trim();
        const name = proxyLabelInput && proxyLabelInput.value.trim();
        if (!redirectUrl || !postUrl) {
          if (proxyError) {
            proxyError.textContent = 'Ambas URLs son obligatorias.';
            proxyError.style.color = 'var(--error)';
          }
          return;
        }
        try {
          const client = await proxyEnsureClient();
          const slug = proxyGenerateSlug();
          const { data, error } = await client
            .from('url_configs')
            .insert({
              slug,
              name: name || '',
              redirect_url: redirectUrl,
              post_url: postUrl,
            })
            .select()
            .single();
          if (error) throw error;
          if (proxyLabelInput) proxyLabelInput.value = '';
          if (proxyRedirectUrlInput) proxyRedirectUrlInput.value = '';
          if (proxyPostUrlInput) proxyPostUrlInput.value = '';
          if (proxyStatus) {
            proxyStatus.textContent = 'Proxy URL creada correctamente.';
            proxyStatus.style.color = 'var(--accent)';
          }
          await proxyLoadConfigs();
        } catch (e) {
          if (proxyError) {
            proxyError.textContent = 'Error al crear Proxy URL: ' + e.message;
            proxyError.style.color = 'var(--error)';
          }
        }
      });
    }

    // Intentar cargar config de Supabase desde .env (backend) al cargar la página
    (async () => {
      try {
        const res = await fetch('/api/proxy/config');
        if (!res.ok) {
          if (proxyStatus) {
            proxyStatus.textContent = 'Supabase no está configurado en .env. Completa los campos manualmente.';
            proxyStatus.style.color = 'var(--error)';
          }
          return;
        }
        const data = await res.json();
        if (!data.supabaseUrl || !data.supabaseAnonKey) return;
        proxyEnvConfig = data;
        // Ocultar por completo el bloque de credenciales y auto-conectar/cargar URLs
        if (proxyCredsCard) {
          proxyCredsCard.style.display = 'none';
        }
        await proxyEnsureClient();
        await proxyLoadConfigs();
      } catch (_) {
        // Silencioso: si falla, el usuario puede introducir manualmente
      }
    })();

    // Enviar mensaje usando una plantilla existente (Cloud API /{PHONE_NUMBER_ID}/messages)
    if (waSendTemplateBtn) {
      waSendTemplateBtn.addEventListener('click', async () => {
        const token = waAccessToken && waAccessToken.value.trim();
        const phoneNumberId = waPhoneNumberId && waPhoneNumberId.value.trim();
        const toRaw = waSendTo && waSendTo.value.trim();
        const templateName = waTemplateName && waTemplateName.value.trim();
        const languageCode = (waTemplateLanguage && waTemplateLanguage.value) || 'es';

        if (!token || !phoneNumberId) {
          waSendResult.textContent = 'Debes ingresar Access Token y Phone Number ID.';
          waSendResult.style.color = 'var(--error)';
          return;
        }
        if (!toRaw) {
          waSendResult.textContent = 'Debes ingresar el número de destino.';
          waSendResult.style.color = 'var(--error)';
          return;
        }
        if (!templateName) {
          waSendResult.textContent = 'Debes indicar el nombre de la plantilla (arriba).';
          waSendResult.style.color = 'var(--error)';
          return;
        }

        // Normalizar destino: si no empieza con +, se lo añadimos
        const to = toRaw.startsWith('+') ? toRaw : `+${toRaw.replace(/\\s+/g, '')}`;

        const body = {
          messaging_product: 'whatsapp',
          to,
          type: 'template',
          template: {
            name: templateName,
            language: { code: languageCode },
          },
        };

        waSendTemplateBtn.disabled = true;
        waSendResult.textContent = 'Enviando mensaje...';
        waSendResult.style.color = '';

        try {
          const res = await fetch(META_GRAPH + '/' + encodeURIComponent(phoneNumberId) + '/messages', {
            method: 'POST',
            headers: {
              'Authorization': 'Bearer ' + token,
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(body),
          });
          const data = await res.json();

          // Según la documentación de Meta, una respuesta exitosa incluye un array "messages" con un ID.
          if (res.ok && data.messages && Array.isArray(data.messages) && data.messages[0]?.id) {
            waSendResult.textContent = 'Mensaje enviado. ID: ' + data.messages[0].id;
            waSendResult.style.color = 'var(--accent)';
          } else {
            waSendResult.textContent = (data.error && data.error.message) || JSON.stringify(data);
            waSendResult.style.color = 'var(--error)';
          }
        } catch (e) {
          waSendResult.textContent = 'Error al enviar mensaje: ' + e.message;
          waSendResult.style.color = 'var(--error)';
        } finally {
          waSendTemplateBtn.disabled = false;
        }
      });
    }

    // ===== SECCIÓN DE GESTIÓN DE NÚMEROS =====
    const manageApiKey = document.getElementById('manageApiKey');
    const showApiKey = document.getElementById('showApiKey');
    const loadNumbersBtn = document.getElementById('loadNumbersBtn');
    const numbersList = document.getElementById('numbersList');
    const numbersTable = document.getElementById('numbersTable');
    const manageMsg = document.getElementById('manageMsg');
    const searchNumbersInput = document.getElementById('searchNumbers');
    
    // Variable para almacenar todos los números (sin filtrar)
    let allPhoneNumbers = [];
    let currentApiKey = '';

    // Toggle para mostrar/ocultar API Key
    if (showApiKey) {
      showApiKey.addEventListener('change', (e) => {
        manageApiKey.type = e.target.checked ? 'text' : 'password';
      });
    }

    // Permitir buscar con Enter en el campo de API Key
    if (manageApiKey) {
      manageApiKey.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          // Solo ejecutar si el botón no está deshabilitado
          if (!loadNumbersBtn.disabled) {
            loadNumbersBtn.click();
          }
        }
      });
    }

    loadNumbersBtn.addEventListener('click', async () => {
      const apiKey = manageApiKey.value.trim();
      if (!apiKey) {
        manageMsg.textContent = 'Error: Debes ingresar tu API Key';
        manageMsg.className = 'msg error';
        return;
      }

      loadNumbersBtn.disabled = true;
      loadNumbersBtn.textContent = 'Cargando...';
      manageMsg.textContent = '';
      numbersList.style.display = 'none';

      try {
        const response = await fetch(API + '/api/retell/list?apiKey=' + encodeURIComponent(apiKey));
        const result = await response.json();

        if (!result.success) {
          throw new Error(result.error || 'Error al cargar números');
        }

        const phoneNumbers = result.phoneNumbers || [];
        
        // Guardar los números originales y la API key para el filtrado
        allPhoneNumbers = phoneNumbers;
        currentApiKey = apiKey;
        
        // Limpiar el campo de búsqueda
        searchNumbersInput.value = '';
        
        // Debug: ver qué campos tiene el primer número
        if (phoneNumbers.length > 0) {
          console.log('Ejemplo de número recibido:', phoneNumbers[0]);
          console.log('Campos disponibles:', Object.keys(phoneNumbers[0]));
        }
        
        // Renderizar la tabla con todos los números
        renderPhoneNumbersTable(phoneNumbers);
        
        if (phoneNumbers.length === 0) {
          manageMsg.textContent = 'No hay números importados en Retell AI';
          manageMsg.className = 'msg';
          numbersList.style.display = 'block';
        } else {
          numbersList.style.display = 'block';
          manageMsg.textContent = `Se encontraron ${phoneNumbers.length} número(s)`;
          manageMsg.className = 'msg ok';
        }
      } catch (error) {
        manageMsg.textContent = error.message || 'Error al cargar números';
        manageMsg.className = 'msg error';
      } finally {
        loadNumbersBtn.disabled = false;
        loadNumbersBtn.textContent = 'Cargar Números';
      }
    });

    // Función para renderizar la tabla de números
    function renderPhoneNumbersTable(phoneNumbers) {
      if (phoneNumbers.length === 0) {
        numbersTable.innerHTML = '<p style="color: var(--muted); text-align: center; padding: 2rem;">No hay números para mostrar</p>';
        return;
      }

      let tableHTML = '<table><thead><tr><th style="width: 30%;">Número</th><th style="width: 25%;">Nickname</th><th style="width: 35%;">Agent ID</th><th style="width: 10%; text-align: center;">Acción</th></tr></thead><tbody>';
      
      phoneNumbers.forEach((phone, index) => {
        const nickname = phone.nickname || '-';
        const agentId = phone.outbound_agent_id || '-';
        // El ID puede venir como phone_number_id, _id o id. Si no existe, usamos el phone_number directamente
        const phoneNumberId = phone.phone_number_id || phone._id || phone.id || phone.phone_number;
        
        // Debug para el primer número
        if (index === 0) {
          console.log('=== DEBUG: Estructura del primer número ===');
          console.log('Objeto completo:', phone);
          console.log('phone_number_id:', phone.phone_number_id);
          console.log('_id:', phone._id);
          console.log('id:', phone.id);
          console.log('phone_number:', phone.phone_number);
          console.log('Todos los campos:', Object.keys(phone));
          console.log('ID que se usará:', phoneNumberId);
        }
        
        // Escapar comillas simples y dobles para evitar problemas en el HTML
        const safePhoneNumberId = phoneNumberId ? String(phoneNumberId).replace(/'/g, "\\'").replace(/"/g, '&quot;') : '';
        const safeApiKey = String(currentApiKey).replace(/'/g, "\\'").replace(/"/g, '&quot;');
        const safePhoneNumber = String(phone.phone_number || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
        
        tableHTML += `
          <tr>
            <td><strong>${phone.phone_number}</strong></td>
            <td>${nickname}</td>
            <td style="font-size: 0.85rem; color: var(--muted); word-break: break-all;">${agentId}</td>
            <td style="text-align: center;">
              <button class="btn-small delete-btn" data-phone="${safePhoneNumber}" onclick="deletePhoneNumber('${safePhoneNumberId}', '${safeApiKey}', '${safePhoneNumber}', this)" title="Eliminar ${safePhoneNumber}">
                Eliminar
              </button>
            </td>
          </tr>
        `;
      });
      
      tableHTML += '</tbody></table>';
      numbersTable.innerHTML = tableHTML;
    }

    // Función para filtrar números telefónicos
    function filterPhoneNumbers(searchTerm) {
      if (!searchTerm || searchTerm.trim() === '') {
        // Si no hay término de búsqueda, mostrar todos
        renderPhoneNumbersTable(allPhoneNumbers);
        manageMsg.textContent = `Se encontraron ${allPhoneNumbers.length} número(s)`;
        manageMsg.className = 'msg ok';
        return;
      }

      const searchLower = searchTerm.trim().toLowerCase();
      
      // Filtrar números que coincidan en número telefónico o nickname
      const filtered = allPhoneNumbers.filter(phone => {
        // Buscar en el número telefónico (normalizado, sin + y espacios)
        const normalizedPhone = (phone.phone_number || '').replace(/\+/g, '').replace(/\s/g, '').toLowerCase();
        const phoneMatches = normalizedPhone.includes(searchLower.replace(/\+/g, '').replace(/\s/g, ''));
        
        // Buscar en el nickname (case-insensitive)
        const nickname = (phone.nickname || '').toLowerCase();
        const nicknameMatches = nickname.includes(searchLower);
        
        // Retornar true si coincide en número o nickname
        return phoneMatches || nicknameMatches;
      });

      // Renderizar la tabla con los números filtrados
      renderPhoneNumbersTable(filtered);
      
      if (filtered.length === 0) {
        manageMsg.textContent = `No se encontraron números que coincidan con "${searchTerm}"`;
        manageMsg.className = 'msg';
      } else {
        manageMsg.textContent = `Se encontraron ${filtered.length} número(s) de ${allPhoneNumbers.length} total`;
        manageMsg.className = 'msg ok';
      }
    }

    // Event listener para el campo de búsqueda
    if (searchNumbersInput) {
      searchNumbersInput.addEventListener('input', (e) => {
        const searchTerm = e.target.value;
        filterPhoneNumbers(searchTerm);
      });
    }

    // Función para mostrar modal de confirmación personalizado
    function showDeleteConfirmModal(phoneNumber) {
      return new Promise((resolve) => {
        const modal = document.getElementById('deleteConfirmModal');
        const phoneNumberText = document.getElementById('deletePhoneNumberText');
        const dontShowAgainCheckbox = document.getElementById('dontShowAgain');
        const confirmBtn = document.getElementById('confirmDeleteBtn');
        const cancelBtn = document.getElementById('cancelDeleteBtn');
        const closeBtn = document.getElementById('closeDeleteModal');

        // Verificar si el usuario ya marcó "No mostrar más"
        const skipConfirmation = localStorage.getItem('skipDeleteConfirmation') === 'true';
        if (skipConfirmation) {
          resolve(true);
          return;
        }

        // Configurar el texto del número
        phoneNumberText.textContent = phoneNumber;

        // Mostrar el modal
        modal.classList.add('active');

        // Función para cerrar el modal
        const closeModal = () => {
          modal.classList.remove('active');
        };

        // Función para confirmar
        const handleConfirm = () => {
          const dontShowAgain = dontShowAgainCheckbox.checked;
          if (dontShowAgain) {
            localStorage.setItem('skipDeleteConfirmation', 'true');
          }
          closeModal();
          resolve(true);
        };

        // Función para cancelar
        const handleCancel = () => {
          closeModal();
          resolve(false);
        };

        // Limpiar listeners anteriores y agregar nuevos
        confirmBtn.onclick = handleConfirm;
        cancelBtn.onclick = handleCancel;
        closeBtn.onclick = handleCancel;
        
        // Cerrar al hacer clic fuera del modal
        modal.onclick = (e) => {
          if (e.target === modal) {
            handleCancel();
          }
        };

        // Cerrar con Escape
        const handleEscape = (e) => {
          if (e.key === 'Escape' && modal.classList.contains('active')) {
            handleCancel();
            document.removeEventListener('keydown', handleEscape);
          }
        };
        document.addEventListener('keydown', handleEscape);
      });
    }

    // Función global para eliminar números
    window.deletePhoneNumber = async function(phoneNumberId, apiKey, phoneNumber, buttonElement) {
      console.log('deletePhoneNumber llamado con:', { phoneNumberId, phoneNumber, apiKey: apiKey ? 'presente' : 'faltante' });
      
      // Si phoneNumberId está vacío o es inválido, usar phoneNumber directamente
      let identifier = phoneNumberId;
      if (!identifier || identifier === 'undefined' || identifier === 'null' || (typeof identifier === 'string' && identifier.trim() === '')) {
        console.warn('PhoneNumberId inválido, usando phoneNumber directamente:', phoneNumber);
        identifier = phoneNumber;
      }
      
      // Validar que tengamos al menos un identificador
      if (!identifier || identifier.trim() === '') {
        manageMsg.textContent = 'Error: No se puede identificar el número a eliminar.';
        manageMsg.className = 'msg error';
        console.error('No hay identificador válido:', { phoneNumberId, phoneNumber });
        return;
      }

      // Obtener el botón si no se pasó como parámetro
      let btn = buttonElement;
      if (!btn) {
        // Intentar encontrar el botón por el atributo data-phone
        btn = document.querySelector(`button.delete-btn[data-phone="${phoneNumber}"]`);
      }
      
      // Si aún no tenemos el botón, intentar usar event.target como fallback
      if (!btn && typeof event !== 'undefined' && event.target) {
        btn = event.target;
      }

      // Mostrar modal de confirmación personalizado
      const confirmed = await showDeleteConfirmModal(phoneNumber);
      if (!confirmed) {
        // Si se canceló, asegurarse de que el botón esté en estado normal
        if (btn) {
          btn.disabled = false;
          btn.textContent = 'Eliminar';
        }
        return;
      }

      // Actualizar el estado del botón solo si existe
      if (btn) {
        btn.disabled = true;
        btn.textContent = 'Eliminando...';
      }

      try {
        // Usar encodeURIComponent para asegurar que el identificador se pase correctamente
        const response = await fetch(API + '/api/retell/delete/' + encodeURIComponent(identifier), {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ apiKey, phoneNumber }),
        });

        const result = await response.json();

        if (result.success) {
          manageMsg.textContent = `Número ${phoneNumber} eliminado exitosamente`;
          manageMsg.className = 'msg ok';
          // Recargar la lista (esto recreará todos los botones)
          setTimeout(() => {
            loadNumbersBtn.click();
          }, 1000);
        } else {
          manageMsg.textContent = result.error || 'Error al eliminar número';
          manageMsg.className = 'msg error';
          if (btn) {
            btn.disabled = false;
            btn.textContent = 'Eliminar';
          }
        }
      } catch (error) {
        manageMsg.textContent = error.message || 'Error al eliminar número';
        manageMsg.className = 'msg error';
        if (btn) {
          btn.disabled = false;
          btn.textContent = 'Eliminar';
        }
      }
    };

    // ===== SECCIÓN DE COMPARAR LISTAS / JSON (CLIENTE) =====
    (function setupCompareSection() {
      if (!compareSection) return;

      const compareFile1 = document.getElementById('compareFile1');
      const compareFile2 = document.getElementById('compareFile2');
      const compareZone1 = document.getElementById('compareZone1');
      const compareZone2 = document.getElementById('compareZone2');
      const compareFile1Name = document.getElementById('compareFile1Name');
      const compareFile2Name = document.getElementById('compareFile2Name');
      const compareFile1Info = document.getElementById('compareFile1Info');
      const compareFile2Info = document.getElementById('compareFile2Info');
      const compareModeCompare = document.getElementById('compareModeCompare');
      const compareModeDuplicates = document.getElementById('compareModeDuplicates');
      const compareModeSplit = document.getElementById('compareModeSplit');
      const compareModeNoLlama = document.getElementById('compareModeNoLlama');
      const compareModeJson = document.getElementById('compareModeJson');
      const compareCsvContainer = document.getElementById('compareCsvContainer');
      const compareSecondListContainer = document.getElementById('compareSecondListContainer');
      const splitOptions = document.getElementById('splitOptions');
      const splitPartsInput = document.getElementById('splitParts');
      const compareJsonContainer = document.getElementById('compareJsonContainer');
      const compareActionBtn = document.getElementById('compareActionBtn');
      const compareResultsContainer = document.getElementById('compareResultsContainer');
      const compareResultsTitle = document.getElementById('compareResultsTitle');
      const compareSummaryText = document.getElementById('compareSummaryText');
      const compareTableWrapper = document.getElementById('compareTableWrapper');
      const compareDownloadBtn = document.getElementById('compareDownloadBtn');
      const jsonFileInput = document.getElementById('jsonFileInput');
      const jsonZone = document.getElementById('jsonZone');
      const jsonFileName = document.getElementById('jsonFileName');
      const jsonFileInfo = document.getElementById('jsonFileInfo');
      const jsonConvertBtn = document.getElementById('jsonConvertBtn');
      const jsonErrorMsg = document.getElementById('jsonErrorMsg');

      let compareMode = 'compare'; // 'compare' | 'duplicates' | 'split' | 'json' | 'no-llama'
      let list1 = [];
      let list2 = [];
      let resultData = [];
      let jsonData = null;
      let splitPartsData = [];

      function setCompareMode(mode) {
        compareMode = mode;

        compareModeCompare.classList.remove('active');
        compareModeDuplicates.classList.remove('active');
        if (compareModeSplit) compareModeSplit.classList.remove('active');
        if (compareModeNoLlama) compareModeNoLlama.classList.remove('active');
        compareModeJson.classList.remove('active');

        if (mode === 'compare') {
          compareModeCompare.classList.add('active');
          compareCsvContainer.style.display = 'block';
          compareSecondListContainer.style.display = 'block';
          compareJsonContainer.style.display = 'none';
          if (splitOptions) splitOptions.style.display = 'none';
          compareActionBtn.textContent = 'Comparar Listas';
        } else if (mode === 'duplicates') {
          compareModeDuplicates.classList.add('active');
          compareCsvContainer.style.display = 'block';
          compareSecondListContainer.style.display = 'none';
          compareJsonContainer.style.display = 'none';
          if (splitOptions) splitOptions.style.display = 'none';
          compareActionBtn.textContent = 'Buscar duplicados en CSV';
        } else if (mode === 'split') {
          if (compareModeSplit) compareModeSplit.classList.add('active');
          compareCsvContainer.style.display = 'block';
          compareSecondListContainer.style.display = 'none';
          compareJsonContainer.style.display = 'none';
          if (splitOptions) splitOptions.style.display = 'block';
          compareActionBtn.textContent = 'Dividir lista';
        } else if (mode === 'no-llama') {
          if (compareModeNoLlama) compareModeNoLlama.classList.add('active');
          compareCsvContainer.style.display = 'block';
          compareSecondListContainer.style.display = 'block';
          compareJsonContainer.style.display = 'none';
          if (splitOptions) splitOptions.style.display = 'block';
          compareActionBtn.textContent = 'Borrar No Llama';
        } else if (mode === 'json') {
          compareModeJson.classList.add('active');
          compareCsvContainer.style.display = 'none';
          compareJsonContainer.style.display = 'block';
          compareResultsContainer.style.display = 'none';
          if (splitOptions) splitOptions.style.display = 'none';
        }
      }

      if (compareModeCompare) {
        compareModeCompare.addEventListener('click', () => setCompareMode('compare'));
      }
      if (compareModeDuplicates) {
        compareModeDuplicates.addEventListener('click', () => setCompareMode('duplicates'));
      }
      if (compareModeSplit) {
        compareModeSplit.addEventListener('click', () => setCompareMode('split'));
      }
      if (compareModeNoLlama) {
        compareModeNoLlama.addEventListener('click', () => setCompareMode('no-llama'));
      }
      if (compareModeJson) {
        compareModeJson.addEventListener('click', () => setCompareMode('json'));
      }

      setCompareMode('compare');

      function normalizeCsvCell(value) {
        let v = value != null ? String(value).trim() : '';
        // Si viene en formato CSV clásico con comillas externas, las quitamos
        // y desescapamos comillas dobles internas.
        if (v.length >= 2 && v.startsWith('"') && v.endsWith('"')) {
          v = v.slice(1, -1).replace(/""/g, '"');
        }
        return v;
      }

      function parseCsvFileToObjects(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = (event) => {
            try {
              const text = String(event.target.result || '');
              const lines = text.split(/\r?\n/).filter((l) => l.trim());
              if (!lines.length) {
                resolve([]);
                return;
              }
              const header = lines[0].split(',').map((h) => normalizeCsvCell(h));
              const rows = [];
              for (let i = 1; i < lines.length; i++) {
                const cols = lines[i].split(',');
                if (!cols.some((c) => c.trim())) continue;
                const obj = {};
                header.forEach((h, idx) => {
                  obj[h] = normalizeCsvCell(cols[idx] || '');
                });
                rows.push(obj);
              }
              resolve(rows);
            } catch (err) {
              reject(err);
            }
          };
          reader.onerror = () => reject(new Error('Error leyendo archivo'));
          reader.readAsText(file);
        });
      }

      function getPhoneKey(obj) {
        const keys = Object.keys(obj || {});
        const match = keys.find((k) =>
          /^phone[\s_]?number$/i.test(k) ||
          /^telefono$/i.test(k) ||
          /^tel$/i.test(k) ||
          /^phone$/i.test(k)
        );
        return match || keys[0] || null;
      }

      function toCsv(objects) {
        if (!objects || !objects.length) return '';
        const allKeys = new Set();
        objects.forEach((o) => Object.keys(o).forEach((k) => allKeys.add(k)));
        const headers = Array.from(allKeys);
        const rows = [headers.join(',')];
        for (const o of objects) {
          const cols = headers.map((h) => {
            let v = o[h] != null ? String(o[h]) : '';
            if (v.includes('"') || v.includes(',') || v.includes('\n')) {
              v = '"' + v.replace(/"/g, '""') + '"';
            }
            return v;
          });
          rows.push(cols.join(','));
        }
        return rows.join('\n');
      }

      function downloadCsv(content, filename) {
        const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      function renderTable(data) {
        if (!data || !data.length) {
          compareTableWrapper.innerHTML = '<p style="color: var(--muted); text-align: center; padding: 1rem;">No hay filas para mostrar.</p>';
          return;
        }
        const allKeys = new Set();
        data.forEach((o) => Object.keys(o).forEach((k) => allKeys.add(k)));
        const headers = Array.from(allKeys);
        let html = '<table><thead><tr>';
        headers.forEach((h) => {
          html += `<th>${h}</th>`;
        });
        html += '</tr></thead><tbody>';
        data.forEach((row) => {
          html += '<tr>';
          headers.forEach((h) => {
            const v = row[h] != null ? String(row[h]) : '';
            html += `<td>${v}</td>`;
          });
          html += '</tr>';
        });
        html += '</tbody></table>';
        compareTableWrapper.innerHTML = html;
      }

      async function handleCompareFile1(file) {
        compareFile1Info.textContent = 'Leyendo...';
        if (compareFile1Name) compareFile1Name.textContent = file.name || '';
        try {
          list1 = await parseCsvFileToObjects(file);
          compareFile1Info.textContent = `${file.name} — ${list1.length} filas`;
        } catch (err) {
          compareFile1Info.textContent = 'Error al leer CSV';
        }
      }

      async function handleCompareFile2(file) {
        compareFile2Info.textContent = 'Leyendo...';
        if (compareFile2Name) compareFile2Name.textContent = file.name || '';
        try {
          list2 = await parseCsvFileToObjects(file);
          compareFile2Info.textContent = `${file.name} — ${list2.length} filas`;
        } catch (err) {
          compareFile2Info.textContent = 'Error al leer CSV';
        }
      }

      if (compareFile1) {
        compareFile1.addEventListener('change', async (e) => {
          const file = e.target.files && e.target.files[0];
          if (!file) return;
          await handleCompareFile1(file);
        });
      }

      if (compareFile2) {
        compareFile2.addEventListener('change', async (e) => {
          const file = e.target.files && e.target.files[0];
          if (!file) return;
          await handleCompareFile2(file);
        });
      }

      function setupDropZone(zoneEl, inputEl, onFile) {
        if (!zoneEl || !inputEl) return;
        zoneEl.addEventListener('click', () => inputEl.click());
        zoneEl.addEventListener('dragover', (e) => {
          e.preventDefault();
          zoneEl.classList.add('dragover');
        });
        zoneEl.addEventListener('dragleave', () => {
          zoneEl.classList.remove('dragover');
        });
        zoneEl.addEventListener('drop', (e) => {
          e.preventDefault();
          zoneEl.classList.remove('dragover');
          const f = e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0];
          if (!f) return;
          onFile(f);
        });
      }

      setupDropZone(compareZone1, compareFile1, (file) => {
        if (!/\.csv$/i.test(file.name)) return;
        handleCompareFile1(file);
      });

      setupDropZone(compareZone2, compareFile2, (file) => {
        if (!/\.csv$/i.test(file.name)) return;
        handleCompareFile2(file);
      });

      if (compareActionBtn) {
        compareActionBtn.addEventListener('click', () => {
          if (compareMode === 'compare') {
            if (!list1.length || !list2.length) {
              alert('Debes cargar dos CSV primero.');
              return;
            }
            const phoneKey1 = getPhoneKey(list1[0]);
            const phoneKey2 = getPhoneKey(list2[0]);
            const set2 = new Set(list2.map((r) => String(r[phoneKey2] || '').trim()).filter(Boolean));
            const unique = list1.filter((r) => {
              const v = String(r[phoneKey1] || '').trim();
              return v && !set2.has(v);
            });
            resultData = unique;
            compareResultsTitle.textContent = 'Registros únicos del primer CSV (no presentes en el segundo)';
            compareSummaryText.textContent = `Primer CSV: ${list1.length} filas. Segundo CSV: ${list2.length} filas. Únicos en el primero: ${unique.length}.`;
            renderTable(unique);
            compareResultsContainer.style.display = 'block';
            compareDownloadBtn.disabled = !unique.length;
          } else if (compareMode === 'duplicates') {
            if (!list1.length) {
              alert('Debes cargar un CSV primero.');
              return;
            }
            const phoneKey = getPhoneKey(list1[0]);
            const seen = new Set();
            const unique = [];
            const duplicates = [];
            list1.forEach((r) => {
              const v = String(r[phoneKey] || '').trim();
              if (!v) return;
              if (seen.has(v)) {
                duplicates.push(r);
              } else {
                seen.add(v);
                unique.push(r);
              }
            });
            resultData = unique;
            compareResultsTitle.textContent = 'Registros deduplicados por número';
            compareSummaryText.textContent = `Filas originales: ${list1.length}. Únicos: ${unique.length}. Duplicados: ${duplicates.length}.`;
            renderTable(unique);
            compareResultsContainer.style.display = 'block';
            compareDownloadBtn.disabled = !unique.length;
          } else if (compareMode === 'no-llama') {
            if (!list1.length || !list2.length) {
              alert('Debes cargar dos CSV primero.');
              return;
            }
            const phoneKey1 = getPhoneKey(list1[0]);
            const phoneKey2 = getPhoneKey(list2[0]);
            const baseTotal = list1.length;
            const noLlamaTotal = list2.length;
            const noLlamaSet = new Set(
              list2
                .map((r) => String(r[phoneKey2] || '').trim())
                .filter(Boolean)
            );

            const allowed = list1.filter((r) => {
              const v = String(r[phoneKey1] || '').trim();
              return v && !noLlamaSet.has(v);
            });

            const removed = baseTotal - allowed.length;

            let parts = null;
            let partsCount = 0;
            if (splitPartsInput && splitPartsInput.value) {
              partsCount = parseInt(splitPartsInput.value, 10);
            }

            if (partsCount && partsCount > 1) {
              if (partsCount > allowed.length) {
                alert('No puedes crear más partes que registros resultantes. Reduce el número de partes.');
                return;
              }
              const total = allowed.length;
              const baseSize = Math.floor(total / partsCount);
              const remainder = total % partsCount;
              parts = [];
              let start = 0;
              for (let i = 0; i < partsCount; i++) {
                const size = baseSize + (i < remainder ? 1 : 0);
                const end = start + size;
                parts.push(allowed.slice(start, end));
                start = end;
              }
            }

            if (parts && parts.length) {
              splitPartsData = parts;
              resultData = allowed;
              compareResultsTitle.textContent = 'Lista limpia dividida (sin números No Llama)';
              compareSummaryText.textContent = `CSV base: ${baseTotal} filas. Lista No Llama: ${noLlamaTotal} filas. Eliminados: ${removed}. Restantes: ${allowed.length}. Partes generadas: ${parts.length}.`;
              renderTable(parts[0] || []);
              compareResultsContainer.style.display = 'block';
              compareDownloadBtn.disabled = false;
            } else {
              splitPartsData = [];
              resultData = allowed;
              compareResultsTitle.textContent = 'Lista limpia (sin números No Llama)';
              compareSummaryText.textContent = `CSV base: ${baseTotal} filas. Lista No Llama: ${noLlamaTotal} filas. Eliminados: ${removed}. Restantes: ${allowed.length}.`;
              renderTable(allowed);
              compareResultsContainer.style.display = 'block';
              compareDownloadBtn.disabled = !allowed.length;
            }
          } else if (compareMode === 'split') {
            if (!list1.length) {
              alert('Debes cargar un CSV primero.');
              return;
            }
            const partsCount = parseInt(splitPartsInput && splitPartsInput.value ? splitPartsInput.value : '2', 10);
            if (!partsCount || partsCount < 2) {
              alert('El número de partes debe ser al menos 2.');
              return;
            }
            if (partsCount > list1.length) {
              alert('No puedes crear más partes que registros. Reduce el número de partes.');
              return;
            }

            const total = list1.length;
            const baseSize = Math.floor(total / partsCount);
            const remainder = total % partsCount;
            const parts = [];
            let start = 0;
            for (let i = 0; i < partsCount; i++) {
              const size = baseSize + (i < remainder ? 1 : 0);
              const end = start + size;
              parts.push(list1.slice(start, end));
              start = end;
            }

            compareResultsTitle.textContent = 'División de lista';
            compareSummaryText.textContent = `Total registros: ${total}. Partes generadas: ${partsCount}. Usa \"Descargar CSV de resultados\" para bajar todas las partes.`;
            // Mostrar la primera parte como vista previa en la tabla
            renderTable(parts[0] || []);
            compareResultsContainer.style.display = 'block';
            splitPartsData = parts;
            compareDownloadBtn.disabled = parts.length === 0;
          }
        });
      }

      if (compareDownloadBtn) {
        compareDownloadBtn.addEventListener('click', () => {
          if (compareMode === 'split' || (compareMode === 'no-llama' && splitPartsData && splitPartsData.length)) {
            if (!splitPartsData || !splitPartsData.length) return;
            splitPartsData.forEach((part, idx) => {
              if (!part.length) return;
              const csv = toCsv(part);
              const filename =
                compareMode === 'split'
                  ? `split_part_${idx + 1}_of_${splitPartsData.length}.csv`
                  : `no_llama_part_${idx + 1}_of_${splitPartsData.length}.csv`;
              downloadCsv(csv, filename);
            });
          } else {
            if (!resultData || !resultData.length) return;
            const csv = toCsv(resultData);
            let filename = 'resultados.csv';
            if (compareMode === 'compare') {
              filename = 'registros_unicos.csv';
            } else if (compareMode === 'duplicates') {
              filename = 'registros_deduplicados.csv';
            } else if (compareMode === 'no-llama') {
              filename = 'lista_sin_no_llama.csv';
            }
            downloadCsv(csv, filename);
          }
        });
      }

      function handleJsonFile(file) {
        if (!file) return;
        jsonFileInfo.textContent = 'Leyendo JSON...';
        if (jsonFileName) jsonFileName.textContent = file.name || '';
        jsonErrorMsg.textContent = '';
        jsonErrorMsg.className = '';
        const reader = new FileReader();
        reader.onload = (ev) => {
          try {
            const text = String(ev.target.result || '');
            jsonData = JSON.parse(text);
            const rows = Array.isArray(jsonData) ? jsonData.length : 1;
            jsonFileInfo.textContent = `${file.name} — ${rows} registro(s)`;
            jsonConvertBtn.disabled = false;
          } catch (err) {
            jsonData = null;
            jsonFileInfo.textContent = '';
            jsonConvertBtn.disabled = true;
            jsonErrorMsg.textContent = 'Formato JSON inválido.';
            jsonErrorMsg.className = 'msg error';
          }
        };
        reader.onerror = () => {
          jsonData = null;
          jsonFileInfo.textContent = '';
          jsonConvertBtn.disabled = true;
          jsonErrorMsg.textContent = 'Error al leer el archivo JSON.';
          jsonErrorMsg.className = 'msg error';
        };
        reader.readAsText(file);
      }

      if (jsonFileInput) {
        jsonFileInput.addEventListener('change', (e) => {
          const file = e.target.files && e.target.files[0];
          if (!file) return;
          handleJsonFile(file);
        });
      }

      if (jsonZone && jsonFileInput) {
        setupDropZone(jsonZone, jsonFileInput, (file) => {
          if (!/\.json$/i.test(file.name)) return;
          handleJsonFile(file);
        });
      }

      if (jsonConvertBtn) {
        jsonConvertBtn.addEventListener('click', () => {
          if (!jsonData) return;
          try {
            const arr = Array.isArray(jsonData) ? jsonData : [jsonData];
            const csv = toCsv(arr);
            downloadCsv(csv, 'convertido_desde_json.csv');
            jsonErrorMsg.textContent = 'Conversión completada. Se descargó el CSV.';
            jsonErrorMsg.className = 'msg ok';
          } catch (err) {
            jsonErrorMsg.textContent = 'Error al convertir JSON a CSV.';
            jsonErrorMsg.className = 'msg error';
          }
        });
      }
    })();
  </script>
</body>
</html>
